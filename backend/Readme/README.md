# Backend API ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°
Studio Core çš„åç«¯ API æœåŠ¡ï¼Œè´Ÿè´£æ¥æ”¶å‰ç«¯è¯·æ±‚ã€ç®¡ç†ä»»åŠ¡é˜Ÿåˆ—å’ŒçŠ¶æ€è·Ÿè¸ªã€‚

## å·²å®ç°çš„åŠŸèƒ½

### âœ… Day 2 ä»»åŠ¡å®Œæˆæƒ…å†µ
- [x] å®‰è£…å¹¶é…ç½®ä¾èµ–ï¼ˆFlask, Redis, CORS, Requestsï¼‰
- [x] åˆ›å»ºå®Œæ•´çš„ app.py éª¨æ¶ç»“æ„
- [x] é…ç½® CORS ä»¥æ”¯æŒè·¨åŸŸè¯·æ±‚
- [x] å®ç° POST /api/generate ç«¯ç‚¹ï¼ˆä»»åŠ¡æäº¤ï¼‰
- [x] å®ç° GET /api/status/<job_id> ç«¯ç‚¹ï¼ˆçŠ¶æ€æŸ¥è¯¢ï¼‰
- [x] å®ç°æ—¥å¿—ç³»ç»Ÿï¼ˆæ–‡ä»¶+æ§åˆ¶å°ï¼‰
- [x] åˆ›å»ºæµ‹è¯•è„šæœ¬

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```powershell
cd backend
pip install -r requirements.txt
```

### 2. å¯åŠ¨ Redis
```powershell
docker run -d -p 6379:6379 --name redis redis:latest
```

### 3. å¯åŠ¨ Backend API
```powershell
python src/app.py
```

æœåŠ¡å°†åœ¨ `http://localhost:5000` å¯åŠ¨ã€‚

### 4. è¿è¡Œæµ‹è¯•
```powershell
python test_api.py
```

## API ç«¯ç‚¹

### 1. å¥åº·æ£€æŸ¥
```http
GET /health
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "status": "ok",
  "redis": "healthy"
}
```

### 2. æäº¤ç”Ÿæˆä»»åŠ¡
```http
POST /api/generate
Content-Type: application/json

{
  "prompt": "a cyberpunk cat in neon city",
  "seed": 12345,
  "workflow": "sdxl"
}
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "queued"
}
```

**çŠ¶æ€ç :**
- `202` - ä»»åŠ¡å·²æ¥å—
- `400` - è¯·æ±‚å‚æ•°é”™è¯¯ï¼ˆå¦‚ prompt ä¸ºç©ºï¼‰
- `503` - Redis æœåŠ¡ä¸å¯ç”¨

### 3. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
```http
GET /api/status/550e8400-e29b-41d4-a716-446655440000
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "queued",
  "progress": 0,
  "image_url": "",
  "error": ""
}
```

**çŠ¶æ€å€¼:**
- `queued` - å·²å…¥é˜Ÿï¼Œç­‰å¾…å¤„ç†
- `processing` - æ­£åœ¨å¤„ç†
- `finished` - å·²å®Œæˆ
- `failed` - å¤±è´¥

**çŠ¶æ€ç :**
- `200` - æˆåŠŸ
- `404` - ä»»åŠ¡ä¸å­˜åœ¨

## æ¶æ„è¯´æ˜

### Redis æ•°æ®ç»“æ„

1. **ä»»åŠ¡é˜Ÿåˆ—** (`job_queue`)
   - ç±»å‹: List
   - ç”¨é€”: å­˜å‚¨å¾…å¤„ç†çš„ä»»åŠ¡
   - æ•°æ®æ ¼å¼:
     ```json
     {
       "job_id": "uuid",
       "prompt": "æ–‡æœ¬æè¿°",
       "seed": 12345,
       "workflow": "sdxl",
       "created_at": "2025-12-29T10:00:00"
     }
     ```

2. **ä»»åŠ¡çŠ¶æ€** (`job:status:<job_id>`)
   - ç±»å‹: Hash
   - ç”¨é€”: è·Ÿè¸ªä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
   - å­—æ®µ:
     - `job_id`: ä»»åŠ¡ID
     - `status`: çŠ¶æ€ï¼ˆqueued/processing/finished/failedï¼‰
     - `progress`: è¿›åº¦ï¼ˆ0-100ï¼‰
     - `image_url`: ç”Ÿæˆçš„å›¾ç‰‡è·¯å¾„
     - `error`: é”™è¯¯ä¿¡æ¯
     - `updated_at`: æ›´æ–°æ—¶é—´
   - TTL: 24å°æ—¶

### æ—¥å¿—ç³»ç»Ÿ
- æ—¥å¿—æ–‡ä»¶: `backend.log`
- æ—¥å¿—çº§åˆ«: INFO
- è¾“å‡º: æ–‡ä»¶ + æ§åˆ¶å°
- ç¼–ç : UTF-8

## ç¯å¢ƒå˜é‡

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| REDIS_HOST | redis | Redis ä¸»æœºåœ°å€ |
| REDIS_PORT | 6379 | Redis ç«¯å£ |

## æµ‹è¯•

æµ‹è¯•è„šæœ¬ `test_api.py` åŒ…å«ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š

1. âœ“ å¥åº·æ£€æŸ¥
2. âœ“ åˆ›å»ºä»»åŠ¡
3. âœ“ æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
4. âœ“ è¾“å…¥éªŒè¯ï¼ˆç©º promptï¼‰
5. âœ“ 404 å¤„ç†ï¼ˆä¸å­˜åœ¨çš„ä»»åŠ¡ï¼‰

è¿è¡Œæµ‹è¯•ï¼š
```powershell
python test_api.py
```

é¢„æœŸè¾“å‡ºï¼š
```
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Backend API å·¥ä½œæ­£å¸¸ã€‚
```

## ä¸‹ä¸€æ­¥è®¡åˆ’ï¼ˆDay 3ï¼‰

- [ ] å®ç° Worker æœåŠ¡
- [ ] å¯¹æ¥ ComfyUI API
- [ ] å®ç°ä»»åŠ¡è¿›åº¦æ›´æ–°
- [ ] å®Œæˆç«¯åˆ°ç«¯æµ‹è¯•

## æ•…éšœæ’æŸ¥

### Redis è¿æ¥å¤±è´¥
```
âœ— Redis è¿æ¥å¤±è´¥: Error 10061 connecting to localhost:6379
```
**è§£å†³æ–¹æ¡ˆ:** æ£€æŸ¥ Redis æ˜¯å¦è¿è¡Œ
```powershell
docker ps | findstr redis
```

### ç«¯å£è¢«å ç”¨
```
OSError: [WinError 10048] é€šå¸¸æ¯ä¸ªå¥—æ¥å­—åœ°å€åªå…è®¸ä½¿ç”¨ä¸€æ¬¡
```
**è§£å†³æ–¹æ¡ˆ:** æ›´æ”¹ç«¯å£æˆ–å…³é—­å ç”¨ 5000 ç«¯å£çš„ç¨‹åº
```powershell
netstat -ano | findstr :5000
```

## æŠ€æœ¯æ ˆ

- **Web æ¡†æ¶**: Flask 2.1.2
- **ç¼“å­˜/é˜Ÿåˆ—**: Redis 4.5.1
- **è·¨åŸŸ**: Flask-CORS 3.0.10
- **HTTP å®¢æˆ·ç«¯**: Requests 2.28.1
- **æ—¥å¿—**: Python logging æ¨¡å—

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥é˜… `openspec/AGENTS.md` æˆ–æäº¤ Issueã€‚
