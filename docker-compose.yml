version: '3.8'

services:
  # =========================================
  # 1. ComfyUI Engine (Linux 核心引擎)
  # =========================================
  comfyui:
    # 使用 Pytorch 官方映像檔 (CUDA 12.1)
    image: pytorch/pytorch:2.3.0-cuda12.1-cudnn8-runtime
    container_name: studio-engine
    restart: always
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    # [關鍵] 啟動指令：必須有 --listen 0.0.0.0 才能讓 Worker 連進來
    command: python main.py --listen 0.0.0.0 --port 8188 --preview-method auto
    
    # 關鍵路徑掛載
    volumes:
      # A. 程式碼：掛載你 WSL 下載的 ComfyUI 資料夾
      - ./ComfyUI:/app
      
      # B. 模型：掛載 Windows 的模型資料夾
      # (確保這條路徑與你的 extra_model_paths.yaml 內的 base_path 對應)
      - ${WSL_MODEL_PATH:-/mnt/d/02_software/ComfyUI_windows_portable/ComfyUI/models}:/windows_models
      
      # C. 設定檔：掛載模型路徑設定
      - ./extra_model_paths.yaml:/app/extra_model_paths.yaml
      
      # D. 輸入/輸出共享：與 Worker 共用 storage 資料夾
      - ./storage/outputs:/app/output
      - ./storage/inputs:/app/input

    ports:
      - "8188:8188" # 開放給本機瀏覽器預覽
    networks:
      - studio-net
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - CLI_ARGS=--listen 0.0.0.0

  # =========================================
  # 2. Redis 服務
  # =========================================
  redis:
    image: redis:7.2
    container_name: studio-redis
    ports:
      - "6379:6379"
    command: redis-server --requirepass mysecret --appendonly yes
    volumes:
      - ./redis_data:/data
    restart: always
    networks:
      - studio-net

  # =========================================
  # 3. MySQL 資料庫服務
  # =========================================
  mysql:
    image: mysql:8.0
    container_name: studio-mysql
    ports:
      - "3307:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=studio_db
      - MYSQL_USER=studio_user
      - MYSQL_PASSWORD=studio_password
    volumes:
      - ./mysql_data:/var/lib/mysql
    restart: always
    networks:
      - studio-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =========================================
  # 4. Backend API 服務
  # =========================================
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: studio-backend
    ports:
      - "5000:5000"
    environment:
      # 指向 Service Name
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=mysecret
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5000
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=studio_user
      - DB_PASSWORD=studio_password
      - DB_NAME=studio_db
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    restart: always
    networks:
      - studio-net
    working_dir: /app
    volumes:
      - ./storage/outputs:/app/storage/outputs
      - ./logs:/app/logs

  # =========================================
  # 5. Worker 服務
  # =========================================
  worker:
    build:
      context: .
      dockerfile: worker/Dockerfile
    container_name: studio-worker
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=mysecret
      
      # [修改點] 這裡改為使用 container_name "studio-engine" 確保連線
      - COMFY_HOST=studio-engine
      - COMFY_PORT=8188
      
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=studio_user
      - DB_PASSWORD=studio_password
      - DB_NAME=studio_db
      
      # 指定輸入路徑
      - COMFYUI_INPUT_DIR=/worker/storage/inputs
      
    depends_on:
      - redis
      - mysql
      - comfyui
    restart: always
    networks:
      - studio-net
    volumes:
      - ./storage:/worker/storage
      - ./logs:/worker/logs
      # [確認] 這裡掛載你的工作流資料夾
      - ./ComfyUIworkflow:/app/ComfyUIworkflow

networks:
  studio-net:
    driver: bridge