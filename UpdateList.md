# æ›´æ–°æ—¥èªŒ (Update List)

---

## ğŸ“… 2026-01-02: Phase 3 - Data & Intelligence å®Œæˆ

### ğŸ¯ ä»Šæ—¥å®Œæˆäº‹é … (Phase 3 å…¨éƒ¨å®Œæˆ)

| æ¨¡çµ„ | åŠŸèƒ½ | ç‹€æ…‹ |
|------|------|------|
| **Database** | MySQL 8.0 è³‡æ–™åº«å»ºç½® | âœ… å®Œæˆ |
| **Database** | Jobs è¡¨ Schema è¨­è¨ˆ | âœ… å®Œæˆ |
| **Backend** | è³‡æ–™åº«é€£æ¥æ± æ•´åˆ | âœ… å®Œæˆ |
| **Backend** | `GET /api/history` æ­·å²è¨˜éŒ„ API | âœ… å®Œæˆ |
| **Backend** | ä»»å‹™ç‹€æ…‹åŒæ­¥åˆ°è³‡æ–™åº« | âœ… å®Œæˆ |
| **Frontend** | Personal Gallery é é¢ | âœ… å®Œæˆ |
| **Frontend** | Remix åŠŸèƒ½ï¼ˆé‡æ–°ä½¿ç”¨åƒæ•¸ï¼‰ | âœ… å®Œæˆ |
| **Worker** | è³‡æ–™åº«åŒæ­¥æ¸…ç†ï¼ˆSoft Deleteï¼‰ | âœ… å®Œæˆ |
| **Worker** | ComfyUI éŒ¯èª¤é‡è©¦æ©Ÿåˆ¶ | âœ… å®Œæˆ |
| **Docker** | MySQL æœå‹™æ•´åˆ | âœ… å®Œæˆ |
| **Docker** | Backend Healthcheck | âœ… å®Œæˆ |
| **Docker** | é¡åƒå¤§å°å„ªåŒ– | âœ… å®Œæˆ |

### ğŸ—„ï¸ æ–°å¢è³‡æ–™åº«æ¶æ§‹

#### Jobs è¡¨çµæ§‹
```sql
CREATE TABLE jobs (
    id VARCHAR(36) PRIMARY KEY,              -- Job UUID
    prompt TEXT,                             -- æç¤ºè©
    workflow VARCHAR(50),                    -- å·¥ä½œæµé¡å‹
    model VARCHAR(100),                      -- ä½¿ç”¨æ¨¡å‹
    aspect_ratio VARCHAR(10),                -- åœ–ç‰‡æ¯”ä¾‹
    batch_size INT DEFAULT 1,                -- æ‰¹æ¬¡æ•¸é‡
    seed INT DEFAULT -1,                     -- éš¨æ©Ÿç¨®å­
    status VARCHAR(20),                      -- ç‹€æ…‹ (queued, processing, finished, failed)
    output_path TEXT,                        -- è¼¸å‡ºè·¯å¾‘ (å¤šå¼µç”¨é€—è™Ÿåˆ†éš”)
    created_at TIMESTAMP DEFAULT NOW,        -- å»ºç«‹æ™‚é–“
    updated_at TIMESTAMP ON UPDATE NOW,      -- æ›´æ–°æ™‚é–“
    is_deleted BOOLEAN DEFAULT FALSE,        -- è»Ÿåˆªé™¤æ¨™è¨˜
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_is_deleted (is_deleted)
);
```

### ğŸ†• æ–°å¢ API ç«¯é»

| æ–¹æ³• | ç«¯é» | åŠŸèƒ½ | åƒæ•¸ |
|------|------|------|------|
| GET | `/api/history` | ç²å–æ­·å²è¨˜éŒ„ | `limit` (é è¨­ 50), `offset` (é è¨­ 0) |
| GET | `/health` | å¥åº·æª¢æŸ¥ï¼ˆå¼·åŒ–ç‰ˆï¼‰ | - (å›å‚³ Redis + MySQL ç‹€æ…‹) |

### ğŸ¨ æ–°å¢å‰ç«¯åŠŸèƒ½

#### Personal Gallery
- **éŸ¿æ‡‰å¼ç¶²æ ¼ä½ˆå±€**: 1-4 æ¬„è‡ªé©æ‡‰é¡¯ç¤º
- **å¡ç‰‡è³‡è¨Š**: ç¸®åœ–ã€æç¤ºè©ã€å·¥ä½œæµé¡å‹ã€æ—¥æœŸã€ç‹€æ…‹
- **åœ–ç‰‡æ•¸é‡æ¨™è¨˜**: æ‰¹æ¬¡ç”Ÿæˆæ™‚é¡¯ç¤ºåœ–ç‰‡æ•¸
- **ç‹€æ…‹é¡è‰²ç·¨ç¢¼**: 
  - âœ… Finished (ç¶ è‰²)
  - âŒ Failed (ç´…è‰²)
  - â³ Processing (é»ƒè‰²)
  - ğŸ“‹ Queued (è—è‰²)
  - ğŸš« Cancelled (ç°è‰²)

#### Remix åŠŸèƒ½
é»æ“Šæ­·å²è¨˜éŒ„çš„ "Remix" æŒ‰éˆ•ï¼š
1. è‡ªå‹•è·³è½‰åˆ° Image Composition å·¥ä½œå€
2. é¸æ“‡å°æ‡‰çš„å·¥ä½œæµå·¥å…·
3. å¡«å……åŸå§‹åƒæ•¸ï¼ˆPromptã€Seedã€Modelã€Aspect Ratioï¼‰
4. å…è¨±å¿«é€Ÿä¿®æ”¹ä¸¦é‡æ–°ç”Ÿæˆ

### ğŸ”§ ç³»çµ±éŸŒæ€§å¼·åŒ–

#### Worker è‡ªå‹•ç¶­è­·
- **å•Ÿå‹•æ™‚æ¸…ç†**: åˆªé™¤éæœŸæª”æ¡ˆä¸¦åŒæ­¥è³‡æ–™åº«
- **å®šæœŸæ¸…ç†**: æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
- **è»Ÿåˆªé™¤æ©Ÿåˆ¶**: åˆªé™¤æª”æ¡ˆæ™‚æ¨™è¨˜è³‡æ–™åº« `is_deleted = TRUE`ï¼Œä¿ç•™æ­·å²è¨˜éŒ„

#### éŒ¯èª¤é‡è©¦æ©Ÿåˆ¶
- **ComfyUI é€£æ¥é‡è©¦**: å¤±æ•—æ™‚ç­‰å¾… 5 ç§’å¾Œé‡è©¦ 1 æ¬¡
- **Redis æ–·ç·šé‡é€£**: è‡ªå‹•é‡é€£ä¸¦ç¹¼çºŒè™•ç†ä½‡åˆ—

### ğŸ³ Docker å„ªåŒ–

#### MySQL æœå‹™
- **ç‰ˆæœ¬**: MySQL 8.0
- **ç«¯å£**: 3306 (æœ¬åœ° DBeaver å¯é€£æ¥)
- **æŒä¹…åŒ–**: `./mysql_data:/var/lib/mysql`
- **Healthcheck**: ç¢ºä¿è³‡æ–™åº«å°±ç·’å¾Œæ‰å•Ÿå‹• Backend

#### é¡åƒå„ªåŒ–
- **Python ç‰ˆæœ¬**: å‡ç´šåˆ° 3.10-slim
- **Pip å„ªåŒ–**: `--no-cache-dir` æ¸›å°‘é¡åƒå¤§å°
- **Backend Healthcheck**: æ¯ 30 ç§’æª¢æŸ¥ `/health` ç«¯é»

### ğŸ“¦ ä¾è³´æ›´æ–°

#### Backend
```txt
+ mysql-connector-python==8.2.0
```

### ğŸ”„ è³‡æ–™æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser â”‚â”€â”€â”€â”€â–¶â”‚  Backend â”‚â”€â”€â”€â”€â–¶â”‚   MySQL  â”‚
â”‚          â”‚     â”‚   API    â”‚     â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–²                â”‚                 â–²
     â”‚                â–¼                 â”‚
     â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚          â”‚  Redis   â”‚            â”‚
     â”‚          â”‚  Queue   â”‚            â”‚
     â”‚          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚               â”‚                  â”‚
     â”‚               â–¼                  â”‚
     â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       Soft Delete
     â”‚          â”‚  Worker  â”‚            â”‚
     â”‚          â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚
     â”‚               â–¼
     â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ ComfyUI  â”‚
                â”‚          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“ ç’°å¢ƒè®Šæ•¸æ›´æ–°

#### .env æ–°å¢é…ç½®
```ini
# MySQL Database Configuration
DB_HOST=localhost
DB_PORT=3306
DB_USER=studio_user
DB_PASSWORD=studio_password
DB_NAME=studio_db
```

### ğŸ§ª æ¸¬è©¦é©—è­‰æ­¥é©Ÿ

1. **å•Ÿå‹•å®Œæ•´å †ç–Š**
   ```bash
   docker-compose up -d
   ```

2. **æª¢æŸ¥å¥åº·ç‹€æ…‹**
   ```bash
   curl http://localhost:5000/health
   # æ‡‰å›å‚³: {"status":"ok","redis":"healthy","mysql":"healthy"}
   ```

3. **ç”Ÿæˆæ¸¬è©¦åœ–ç‰‡**
   - æäº¤ä»»å‹™ä¸¦ç¢ºèªè³‡æ–™åº«æœ‰è¨˜éŒ„

4. **è¨ªå• Personal Gallery**
   - ç¢ºèªèƒ½çœ‹åˆ°æ­·å²è¨˜éŒ„
   - æ¸¬è©¦ Remix åŠŸèƒ½

5. **æ¸¬è©¦æ¸…ç†æ©Ÿåˆ¶**
   - ä¿®æ”¹æª”æ¡ˆæ™‚é–“æˆ³æ¨¡æ“¬éæœŸæª”æ¡ˆ
   - é‡å•Ÿ Worker ç¢ºèªè‡ªå‹•æ¸…ç†

### ğŸš€ éƒ¨ç½²æé†’

1. **è³‡æ–™åº«åˆå§‹åŒ–**: é¦–æ¬¡å•Ÿå‹•æ™‚ Backend æœƒè‡ªå‹•å»ºç«‹ `jobs` è¡¨
2. **è³‡æ–™æŒä¹…åŒ–**: ç¢ºä¿ `./mysql_data` ç›®éŒ„æœ‰å¯«å…¥æ¬Šé™
3. **æœ¬åœ°é–‹ç™¼**: Backend å’Œ Worker éœ€è¦æ‰‹å‹•è¨­å®š `DB_HOST=localhost`
4. **Docker ç’°å¢ƒ**: è‡ªå‹•ä½¿ç”¨ `DB_HOST=mysql` é€éå…§éƒ¨ç¶²è·¯é€£æ¥

---

## ğŸ“… 2024-12-31: ä»Šæ—¥ç¸½çµèˆ‡ä¸‹é€±å±•æœ›

### ğŸ¯ ä»Šæ—¥å®Œæˆäº‹é … (Phase 2 å…¨éƒ¨å®Œæˆ)

| æ¨¡çµ„ | åŠŸèƒ½ | ç‹€æ…‹ |
|------|------|------|
| **UX** | å³æ™‚é€²åº¦æ¢ | âœ… å®Œæˆ |
| **API** | å‹•æ…‹æ¨¡å‹åˆ—è¡¨ `GET /api/models` | âœ… å®Œæˆ |
| **API** | ä»»å‹™å–æ¶ˆ `POST /api/cancel/{job_id}` | âœ… å®Œæˆ |
| **UI** | å‹•æ…‹æ¨¡å‹ä¸‹æ‹‰é¸å–® | âœ… å®Œæˆ |
| **UI** | æ‰¹æ¬¡åœ–ç‰‡ç¶²æ ¼é¡¯ç¤º | âœ… å®Œæˆ |
| **Docker** | Backend + Worker å®¹å™¨åŒ– | âœ… å®Œæˆ |
| **Docker** | docker-compose å®Œæ•´ç·¨æ’ | âœ… å®Œæˆ |
| **Worker** | åœ–ç‰‡è‡ªå‹•æ¸…ç† (30å¤©) | âœ… å®Œæˆ |
| **Worker** | è¼¸å‡ºåœ–ç‰‡æ™ºèƒ½é¸æ“‡ | âœ… å®Œæˆ |
| **Config** | ComfyUI è·¯å¾‘ç’°å¢ƒè®Šæ•¸ | âœ… å®Œæˆ |

### ğŸ› ï¸ ä»Šæ—¥ä¿®å¾©çš„ Bug

1. **WebSocket è§£æéŒ¯èª¤** - `'NoneType' object has no attribute 'get'`
   - **åŸå› **: ComfyUI å›å‚³çš„ `data` æ¬„ä½ç‚º `null`
   - **ä¿®å¾©**: åœ¨ `comfy_client.py` æ·»åŠ é¡å‹æª¢æŸ¥

2. **è¼¸å‡ºåœ–ç‰‡æ‰¾ä¸åˆ°** - ComfyUI è¼¸å‡ºå¤šå¼µåœ–ç‰‡æ™‚è¤‡è£½å¤±æ•—
   - **åŸå› **: èˆŠä»£ç¢¼åªä¿ç•™æœ€å¾Œä¸€å¼µåœ–ç‰‡ä¿¡æ¯
   - **ä¿®å¾©**: æ”¶é›†æ‰€æœ‰åœ–ç‰‡ï¼Œå„ªå…ˆé¸æ“‡æœ‰ subfolder çš„æ­£å¼è¼¸å‡º

3. **ComfyUI è·¯å¾‘éŒ¯èª¤** - Worker æ‰¾ä¸åˆ°è¼¸å‡ºç›®éŒ„
   - **åŸå› **: é è¨­è·¯å¾‘å‡è¨­éŒ¯èª¤
   - **ä¿®å¾©**: æ›´æ–° `.env` é…ç½®æ­£ç¢ºçš„ ComfyUI è·¯å¾‘

### ğŸ§¹ ä»£ç¢¼æ¸…ç†

- âŒ åˆªé™¤ `backend/src/routes.py` (ç©ºæ–‡ä»¶)
- âŒ åˆªé™¤ `__pycache__/` ç›®éŒ„
- âŒ åˆªé™¤ `backend.log` æ—¥èªŒ
- âŒ åˆªé™¤ `restart_worker.ps1` (è‡¨æ™‚è…³æœ¬)
- âœ… æ›´æ–° `.gitignore` è¦å‰‡

### ğŸ“Š ç•¶å‰æ¶æ§‹

```
ComfyUISum/
â”œâ”€â”€ backend/                    # Flask API æœå‹™
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ app.py             # API ç«¯é» (generate, status, cancel, models)
â”‚       â””â”€â”€ config.py          # Backend é…ç½®
â”‚
â”œâ”€â”€ worker/                     # ä»»å‹™è™•ç†æœå‹™
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ main.py            # Worker ä¸»è¿´åœˆ
â”‚       â”œâ”€â”€ comfy_client.py    # ComfyUI API å®¢æˆ¶ç«¯
â”‚       â”œâ”€â”€ json_parser.py     # Workflow è§£æå™¨
â”‚       â”œâ”€â”€ config.py          # Worker é…ç½®
â”‚       â””â”€â”€ check_comfy_connection.py  # è¨ºæ–·å·¥å…·
â”‚
â”œâ”€â”€ frontend/                   # Web UI
â”‚   â”œâ”€â”€ index.html             # å–®é æ‡‰ç”¨
â”‚   â”œâ”€â”€ style.css
â”‚   â””â”€â”€ app.js
â”‚
â”œâ”€â”€ storage/                    # æœ¬åœ°å„²å­˜
â”‚   â”œâ”€â”€ inputs/                # æš«å­˜ä¸Šå‚³åœ–ç‰‡ (24h)
â”‚   â””â”€â”€ outputs/               # ç”Ÿæˆçµæœ (30å¤©)
â”‚
â”œâ”€â”€ docker-compose.yml          # å®¹å™¨ç·¨æ’
â”œâ”€â”€ .env                        # ç’°å¢ƒè®Šæ•¸
â”œâ”€â”€ DEPLOYMENT.md               # éƒ¨ç½²æŒ‡å—
â””â”€â”€ ARCHITECTURE.md             # æ¶æ§‹èªªæ˜
```

### ğŸ”Œ API ç«¯é»æ¸…å–®

| æ–¹æ³• | ç«¯é» | åŠŸèƒ½ |
|------|------|------|
| POST | `/api/generate` | æäº¤ç”Ÿæˆä»»å‹™ |
| GET | `/api/status/{job_id}` | æŸ¥è©¢ä»»å‹™ç‹€æ…‹ |
| POST | `/api/cancel/{job_id}` | å–æ¶ˆä»»å‹™ |
| GET | `/api/models` | ç²å–æ¨¡å‹åˆ—è¡¨ |
| GET | `/outputs/{filename}` | ç²å–ç”Ÿæˆåœ–ç‰‡ |
| GET | `/health` | å¥åº·æª¢æŸ¥ |

---

### ğŸ“‹ ä¸‹é€±å±•æœ› (Phase 3 è¦åŠƒ)

#### å„ªå…ˆç´š 1: ç©©å®šæ€§èˆ‡æ¸¬è©¦
- [ ] å®Œå–„å–®åœ–ç·¨è¼¯ (single_image_edit) å·¥ä½œæµæ¸¬è©¦
- [ ] ä¿®å¾©æ‰€æœ‰ Workflow é¡å‹çš„ç«¯åˆ°ç«¯æ¸¬è©¦
- [ ] æ·»åŠ éŒ¯èª¤é‡è©¦æ©Ÿåˆ¶ (ä»»å‹™å¤±æ•—è‡ªå‹•é‡è©¦ 1 æ¬¡)
- [ ] æ·»åŠ æ—¥èªŒè¨˜éŒ„åˆ°æ–‡ä»¶ (Worker + Backend)

#### å„ªå…ˆç´š 2: åŠŸèƒ½å¢å¼·
- [ ] æ­·å²è¨˜éŒ„åŠŸèƒ½ - ä¿å­˜æœ€è¿‘ 50 ç­†ç”Ÿæˆè¨˜éŒ„
- [ ] åœ–ç‰‡æ”¶è—åŠŸèƒ½ - æ¨™è¨˜å–œæ­¡çš„åœ–ç‰‡
- [ ] Prompt æ¨¡æ¿ - é è¨­é¢¨æ ¼æ¨¡æ¿é¸æ“‡
- [ ] é€²éšåƒæ•¸ - CFG Scale, Steps, Sampler é¸é …

#### å„ªå…ˆç´š 3: æ€§èƒ½å„ªåŒ–
- [ ] åœ–ç‰‡å£“ç¸® - ä¸Šå‚³å‰è‡ªå‹•å£“ç¸®å¤§åœ–
- [ ] çµæœå¿«å– - ç›¸åŒåƒæ•¸ç›´æ¥è¿”å›å¿«å–çµæœ
- [ ] ä½µç™¼æ§åˆ¶ - é™åˆ¶åŒæ™‚è™•ç†çš„ä»»å‹™æ•¸é‡

#### å„ªå…ˆç´š 4: éƒ¨ç½²å®Œå–„
- [ ] HTTPS æ”¯æ´ - ä½¿ç”¨ Nginx åå‘ä»£ç†
- [ ] ç”¨æˆ¶èªè­‰ - ç°¡æ˜“ API Key èªè­‰
- [ ] ç›£æ§é¢æ¿ - ä»»å‹™çµ±è¨ˆå’Œç³»çµ±ç‹€æ…‹

---

## 2024-12-31: Phase 2 - Step 4: ä»»å‹™ç®¡ç†èˆ‡ç¶­è­·

### æ¦‚è¿°
å¯¦ç¾ä»»å‹™å–æ¶ˆåŠŸèƒ½å’Œåœ–ç‰‡è‡ªå‹•æ¸…ç†æ©Ÿåˆ¶ï¼Œæå‡ç³»çµ±çš„å¯æ§æ€§å’Œç£ç¢Ÿç©ºé–“ç®¡ç†èƒ½åŠ›ã€‚

### è®Šæ›´å…§å®¹

#### 1. Backend API - `backend/src/app.py`
- **æ–°å¢ `POST /api/cancel/{job_id}` ç«¯é»**
  - æª¢æŸ¥ä»»å‹™æ˜¯å¦å­˜åœ¨
  - é©—è­‰ä»»å‹™ç‹€æ…‹ï¼ˆåªèƒ½å–æ¶ˆ `queued` æˆ– `processing` ç‹€æ…‹çš„ä»»å‹™ï¼‰
  - å°‡ä»»å‹™ç‹€æ…‹è¨­ç½®ç‚º `cancelled`
  - è¨­ç½®éŒ¯èª¤è¨Šæ¯ï¼š`Task cancelled by user`
  - å›æ‡‰æ ¼å¼ï¼š
    ```json
    {
      "success": true,
      "message": "Task cancelled"
    }
    ```

#### 2. Worker - `worker/src/comfy_client.py`
- **æ–°å¢ `interrupt()` æ–¹æ³•**
  - ç™¼é€ `POST /interrupt` è«‹æ±‚åˆ° ComfyUI
  - ä¸­æ–·ç•¶å‰åŸ·è¡Œçš„ä»»å‹™
  - è¿”å›å¸ƒçˆ¾å€¼è¡¨ç¤ºæ˜¯å¦æˆåŠŸ

#### 3. Worker - `worker/src/main.py`
- **`process_job()` å‡½æ•¸å¢å¼·**
  - åœ¨ `on_progress` å›èª¿ä¸­æª¢æŸ¥ä»»å‹™ç‹€æ…‹
  - å¦‚æœç‹€æ…‹è®Šç‚º `cancelled`ï¼Œç«‹å³èª¿ç”¨ `client.interrupt()`
  - æ‹‹å‡ºç•°å¸¸çµ‚æ­¢ä»»å‹™è™•ç†

- **æ–°å¢ `cleanup_old_output_files()` å‡½æ•¸**
  - æƒæ `storage/outputs` ç›®éŒ„
  - åˆªé™¤è¶…é 30 å¤©çš„åœ–ç‰‡æª”æ¡ˆ
  - è¨˜éŒ„åˆªé™¤æ•¸é‡å’Œé‡‹æ”¾ç©ºé–“

- **ä¸»å¾ªç’°å¢å¼·**
  - Worker å•Ÿå‹•æ™‚åŸ·è¡Œä¸€æ¬¡åœ–ç‰‡æ¸…ç†
  - æ¯å°æ™‚å®šæœŸåŸ·è¡Œåœ–ç‰‡æ¸…ç†ï¼ˆåŒ…æ‹¬æš«å­˜æª”æ¡ˆå’Œè¼¸å‡ºåœ–ç‰‡ï¼‰

### æŠ€è¡“ç´°ç¯€

#### ä»»å‹™å–æ¶ˆæµç¨‹
```
ç”¨æˆ¶è«‹æ±‚ â†’ POST /api/cancel/{job_id} â†’ 
Redis ç‹€æ…‹æ›´æ–°ç‚º 'cancelled' â†’ 
Worker æª¢æ¸¬åˆ°ç‹€æ…‹è®ŠåŒ– â†’ 
èª¿ç”¨ ComfyUI /interrupt â†’ 
ä»»å‹™çµ‚æ­¢
```

#### åœ–ç‰‡æ¸…ç†æµç¨‹
```
Worker å•Ÿå‹• â†’ cleanup_old_output_files() â†’ 
æ¯å°æ™‚è§¸ç™¼ â†’ åˆªé™¤è¶…é 30 å¤©çš„æª”æ¡ˆ â†’ 
è¨˜éŒ„æ¸…ç†çµ±è¨ˆ
```

### æ¸…ç†ç­–ç•¥
- **æš«å­˜æª”æ¡ˆ**ï¼ˆ`storage/inputs`ï¼‰: ä¿ç•™ 24 å°æ™‚
- **è¼¸å‡ºåœ–ç‰‡**ï¼ˆ`storage/outputs`ï¼‰: ä¿ç•™ 30 å¤©
- **æ¸…ç†é »ç‡**: æ¯å°æ™‚æª¢æŸ¥ä¸€æ¬¡

### é©—è­‰æ­¥é©Ÿ

#### æ¸¬è©¦ä»»å‹™å–æ¶ˆ
1. æäº¤ä¸€å€‹ç”Ÿæˆä»»å‹™
2. åœ¨è™•ç†éç¨‹ä¸­èª¿ç”¨ `POST /api/cancel/{job_id}`
3. ç¢ºèªä»»å‹™ç‹€æ…‹è®Šç‚º `cancelled`
4. ç¢ºèª ComfyUI æ”¶åˆ°ä¸­æ–·æŒ‡ä»¤

#### æ¸¬è©¦åœ–ç‰‡æ¸…ç†
1. åœ¨ `storage/outputs` æ”¾ç½®èˆŠæª”æ¡ˆï¼ˆä¿®æ”¹æ™‚é–“æˆ³ï¼‰
2. å•Ÿå‹• Worker
3. æª¢æŸ¥èˆŠæª”æ¡ˆæ˜¯å¦è¢«åˆªé™¤
4. æŸ¥çœ‹æ—¥èªŒç¢ºèªæ¸…ç†çµ±è¨ˆ

### ç›¸é—œæ–‡ä»¶
- [task.md](openspec/changes/phase-2-maturity/task.md) - Phase 2 ä»»å‹™æ¸…å–®

---

## 2024-12-31: Phase 2 - Step 3: Docker å®¹å™¨åŒ–éƒ¨ç½²

### æ¦‚è¿°
å®Œå–„ Docker å®¹å™¨åŒ–é…ç½®ï¼Œå¯¦ç¾ä¸€éµå•Ÿå‹•æ•´å€‹ç³»çµ±ï¼ˆRedisã€Backendã€Workerï¼‰ã€‚

### è®Šæ›´å…§å®¹

#### 1. Backend - `backend/Dockerfile`
- **åŸºç¤æ˜ åƒ**: Python 3.9 Slim
- **å·¥ä½œç›®éŒ„**: `/app`
- **è¤‡è£½æª”æ¡ˆ**: `requirements.txt` + `src/`
- **å•Ÿå‹•å‘½ä»¤**: `python src/app.py`

#### 2. Worker - `worker/Dockerfile`
- **åŸºç¤æ˜ åƒ**: Python 3.9 Slim
- **å·¥ä½œç›®éŒ„**: `/worker`
- **è¤‡è£½æª”æ¡ˆ**: `requirements.txt` + `src/`
- **å•Ÿå‹•å‘½ä»¤**: `python src/main.py`

#### 3. Docker Compose - `docker-compose.yml`
- **Redis æœå‹™**:
  - æ˜ åƒ: `redis:7.2`
  - ç«¯å£: `6379`
  - æŒä¹…åŒ–: `./redis_data:/data`
  - å¯†ç¢¼: `mysecret`
  
- **Backend æœå‹™**:
  - å»ºç½®: `./backend`
  - ç«¯å£: `5000:5000`
  - ç’°å¢ƒè®Šæ•¸: Redis é€£æ¥é…ç½®
  - Volume: `./storage/outputs`
  
- **Worker æœå‹™**:
  - å»ºç½®: `./worker`
  - ç’°å¢ƒè®Šæ•¸: Redis + ComfyUI é€£æ¥é…ç½®
  - Volume: `./storage`
  - ComfyUI é€£æ¥: `host.docker.internal:8188`

### ä½¿ç”¨æ–¹å¼

#### å•Ÿå‹•æ‰€æœ‰æœå‹™
```bash
docker-compose up -d
```

#### æŸ¥çœ‹æ—¥èªŒ
```bash
docker-compose logs -f backend
docker-compose logs -f worker
```

#### åœæ­¢æ‰€æœ‰æœå‹™
```bash
docker-compose down
```

### æ³¨æ„äº‹é …

1. **ComfyUI å¿…é ˆåœ¨å®¿ä¸»æ©Ÿé‹è¡Œ**
   - Worker é€é `host.docker.internal` é€£æ¥å®¿ä¸»æ©Ÿçš„ ComfyUI
   - ç¢ºä¿ ComfyUI å·²å•Ÿå‹•åœ¨ `http://127.0.0.1:8188`

2. **Volume æ›è¼‰**
   - `./storage/outputs`: ç”Ÿæˆçš„åœ–ç‰‡è¼¸å‡ºç›®éŒ„
   - `./redis_data`: Redis æŒä¹…åŒ–æ•¸æ“š

3. **ç’°å¢ƒè®Šæ•¸**
   - å¯é€é `.env` æª”æ¡ˆæˆ– `docker-compose.yml` è¦†å¯«
   - é‡è¦é…ç½®: `COMFY_HOST`, `REDIS_PASSWORD`

### ç›¸é—œæ–‡ä»¶
- [task.md](openspec/changes/phase-2-maturity/task.md) - Phase 2 ä»»å‹™æ¸…å–®

---

## 2024-12-31: Phase 2 - Step 2: å‹•æ…‹é…ç½®èˆ‡æ‰¹æ¬¡é¡¯ç¤º

### æ¦‚è¿°
å¯¦ç¾å‹•æ…‹æ¨¡å‹åˆ—è¡¨ç²å–å’Œæ‰¹æ¬¡åœ–ç‰‡ç¶²æ ¼é¡¯ç¤ºåŠŸèƒ½ï¼Œè®“å‰ç«¯èƒ½å¤ è‡ªå‹•æƒæ ComfyUI çš„æ¨¡å‹ç›®éŒ„ï¼Œä¸¦å„ªé›…åœ°å±•ç¤ºå¤šå¼µç”Ÿæˆåœ–ç‰‡ã€‚

### è®Šæ›´å…§å®¹

#### 1. Backend - `backend/src/config.py`
- **æ–°å¢ ComfyUI è·¯å¾‘é…ç½®**
  - `COMFYUI_ROOT`: ComfyUI å®‰è£æ ¹ç›®éŒ„
  - `COMFYUI_MODELS_DIR`: æ¨¡å‹ç¸½ç›®éŒ„
  - `COMFYUI_CHECKPOINTS_DIR`: Checkpoint æ¨¡å‹ç›®éŒ„
  - `COMFYUI_UNET_DIR`: UNET æ¨¡å‹ç›®éŒ„

#### 2. Backend API - `backend/src/app.py`
- **æ–°å¢ `GET /api/models` ç«¯é»**
  - æƒæ `checkpoints` ç›®éŒ„ï¼ŒæŸ¥æ‰¾ `.safetensors` å’Œ `.ckpt` æª”æ¡ˆ
  - æƒæ `unet` ç›®éŒ„ï¼ŒæŸ¥æ‰¾ `.safetensors`ã€`.ckpt`ã€`.pt` æª”æ¡ˆ
  - ä½¿ç”¨ç›¸å°è·¯å¾‘ï¼ˆæ”¯æ´å­ç›®éŒ„ï¼‰
  - éŒ¯èª¤è™•ç†ï¼šç›®éŒ„ä¸å­˜åœ¨æ™‚è¿”å›é è¨­æ¨¡å‹åˆ—è¡¨
  - å›æ‡‰æ ¼å¼ï¼š
    ```json
    {
      "models": ["model1.safetensors", "model2.ckpt"],
      "unet_models": ["z-image/z-image-turbo-fp8.safetensors"]
    }
    ```

#### 3. Frontend - `frontend/index.html`
- **å‹•æ…‹æ¨¡å‹è¼‰å…¥åŠŸèƒ½**
  - ç§»é™¤ç¡¬ç·¨ç¢¼çš„ `<option>` æ¨™ç±¤
  - æ–°å¢ `fetchModels()` å‡½æ•¸ï¼š
    - èª¿ç”¨ `GET /api/models` API
    - åˆ†çµ„é¡¯ç¤º UNET å’Œ Checkpoint æ¨¡å‹
    - éŒ¯èª¤è™•ç†ï¼šAPI å¤±æ•—æ™‚é¡¯ç¤ºé è¨­é¸é …
  - åœ¨ `DOMContentLoaded` æ™‚è‡ªå‹•èª¿ç”¨

- **æ‰¹æ¬¡åœ–ç‰‡ç¶²æ ¼é¡¯ç¤ºé©—è­‰**
  - `showResult()` å‡½æ•¸å·²æ­£ç¢ºå¯¦ç¾ï¼š
    - 1å¼µåœ–ï¼š`grid-cols-1` (å–®æ¬„ç½®ä¸­)
    - 2å¼µåœ–ï¼š`grid-cols-2` (é›™æ¬„)
    - 3-4å¼µåœ–ï¼š`grid-cols-2 grid-rows-2` (2x2 ç¶²æ ¼)
  - æ¯å¼µåœ–ç‰‡ç¨ç«‹çš„ä¸‹è¼‰æŒ‰éˆ•
  - éŸ¿æ‡‰å¼è¨­è¨ˆï¼Œæ”¯æ´ä¸åŒè¢å¹•å°ºå¯¸

### æŠ€è¡“ç´°ç¯€

#### æ¨¡å‹æƒææµç¨‹
```
ComfyUI/models/checkpoints â†’ Backend (éè¿´æƒæ) â†’ API â†’ Frontend (å‹•æ…‹å¡«å……ä¸‹æ‹‰é¸å–®)
ComfyUI/models/unet â†’ Backend (éè¿´æƒæ) â†’ API â†’ Frontend (å‹•æ…‹å¡«å……ä¸‹æ‹‰é¸å–®)
```

#### æ‰¹æ¬¡åœ–ç‰‡é¡¯ç¤ºé‚è¼¯
```javascript
// æ ¹æ“šåœ–ç‰‡æ•¸é‡å‹•æ…‹èª¿æ•´ Grid å¸ƒå±€
if (count === 1) {
    resultsGrid.className = 'grid-cols-1';
} else if (count === 2) {
    resultsGrid.className = 'grid-cols-2';
} else {
    resultsGrid.className = 'grid-cols-2 grid-rows-2';
}
```

### é©—è­‰æ­¥é©Ÿ
1. ç¢ºä¿ ComfyUI å·²å®‰è£æ¨¡å‹
2. å•Ÿå‹• Backend API
3. æ‰“é–‹å‰ç«¯é é¢
4. æª¢æŸ¥æ¨¡å‹ä¸‹æ‹‰é¸å–®æ˜¯å¦é¡¯ç¤ºå¯¦éš›æ¨¡å‹
5. è¨­å®š Batch Size > 1 æ¸¬è©¦å¤šåœ–é¡¯ç¤º

### ç›¸é—œæ–‡ä»¶
- [task.md](openspec/changes/phase-2-maturity/task.md) - Phase 2 ä»»å‹™æ¸…å–®

---

## 2024-12-31: Phase 2 - Step 1: å³æ™‚é€²åº¦æ¢å¯¦è£

### æ¦‚è¿°
å¯¦ç¾å³æ™‚é€²åº¦åé¥‹åŠŸèƒ½ï¼Œè®“ä½¿ç”¨è€…åœ¨ç”Ÿæˆåœ–ç‰‡æ™‚èƒ½çœ‹åˆ°å¯¦éš›é€²åº¦ç™¾åˆ†æ¯”ï¼Œè€Œéåªæœ‰éœæ…‹çš„ "Processing..." è¨Šæ¯ã€‚

### è®Šæ›´å…§å®¹

#### 1. Worker - `worker/src/comfy_client.py`
- **`wait_for_completion()` æ–¹æ³•å¢å¼·**
  - æ–°å¢ `on_progress` å›èª¿å‡½æ•¸åƒæ•¸
  - ç›£è½ ComfyUI WebSocket çš„ `progress` äº‹ä»¶
  - è§£æ `{'type': 'progress', 'data': {'value': X, 'max': Y}}` è¨Šæ¯
  - è¨ˆç®—é€²åº¦ç™¾åˆ†æ¯”ï¼š`int((value / max) * 100)`
  - é€éå›èª¿å‡½æ•¸é€šçŸ¥é€²åº¦æ›´æ–°

#### 2. Worker - `worker/src/main.py`
- **`process_job()` å‡½æ•¸é‡æ§‹**
  - ä¿®æ­£åŸ·è¡Œæµç¨‹ï¼š`queue_prompt()` â†’ `wait_for_completion()` â†’ `copy_output_image()`
  - æ–°å¢ `on_progress` å›èª¿å‡½æ•¸ï¼Œå°‡é€²åº¦æ˜ å°„åˆ° 30-95% å€é–“
  - ä¿®æ­£ä»»å‹™å®Œæˆç‹€æ…‹ç‚º `finished`ï¼ˆèˆ‡å‰ç«¯ä¸€è‡´ï¼‰
  - æ–°å¢è¼¸å‡ºåœ–ç‰‡è¤‡è£½é‚è¼¯

#### 3. Backend API - `backend/src/app.py`
- **`GET /api/status/<job_id>` ç«¯é»**
  - å·²æ­£ç¢ºå¯¦ç¾ï¼Œè¿”å› `progress` æ¬„ä½
  - å›æ‡‰æ ¼å¼ï¼š`{"status": "processing", "progress": 50, "image_url": "", "error": ""}`

#### 4. Frontend - `frontend/index.html`
- **`pollStatus()` å‡½æ•¸**
  - å·²æ­£ç¢ºå¯¦ç¾ï¼Œè®€å– `data.progress` ä¸¦é¡¯ç¤º
  - ç‹€æ…‹è¨Šæ¯æ ¼å¼ï¼š`ğŸ”„ Processing... {progress}%`

### æŠ€è¡“ç´°ç¯€

#### é€²åº¦è¨ˆç®—æµç¨‹
```
ComfyUI WebSocket â†’ Worker (comfy_client.py) â†’ Redis (job:status:<job_id>) â†’ API â†’ Frontend
```

#### é€²åº¦æ˜ å°„
- 10%: ä»»å‹™é–‹å§‹è™•ç†
- 15%: è™•ç†ä¸Šå‚³åœ–ç‰‡
- 20%: è§£æ Workflow
- 30%: æäº¤ä»»å‹™åˆ° ComfyUI
- 30-95%: ComfyUI åŸ·è¡Œä¸­ï¼ˆç”± `progress` äº‹ä»¶å‹•æ…‹æ›´æ–°ï¼‰
- 100%: ä»»å‹™å®Œæˆ

### é©—è­‰æ­¥é©Ÿ
1. å•Ÿå‹• Redisã€Backendã€Worker æœå‹™
2. å•Ÿå‹• ComfyUI
3. åœ¨å‰ç«¯æäº¤ç”Ÿæˆè«‹æ±‚
4. è§€å¯Ÿç‹€æ…‹è¨Šæ¯æ˜¯å¦é¡¯ç¤ºå‹•æ…‹é€²åº¦ç™¾åˆ†æ¯”

### ç›¸é—œæ–‡ä»¶
- [task.md](openspec/changes/phase-2-maturity/task.md) - Phase 2 ä»»å‹™æ¸…å–®
