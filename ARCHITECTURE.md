# ç³»çµ±æ¶æ§‹èˆ‡æµç¨‹èªªæ˜

## ğŸ—ï¸ æ•´é«”æ¶æ§‹

### ç³»çµ±çµ„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ComfyUI Studio System                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Frontend â”‚ â”€â”€â”€â†’ â”‚ Backend  â”‚ â”€â”€â”€â†’ â”‚  Redis   â”‚         â”‚
â”‚  â”‚  (HTML)  â”‚  â†‘   â”‚  (Flask) â”‚  â†‘   â”‚  (Queue) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                â”‚                  â”‚        â”‚               â”‚
â”‚                â”‚                  â”‚        â†“               â”‚
â”‚                â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚                â””â”€â”€â”€â”‚  Storage â”‚  â””â”€â”€â”€â”‚  Worker  â”‚         â”‚
â”‚                    â”‚ (outputs)â”‚      â”‚ (Python) â”‚         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                           â”‚               â”‚
â”‚                                           â†“               â”‚
â”‚                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚                                      â”‚ ComfyUI  â”‚         â”‚
â”‚                                      â”‚ (8188)   â”‚         â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€è¡“æ£§

| çµ„ä»¶ | æŠ€è¡“ | ç«¯å£ | ç”¨é€” |
|------|------|------|------|
| **Frontend** | HTML + JavaScript + Tailwind CSS | - | ä½¿ç”¨è€…ä»‹é¢ |
| **Backend** | Flask + Redis Client | 5000 | REST API æœå‹™ |
| **Worker** | Python + WebSocket | - | ä»»å‹™è™•ç† |
| **Redis** | Redis 7.2 | 6379 | è¨Šæ¯ä½‡åˆ— |
| **ComfyUI** | Python + PyTorch | 8188 | åœ–ç‰‡ç”Ÿæˆå¼•æ“ |

---

## ğŸ“Š æ ¸å¿ƒæµç¨‹

### 1. åœ–ç‰‡ç”Ÿæˆæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ¶è«‹æ±‚  â”‚
â”‚   - è¼¸å…¥ Prompt
â”‚   - é¸æ“‡æ¨¡å‹
â”‚   - è¨­å®šåƒæ•¸
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ POST /api/generate
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Backend API       â”‚
â”‚   - é©—è­‰è«‹æ±‚åƒæ•¸      â”‚
â”‚   - ç”Ÿæˆ job_id      â”‚
â”‚   - æ§‹é€ ä»»å‹™æ•¸æ“š      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ RPUSH job_data
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Redis ä½‡åˆ—        â”‚
â”‚   - ä»»å‹™æ’éšŠç­‰å¾…      â”‚
â”‚   - ç‹€æ…‹: queued     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ BLPOP (Worker å–å‡º)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Worker è™•ç†       â”‚
â”‚   Step 1: æ›´æ–°ç‹€æ…‹ç‚º processing (10%)
â”‚   Step 2: è™•ç†ä¸Šå‚³åœ–ç‰‡ (15%)
â”‚   Step 3: è§£æ Workflow (20%)
â”‚   Step 4: æª¢æŸ¥ ComfyUI é€£æ¥
â”‚   Step 5: æäº¤ä»»å‹™ (30%)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ POST /prompt + WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ComfyUI åŸ·è¡Œ      â”‚
â”‚   - è¼‰å…¥æ¨¡å‹         â”‚
â”‚   - åŸ·è¡Œç¯€é»         â”‚
â”‚   - ç”Ÿæˆåœ–ç‰‡         â”‚
â”‚   - ç™¼é€é€²åº¦äº‹ä»¶      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ WebSocket: progress events
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Worker ç›£è½       â”‚
â”‚   - æ¥æ”¶é€²åº¦æ›´æ–°      â”‚
â”‚   - æ˜ å°„åˆ° 30-95%    â”‚
â”‚   - æ›´æ–° Redis ç‹€æ…‹  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ ä»»å‹™å®Œæˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. è¤‡è£½è¼¸å‡ºåœ–ç‰‡       â”‚
â”‚   - å¾ ComfyUI/outputâ”‚
â”‚   - åˆ° storage/outputsâ”‚
â”‚   - é‡å‘½åç‚º job_id.pngâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ æ›´æ–°ç‹€æ…‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. å®Œæˆ             â”‚
â”‚   - status: finished â”‚
â”‚   - progress: 100%   â”‚
â”‚   - image_url: /outputs/{job_id}.png â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. é€²åº¦æŸ¥è©¢æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ (æ¯ 1 ç§’è¼ªè©¢)
       â†“ GET /api/status/{job_id}
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend API         â”‚
â”‚   - å¾ Redis è®€å–ç‹€æ…‹â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ HGETALL job:status:{job_id}
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis               â”‚
â”‚   {
â”‚     "status": "processing",
â”‚     "progress": 65,
â”‚     "image_url": "",
â”‚     "error": ""
â”‚   }
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ è¿”å› JSON
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend            â”‚
â”‚   - æ›´æ–°é€²åº¦æ¢       â”‚
â”‚   - é¡¯ç¤ºç‹€æ…‹æ–‡å­—      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ä»»å‹™å–æ¶ˆæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ¶é»æ“Š    â”‚
â”‚  å–æ¶ˆæŒ‰éˆ•    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ POST /api/cancel/{job_id}
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend API         â”‚
â”‚   - æª¢æŸ¥ä»»å‹™ç‹€æ…‹      â”‚
â”‚   - è¨­ç½®ç‚º cancelled â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ HSET job:status:{job_id} status cancelled
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis               â”‚
â”‚   status: cancelled  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘
       â”‚ (Worker æª¢æŸ¥ç‹€æ…‹)
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker on_progress  â”‚
â”‚   - æ¯æ¬¡é€²åº¦æ›´æ–°æª¢æŸ¥  â”‚
â”‚   - å¦‚æœ status == cancelled
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ POST /interrupt
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ComfyUI             â”‚
â”‚   - ä¸­æ–·ç•¶å‰åŸ·è¡Œ      â”‚
â”‚   - é‡‹æ”¾è³‡æº         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. å‹•æ…‹æ¨¡å‹è¼‰å…¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é é¢è¼‰å…¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ GET /api/models
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend API         â”‚
â”‚   - æƒæ checkpoints ç›®éŒ„
â”‚   - æƒæ unet ç›®éŒ„
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ éè¿´æƒæ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  File System         â”‚
â”‚   ComfyUI/models/
â”‚     â”œâ”€ checkpoints/
â”‚     â”‚   â”œâ”€ model1.safetensors
â”‚     â”‚   â””â”€ folder/model2.ckpt
â”‚     â””â”€ unet/
â”‚         â””â”€ z-image/turbo-fp8.safetensors
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ å›å‚³åˆ—è¡¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend            â”‚
â”‚   - æ¸…ç©ºä¸‹æ‹‰é¸å–®      â”‚
â”‚   - å»ºç«‹ UNET ç¾¤çµ„   â”‚
â”‚   - å»ºç«‹ Checkpoints ç¾¤çµ„
â”‚   - å‹•æ…‹ç”Ÿæˆ <option>
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ•¸æ“šæµè½‰

### Redis æ•¸æ“šçµæ§‹

#### 1. ä»»å‹™ä½‡åˆ—
```
Key: comfy_jobs
Type: List
Structure:
  - JSON String (ä»»å‹™æ•¸æ“š)

Example:
{
  "job_id": "uuid-1234",
  "prompt": "a cat",
  "seed": 12345,
  "workflow": "text_to_image",
  "model": "turbo_fp8",
  "aspect_ratio": "1:1",
  "batch_size": 1,
  "images": {},
  "created_at": "2024-12-31T10:00:00"
}
```

#### 2. ä»»å‹™ç‹€æ…‹
```
Key: job:status:{job_id}
Type: Hash
Fields:
  - job_id: String
  - status: String (queued|processing|finished|failed|cancelled)
  - progress: Integer (0-100)
  - image_url: String
  - error: String
  - updated_at: String (ISO 8601)

TTL: 86400 ç§’ (24 å°æ™‚)
```

### æª”æ¡ˆç³»çµ±çµæ§‹

```
storage/
â”œâ”€â”€ inputs/                    # æš«å­˜ä¸Šå‚³åœ–ç‰‡
â”‚   â”œâ”€â”€ upload_{job_id}_source.png
â”‚   â”œâ”€â”€ upload_{job_id}_target.png
â”‚   â””â”€â”€ upload_{job_id}_input.png
â”‚   (ä¿ç•™ 24 å°æ™‚)
â”‚
â””â”€â”€ outputs/                   # ç”Ÿæˆçµæœåœ–ç‰‡
    â”œâ”€â”€ {job_id}.png
    â”œâ”€â”€ {job_id}.jpg
    â””â”€â”€ ...
    (ä¿ç•™ 30 å¤©)
```

---

## âš¡ æ•ˆèƒ½è€ƒé‡

### 1. ä¸¦ç™¼è™•ç†

**å•é¡Œ**: å¤šå€‹ç”¨æˆ¶åŒæ™‚è«‹æ±‚

**è§£æ±ºæ–¹æ¡ˆ**:
- Redis ä½‡åˆ—å¯¦ç¾ä»»å‹™æ’éšŠ
- Worker å¯æ©«å‘æ“´å±•ï¼ˆå¤šå¯¦ä¾‹ï¼‰
- ComfyUI ä¸²è¡ŒåŸ·è¡Œï¼ˆå–®ä¸€ GPUï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User 1  â”‚   â”‚ User 2  â”‚   â”‚ User 3  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚             â”‚             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“ Backend (ä¸¦ç™¼è™•ç†)
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  Redis   â”‚ (ä»»å‹™æ’éšŠ)
             â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“          â†“          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Worker 1â”‚ â”‚Worker 2â”‚ â”‚Worker 3â”‚ (å¯æ“´å±•)
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“ ComfyUI (ä¸²è¡ŒåŸ·è¡Œ)
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ ComfyUI  â”‚ (GPU ç“¶é ¸)
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. é€²åº¦æ›´æ–°é »ç‡

**æ¬Šè¡¡**:
- é »ç‡å¤ªé«˜: Redis å¯«å…¥å£“åŠ›å¤§
- é »ç‡å¤ªä½: é€²åº¦æ›´æ–°ä¸æµæš¢

**ç•¶å‰ç­–ç•¥**:
- ComfyUI: æ¯å€‹æ­¥é©Ÿç™¼é€é€²åº¦äº‹ä»¶
- Worker: æ¯æ¬¡äº‹ä»¶éƒ½æ›´æ–° Redis
- Frontend: æ¯ 1 ç§’è¼ªè©¢ä¸€æ¬¡

### 3. åœ–ç‰‡å„²å­˜ç­–ç•¥

**é¸é …å°æ¯”**:

| æ–¹æ¡ˆ | å„ªé» | ç¼ºé» |
|------|------|------|
| æœ¬åœ°å„²å­˜ | ç°¡å–®ã€å¿«é€Ÿ | å®¹é‡é™åˆ¶ã€ä¸æ˜“æ“´å±• |
| é›²ç«¯å„²å­˜ (S3) | å¯æ“´å±•ã€é«˜å¯ç”¨ | æˆæœ¬ã€å»¶é² |
| NFS å…±äº« | å®¹é‡å¤§ã€å¯å…±äº« | ç¶²è·¯ä¾è³´ã€æ¬Šé™ç®¡ç† |

**ç•¶å‰æ¡ç”¨**: æœ¬åœ°å„²å­˜ + å®šæœŸæ¸…ç†

---

## ğŸ›¡ï¸ å®¹éŒ¯æ©Ÿåˆ¶

### 1. Redis é€£æ¥å¤±æ•—

**Backend**:
```python
try:
    redis_client = Redis(...)
    redis_client.ping()
except RedisError:
    logger.error("Redis é€£æ¥å¤±æ•—")
    redis_client = None
    # è¿”å› 503 Service Unavailable
```

**Worker**:
```python
while True:
    try:
        result = r.blpop(QUEUE, timeout=5)
    except redis.ConnectionError:
        logger.error("Redis é€£æ¥ä¸­æ–·")
        time.sleep(5)
        r = get_redis_client()  # é‡æ–°é€£æ¥
```

### 2. ComfyUI ä¸å¯ç”¨

**Worker æª¢æŸ¥**:
```python
if not client.check_connection():
    raise Exception("ç„¡æ³•é€£æ¥ ComfyUI")
    # ä»»å‹™ç‹€æ…‹è¨­ç‚º failed
```

**é‡è©¦ç­–ç•¥**: ä¸è‡ªå‹•é‡è©¦ï¼Œç”±ç”¨æˆ¶é‡æ–°æäº¤

### 3. ä»»å‹™è¶…æ™‚

**è¶…æ™‚è¨­å®š**:
- WebSocket é€£æ¥: 600 ç§’ (10 åˆ†é˜)
- è¶…æ™‚å¾Œä»»å‹™è‡ªå‹•æ¨™è¨˜ç‚º failed

### 4. Worker å´©æ½°

**å½±éŸ¿ç¯„åœ**: ç•¶å‰è™•ç†çš„ä»»å‹™éºå¤±

**æ¢å¾©æ©Ÿåˆ¶**:
- ä»»å‹™åœç•™åœ¨ Redis ä½‡åˆ—ï¼ˆå·²å–å‡ºçš„ä»»å‹™ç„¡æ³•æ¢å¾©ï¼‰
- ç”¨æˆ¶éœ€é‡æ–°æäº¤

**æ”¹é€²æ–¹å‘**: å¯¦ç¾ä»»å‹™è¶…æ™‚æª¢æ¸¬ + è‡ªå‹•é‡è©¦

---

## ğŸ“ˆ ç›£æ§æŒ‡æ¨™

### é—œéµæŒ‡æ¨™

1. **ä»»å‹™è™•ç†é€Ÿåº¦**
   - å¹³å‡è™•ç†æ™‚é–“
   - ä»»å‹™æ’éšŠæ™‚é–“

2. **ç³»çµ±è³‡æº**
   - Redis è¨˜æ†¶é«”ä½¿ç”¨
   - Worker CPU/è¨˜æ†¶é«”
   - ComfyUI GPU ä½¿ç”¨ç‡

3. **æˆåŠŸç‡**
   - å®Œæˆä»»å‹™æ•¸
   - å¤±æ•—ä»»å‹™æ•¸
   - å–æ¶ˆä»»å‹™æ•¸

4. **å„²å­˜ç©ºé–“**
   - `storage/outputs` å¤§å°
   - åœ–ç‰‡æ•¸é‡

### æŸ¥çœ‹æ–¹å¼

```powershell
# Docker å®¹å™¨è³‡æº
docker stats

# Redis è³‡è¨Š
redis-cli -h localhost -p 6379 -a mysecret INFO

# ä½‡åˆ—é•·åº¦
redis-cli -h localhost -p 6379 -a mysecret LLEN comfy_jobs

# ç£ç¢Ÿç©ºé–“
Get-ChildItem -Path "./storage/outputs" -Recurse | Measure-Object -Property Length -Sum
```

---

## ğŸ” å®‰å…¨è€ƒé‡

### 1. Redis å¯†ç¢¼ä¿è­·
```yaml
redis:
  command: redis-server --requirepass mysecret
```

### 2. CORS è¨­å®š
```python
CORS(app, origins=["*"])  # ç”Ÿç”¢ç’°å¢ƒæ‡‰é™åˆ¶ä¾†æº
```

### 3. æª”æ¡ˆä¸Šå‚³é™åˆ¶
- ç›®å‰: å‰ç«¯é™åˆ¶æª”æ¡ˆå¤§å°
- å»ºè­°: Backend å¢åŠ æª”æ¡ˆé¡å‹å’Œå¤§å°é©—è­‰

### 4. è¼¸å‡ºæª”æ¡ˆè¨ªå•
- ç›®å‰: éœæ…‹æª”æ¡ˆç›´æ¥è¨ªå•
- å»ºè­°: å¯¦ç¾æˆæ¬Šé©—è­‰æ©Ÿåˆ¶

---

## ğŸš€ æ“´å±•æ–¹å‘

### 1. å¤š Worker éƒ¨ç½²
```powershell
docker-compose up -d --scale worker=5
```

### 2. ä»»å‹™å„ªå…ˆç´š
åœ¨ Redis ä¸­ä½¿ç”¨ Sorted Set æ›¿ä»£ List

### 3. çµæœå¿«å–
å°ç›¸åŒåƒæ•¸çš„è«‹æ±‚è¿”å›å¿«å–çµæœ

### 4. WebSocket å³æ™‚é€šçŸ¥
æ›¿ä»£è¼ªè©¢æ©Ÿåˆ¶ï¼Œæ¸›å°‘ç¶²è·¯è«‹æ±‚

### 5. ç”¨æˆ¶ç³»çµ±
- ä»»å‹™æ­·å²è¨˜éŒ„
- é…é¡ç®¡ç†
- åœ–ç‰‡æ”¶è—

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [DEPLOYMENT.md](DEPLOYMENT.md) - éƒ¨ç½²æŒ‡å—
- [README.md](README.md) - å°ˆæ¡ˆæ¦‚è¿°
- [UpdateList.md](UpdateList.md) - æ›´æ–°æ—¥èªŒ
