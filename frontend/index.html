<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIGEN.IO - AI Creative Studio</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'xs': '475px',
                    }
                }
            }
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- API Configuration (Auto-generated by Ngrok script) -->
    <script src="config.js"></script>
    
    <style>
        /* 1. Hide Scrollbar Globally */
        ::-webkit-scrollbar { display: none; }
        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Mobile-first Responsive Adjustments */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -100%;
                transition: left 0.3s ease;
                z-index: 100;
                width: 80%;
                max-width: 280px;
            }
            #sidebar.mobile-open {
                left: 0;
            }
            .mobile-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 90;
                display: none;
            }
            .mobile-overlay.active {
                display: block;
            }
        }

        /* Animations */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes flow {
            0% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0, 0) scale(1); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(124, 58, 237, 0.3); }
            50% { box-shadow: 0 0 40px rgba(124, 58, 237, 0.6); }
        }

        /* Glass Styles */
        .glass-panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.00) 100%);
            backdrop-filter: blur(24px) brightness(1.1);
            -webkit-backdrop-filter: blur(24px) brightness(1.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 30, 40, 0.6) 0%, rgba(20, 20, 30, 0.4) 100%);
            backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.25);
            border-bottom: 1px solid rgba(0, 0, 0, 0.5);
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }
        
        .glass-card:hover {
            transform: translateY(-4px) scale(1.005);
            background: linear-gradient(145deg, rgba(40, 40, 55, 0.7) 0%, rgba(30, 30, 45, 0.5) 100%);
            border-top-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.8), 0 0 20px rgba(100, 100, 255, 0.15);
        }

        /* Navigation Item Styles */
        .nav-item {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            color: white;
        }

        .nav-item.active-nav {
            background: linear-gradient(90deg, rgba(124, 58, 237, 0.2), transparent);
            border-left: 2px solid #a78bfa;
            border-color: rgba(124, 58, 237, 0.3);
            color: white;
        }

        /* Custom Input */
        .custom-input {
            background: rgba(10, 10, 15, 0.6);
            border: 1px solid rgba(255,255,255,0.1);
            border-top: 1px solid rgba(255,255,255,0.2);
            color: white;
            outline: none;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .custom-input:focus {
            background: rgba(20, 20, 30, 0.8);
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2), inset 0 2px 4px rgba(0,0,0,0.5);
        }

        /* Liquid Background Blobs */
        .liquid-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.6;
            mix-blend-mode: hard-light;
            animation: flow 10s infinite ease-in-out alternate;
        }

        /* Upload Zone Styles */
        .upload-zone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-zone:hover {
            border-color: rgba(168, 85, 247, 0.5);
            background: rgba(168, 85, 247, 0.05);
        }
        .upload-zone.has-image {
            border-style: solid;
            border-color: rgba(168, 85, 247, 0.4);
        }

        /* Aspect Ratio Button */
        .ratio-btn {
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .ratio-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .ratio-btn.active {
            border-color: rgba(168, 85, 247, 0.8);
            background: rgba(168, 85, 247, 0.15);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.2);
        }

        /* Grid Background Pattern */
        .grid-bg {
            background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Floating Toolbar Overlay */
        @keyframes overlay-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tool-card {
            transition: all 0.3s ease;
        }
        .tool-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body class="flex h-screen bg-[#020205] text-white font-sans selection:bg-purple-500/30 selection:text-white overflow-hidden relative">

    <!-- Mobile Menu Overlay -->
    <div class="mobile-overlay md:hidden" id="mobileOverlay" onclick="closeMobileSidebar()"></div>

    <!-- Mobile Header (visible only on mobile) -->
    <header class="md:hidden fixed top-0 left-0 right-0 h-14 glass-panel border-b border-white/5 flex items-center justify-between px-4 z-50">
        <button onclick="openMobileSidebar()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600"></div>
            <span class="font-bold text-lg">AIGEN</span>
        </div>
        <div class="w-10"></div>
    </header>

    <!-- ============================================ -->
    <!-- Background Ambience                         -->
    <!-- ============================================ -->
    <div class="fixed inset-0 z-0 bg-[#020205] overflow-hidden pointer-events-none">
        <div class="liquid-blob bg-[#1e3a8a] w-[300px] md:w-[600px] h-[300px] md:h-[600px] top-[10%] -left-[50px] md:-left-[100px]" style="animation-duration: 15s;"></div>
        <div class="liquid-blob bg-[#64748b] w-[150px] md:w-[300px] h-[150px] md:h-[300px] top-[20%] left-[50px] md:left-[100px] opacity-40" style="animation-duration: 12s; animation-delay: 2s;"></div>
        <div class="liquid-blob bg-[#581c87] w-[350px] md:w-[700px] h-[350px] md:h-[700px] -bottom-[10%] -right-[50px] md:-right-[100px]" style="animation-duration: 18s;"></div>
        <div class="liquid-blob bg-[#3b0764] w-[200px] md:w-[400px] h-[200px] md:h-[400px] bottom-[10%] right-[50px] md:right-[100px]" style="animation-duration: 20s; animation-delay: 5s;"></div>
        <div class="liquid-blob bg-[#06b6d4] w-[150px] md:w-[300px] h-[150px] md:h-[300px] top-[40%] right-[30%] opacity-30 blur-[80px]" style="animation-duration: 25s;"></div>
        <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-30 mix-blend-overlay"></div>
    </div>

    <!-- ============================================ -->
    <!-- LEFT SIDEBAR - Navigation                   -->
    <!-- ============================================ -->
    <aside id="sidebar" class="w-64 glass-panel flex flex-col border-r border-white/5 z-50 relative fixed md:static left-0 top-0 bottom-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300">
        <!-- Logo -->
        <div class="h-16 flex items-center px-6 border-b border-white/5 cursor-pointer" onclick="navigateTo('dashboard')">
            <div class="flex items-center gap-2 group">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-slate-700 to-slate-900 flex items-center justify-center shadow-[0_2px_10px_rgba(0,0,0,0.5)] border border-white/20 relative overflow-hidden group-hover:border-purple-500/50 transition-colors">
                    <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/20 to-transparent"></div>
                    <i data-lucide="sparkles" class="text-white w-4 h-4 z-10"></i>
                </div>
                <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white via-gray-200 to-gray-500 drop-shadow-sm tracking-tight group-hover:text-white transition-colors">
                    AIGEN.IO
                </span>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-2">
            <div class="px-3 mb-3 text-xs font-bold text-gray-500 uppercase tracking-wider">Core Tools</div>
            
            <button onclick="showCompositionMenu()" class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item" data-id="canvas">
                <i data-lucide="layers" class="w-5 h-5 group-hover:text-purple-300"></i>
                Image Composition
            </button>
            
            <button onclick="navigateTo('motion')" class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item" data-id="motion">
                <i data-lucide="film" class="w-5 h-5 group-hover:text-amber-300"></i>
                Image to Video
            </button>
            
            <button onclick="navigateTo('avatar')" class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item" data-id="avatar">
                <i data-lucide="user-circle-2" class="w-5 h-5 group-hover:text-emerald-300"></i>
                Avatar Studio
            </button>

            <div class="h-[1px] bg-gradient-to-r from-transparent via-white/10 to-transparent my-6 mx-2"></div>
            
            <button onclick="navigateTo('dashboard')" class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-300 group nav-item active-nav" data-id="dashboard">
                <i data-lucide="layout-grid" class="w-5 h-5 group-hover:text-white"></i>
                Dashboard
            </button>
            
            <button onclick="navigateTo('gallery')" class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item" data-id="gallery">
                <i data-lucide="image" class="w-5 h-5 group-hover:text-white"></i>
                Personal Gallery
            </button>
        </nav>

        <!-- User Profile -->
        <div class="p-4 border-t border-white/5">
            <div class="glass-card rounded-xl p-4 relative overflow-hidden group cursor-pointer hover:bg-white/5">
                <div class="flex justify-between items-center mb-2 relative z-10">
                    <span class="text-xs font-semibold text-gray-400">Credits</span>
                    <span class="text-xs text-white bg-white/10 px-2 py-0.5 rounded-full border border-white/10">Pro</span>
                </div>
                <div class="text-xl font-bold text-white relative z-10 flex items-baseline gap-1">
                    1,250 <span class="text-xs font-normal text-gray-500">/ 8k</span>
                </div>
                <div class="w-full bg-black/50 h-1.5 rounded-full mt-3 overflow-hidden border border-white/5">
                    <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-full w-[15%] rounded-full"></div>
                </div>
            </div>
            
            <button class="nav-item w-full flex items-center gap-3 mt-3 px-3 py-2 rounded-lg text-left">
                <div class="w-9 h-9 rounded-full bg-gradient-to-b from-gray-500 to-gray-800 border border-white/20 flex items-center justify-center overflow-hidden">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Alex" alt="User" class="w-full h-full object-cover opacity-90" />
                </div>
                <div class="flex-1">
                    <div class="text-sm font-medium text-white">Alex Designer</div>
                    <div class="text-xs text-gray-500">alex@design.com</div>
                </div>
            </button>
        </div>
    </aside>

    <!-- ============================================ -->
    <!-- MAIN CONTENT AREA                           -->
    <!-- 包含 Dashboard 和 Workspace 視圖             -->
    <!-- ============================================ -->
    <main class="flex-1 flex flex-col relative overflow-hidden z-10">

        <!-- ============================================ -->
        <!-- VIEW: Dashboard (預設首頁)                   -->
        <!-- ============================================ -->
        <div id="view-dashboard" class="view-section flex flex-col h-full overflow-y-auto p-6 md:p-8 animate-fade-in">
            <div class="max-w-6xl mx-auto w-full">
                
                <!-- ============================================ -->
                <!-- SYSTEM HUD (監控面板) - Cyberpunk Style    -->
                <!-- ============================================ -->
                <div id="system-hud" class="mb-8 glass-panel rounded-2xl p-6 border border-white/10 shadow-2xl">
                    <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
                        <!-- HUD Header -->
                        <div class="flex items-center gap-3">
                            <div class="p-3 rounded-xl bg-gradient-to-r from-cyan-500/20 to-blue-500/20 border border-cyan-500/30">
                                <i data-lucide="activity" class="w-6 h-6 text-cyan-300"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-bold text-white uppercase tracking-wider">System Status</h3>
                                <p class="text-xs text-gray-400 font-mono">Real-time Monitoring</p>
                            </div>
                        </div>
                        
                        <!-- HUD Indicators -->
                        <div class="flex-1 grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <!-- Server Status -->
                            <div class="flex items-center gap-3 bg-black/20 rounded-xl p-3 border border-white/5">
                                <div id="server-status-indicator" class="w-3 h-3 rounded-full bg-green-500 shadow-lg shadow-green-500/50 animate-pulse"></div>
                                <div>
                                    <div class="text-xs text-gray-400 font-mono">Server</div>
                                    <div id="server-status-text" class="text-sm font-bold text-green-400">ONLINE</div>
                                </div>
                            </div>
                            
                            <!-- Worker Status -->
                            <div class="flex items-center gap-3 bg-black/20 rounded-xl p-3 border border-white/5">
                                <div id="worker-status-indicator" class="w-3 h-3 rounded-full bg-gray-500"></div>
                                <div>
                                    <div class="text-xs text-gray-400 font-mono">Worker</div>
                                    <div id="worker-status-text" class="text-sm font-bold text-gray-400">CHECKING...</div>
                                </div>
                            </div>
                            
                            <!-- Queue Status -->
                            <div class="flex items-center gap-3 bg-black/20 rounded-xl p-3 border border-white/5">
                                <div class="p-2 rounded-lg bg-purple-500/10 border border-purple-500/20">
                                    <i data-lucide="list-checks" class="w-4 h-4 text-purple-300"></i>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-400 font-mono">Queue</div>
                                    <div id="queue-count" class="text-sm font-bold text-purple-400 font-mono">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hero -->
                <div class="mb-12 text-center">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-500/5 via-purple-500/5 to-transparent blur-3xl -z-10 rounded-full opacity-50"></div>
                    <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-b from-white via-gray-200 to-gray-500 tracking-tight drop-shadow-lg">
                        Unleash Your <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-blue-300">AI Creativity</span>
                    </h1>
                    <p class="text-gray-400 text-lg max-w-2xl mx-auto font-light">
                        Create stunning visual assets using industry-leading generative models.
                    </p>
                </div>

                <!-- Tools Grid -->
                <div class="space-y-12">
                    <div>
                        <div class="flex items-center gap-4 mb-6">
                            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                                <span class="w-1 h-6 bg-gradient-to-b from-white to-gray-500 rounded-full"></span>
                                Core Features
                            </h2>
                            <div class="h-[1px] flex-1 bg-gradient-to-r from-white/10 to-transparent"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            
                            <!-- Card 1: Image Composition -->
                            <div onclick="showCompositionMenu()" class="glass-card group rounded-2xl p-6 cursor-pointer flex flex-col h-full hover:shadow-[0_0_30px_rgba(168,85,247,0.15)]">
                                <div class="flex justify-between items-start mb-4 relative z-10">
                                    <div class="p-3 rounded-xl bg-white/5 text-purple-200 border border-white/10 group-hover:scale-110 transition-transform duration-300 group-hover:border-purple-400/50 group-hover:bg-purple-500/20">
                                        <i data-lucide="layers" class="w-7 h-7"></i>
                                    </div>
                                    <span class="text-[10px] font-bold px-2 py-1 rounded-full bg-white/5 text-gray-300 border border-white/10 uppercase tracking-wider">Popular</span>
                                </div>
                                <div class="relative z-10 flex-1">
                                    <h3 class="text-lg font-bold text-white mb-1 group-hover:text-purple-200">Image Gen & Upscale</h3>
                                    <p class="text-xs font-mono text-gray-500 mb-3">Composition, Inpainting & Upscale</p>
                                    <p class="text-sm text-gray-400 leading-relaxed group-hover:text-gray-300">Integrated infinite canvas inpainting and Pipeline C upscaling for one-stop editing.</p>
                                </div>
                            </div>

                            <!-- Card 2: Image to Video -->
                            <div onclick="navigateTo('motion')" class="glass-card group rounded-2xl p-6 cursor-pointer flex flex-col h-full hover:shadow-[0_0_30px_rgba(245,158,11,0.15)]">
                                <div class="flex justify-between items-start mb-4 relative z-10">
                                    <div class="p-3 rounded-xl bg-white/5 text-amber-200 border border-white/10 group-hover:scale-110 transition-transform duration-300 group-hover:border-amber-400/50 group-hover:bg-amber-500/20">
                                        <i data-lucide="film" class="w-7 h-7"></i>
                                    </div>
                                    <span class="text-[10px] font-bold px-2 py-1 rounded-full bg-white/5 text-gray-300 border border-white/10 uppercase tracking-wider">New</span>
                                </div>
                                <div class="relative z-10 flex-1">
                                    <h3 class="text-lg font-bold text-white mb-1 group-hover:text-amber-200">Image to Video</h3>
                                    <p class="text-xs font-mono text-gray-500 mb-3">Multi-Shot Image to Video</p>
                                    <p class="text-sm text-gray-400 leading-relaxed group-hover:text-gray-300">Support up to 5-shot sequences, generating long videos via timeline concatenation.</p>
                                </div>
                            </div>

                            <!-- Card 3: Avatar Studio -->
                            <div onclick="navigateTo('avatar')" class="glass-card group rounded-2xl p-6 cursor-pointer flex flex-col h-full hover:shadow-[0_0_30px_rgba(16,185,129,0.15)]">
                                <div class="flex justify-between items-start mb-4 relative z-10">
                                    <div class="p-3 rounded-xl bg-white/5 text-emerald-200 border border-white/10 group-hover:scale-110 transition-transform duration-300 group-hover:border-emerald-400/50 group-hover:bg-emerald-500/20">
                                        <i data-lucide="user-circle-2" class="w-7 h-7"></i>
                                    </div>
                                    <span class="text-[10px] font-bold px-2 py-1 rounded-full bg-white/5 text-gray-300 border border-white/10 uppercase tracking-wider">All-in-One</span>
                                </div>
                                <div class="relative z-10 flex-1">
                                    <h3 class="text-lg font-bold text-white mb-1 group-hover:text-emerald-200">Avatar Studio</h3>
                                    <p class="text-xs font-mono text-gray-500 mb-3">Avatar Gen & Motion</p>
                                    <p class="text-sm text-gray-400 leading-relaxed group-hover:text-gray-300">One-stop character training and motion performance, including Prompt control and voice upload.</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- VIEW: Image Composition Workspace           -->
        <!-- 三欄布局：Center Stage | Settings             -->
        <!-- ============================================ -->
        <div id="view-canvas" class="view-section hidden h-full relative">

            <!-- ============================================ -->
            <!-- FLOATING TOOL SELECTOR OVERLAY              -->
            <!-- ============================================ -->
            <div id="tool-selector-overlay" class="absolute inset-0 z-50 flex items-center justify-center overlay-backdrop" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);">
                <div class="floating-toolbar glass-panel rounded-3xl p-12 max-w-6xl w-full mx-6 border border-white/10">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-10">
                        <div class="flex items-center gap-4">
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-purple-500 to-indigo-600 shadow-lg shadow-purple-500/30">
                                <i data-lucide="layers" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold text-white">Image Composition</h2>
                                <p class="text-base text-gray-400 mt-1">選擇一個工具開始創作</p>
                            </div>
                        </div>
                        <button onclick="hideCompositionMenu()" class="p-3 rounded-xl hover:bg-white/10 transition-colors text-gray-400 hover:text-white">
                            <i data-lucide="x" class="w-8 h-8"></i>
                        </button>
                    </div>
                    
                    <!-- Tool Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
                        <!-- Face Swap -->
                        <button onclick="selectTool('face_swap')" class="tool-card glass-card rounded-3xl p-8 text-center cursor-pointer hover:border-purple-500/50 group">
                            <div class="p-5 rounded-2xl bg-purple-500/10 text-purple-300 mx-auto w-fit mb-5 group-hover:bg-purple-500/20 group-hover:scale-110 transition-all border border-purple-500/20">
                                <i data-lucide="users" class="w-12 h-12"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">Face Swap</h3>
                            <p class="text-sm text-gray-500">換臉</p>
                        </button>
                        
                        <!-- Multi-Blend -->
                        <button onclick="selectTool('multi_image_blend')" class="tool-card glass-card rounded-3xl p-8 text-center cursor-pointer hover:border-amber-500/50 group">
                            <div class="p-5 rounded-2xl bg-amber-500/10 text-amber-300 mx-auto w-fit mb-5 group-hover:bg-amber-500/20 group-hover:scale-110 transition-all border border-amber-500/20">
                                <i data-lucide="layers" class="w-12 h-12"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">Multi-Blend</h3>
                            <p class="text-sm text-gray-500">多圖融合</p>
                        </button>
                        
                        <!-- Sketch to Image -->
                        <button onclick="selectTool('sketch_to_image')" class="tool-card glass-card rounded-3xl p-8 text-center cursor-pointer hover:border-emerald-500/50 group">
                            <div class="p-5 rounded-2xl bg-emerald-500/10 text-emerald-300 mx-auto w-fit mb-5 group-hover:bg-emerald-500/20 group-hover:scale-110 transition-all border border-emerald-500/20">
                                <i data-lucide="pencil" class="w-12 h-12"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">Sketch</h3>
                            <p class="text-sm text-gray-500">草稿轉精稿</p>
                        </button>
                        
                        <!-- Text to Image -->
                        <button onclick="selectTool('text_to_image')" class="tool-card glass-card rounded-3xl p-8 text-center cursor-pointer hover:border-blue-500/50 group">
                            <div class="p-5 rounded-2xl bg-blue-500/10 text-blue-300 mx-auto w-fit mb-5 group-hover:bg-blue-500/20 group-hover:scale-110 transition-all border border-blue-500/20">
                                <i data-lucide="type" class="w-12 h-12"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">Text2Img</h3>
                            <p class="text-sm text-gray-500">文生圖</p>
                        </button>
                        
                        <!-- Single Image Edit -->
                        <button onclick="selectTool('single_image_edit')" class="tool-card glass-card rounded-3xl p-8 text-center cursor-pointer hover:border-pink-500/50 group">
                            <div class="p-5 rounded-2xl bg-pink-500/10 text-pink-300 mx-auto w-fit mb-5 group-hover:bg-pink-500/20 group-hover:scale-110 transition-all border border-pink-500/20">
                                <i data-lucide="image" class="w-12 h-12"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">Edit</h3>
                            <p class="text-sm text-gray-500">單圖編輯</p>
                        </button>
                    </div>
                    
                    <!-- Footer Hint -->
                    <p class="text-center text-base text-gray-500 mt-10">按 ESC 或點擊外部區域關閉</p>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STUDIO WORKSPACE (工具選擇後顯示)            -->
            <!-- ============================================ -->
            <div id="studio-workspace" class="hidden flex h-full">
                
                <!-- ============================================ -->
                <!-- CENTER STAGE (Canvas + Controls)            -->
                <!-- ============================================ -->
                <div class="flex-1 flex flex-col relative grid-bg">
                    
                    <!-- Current Tool Header -->
                    <div id="current-tool-header" class="flex items-center gap-4 px-6 py-4 border-b border-white/5 bg-black/20">
                        <button onclick="showCompositionMenu()" class="p-2 rounded-lg hover:bg-white/10 transition-colors text-gray-400 hover:text-white" title="切換工具">
                            <i data-lucide="grid-3x3" class="w-5 h-5"></i>
                        </button>
                        <div class="h-6 w-[1px] bg-white/10"></div>
                        <div id="current-tool-info" class="flex items-center gap-3">
                            <div id="current-tool-icon" class="p-2 rounded-lg bg-purple-500/20 text-purple-300">
                                <i data-lucide="type" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <span id="current-tool-name" class="text-sm font-bold text-white">Text to Image</span>
                                <span id="current-tool-desc" class="text-xs text-gray-500 ml-2">文生圖</span>
                            </div>
                        </div>
                    </div>

                    <!-- Canvas Area (Result Display Only) -->
                    <div id="workspace-canvas" class="flex-1 flex items-center justify-center p-8 overflow-auto">
                        <!-- Placeholder State -->
                        <div id="canvas-placeholder" class="text-center opacity-50">
                            <div class="w-32 h-32 border-4 border-dashed border-gray-600 rounded-full mx-auto mb-6 flex items-center justify-center">
                                <i data-lucide="image" class="w-12 h-12 text-gray-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-400 mb-2">Ready to Generate</h2>
                            <p class="text-sm text-gray-500">Select a tool and enter your prompt below</p>
                        </div>
                        <!-- Result Images Grid (支援 Batch Size 多圖) -->
                        <div id="canvas-results" class="hidden w-full h-full">
                            <div id="results-grid" class="grid gap-4 w-full h-full place-items-center">
                                <!-- 動態生成圖片卡片 -->
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Control Panel (Glassmorphism) -->
                    <div id="workspace-controls" class="glass-panel p-6 relative">
                        <div class="max-w-4xl mx-auto flex flex-col gap-4">
                            
                            <!-- Row 1: Dynamic Upload Zones -->
                            <div id="upload-zones" class="flex gap-4 h-28">
                                <!-- 動態生成上傳區域 -->
                            </div>

                            <!-- Row 2: Prompt Bar -->
                            <div class="flex gap-4">
                                <textarea id="prompt-input" class="flex-1 custom-input rounded-xl p-4 text-sm resize-none h-16" placeholder="Describe your image..."></textarea>
                                <button id="btn-enhance" type="button" class="px-4 rounded-xl font-medium bg-white/5 border border-white/10 hover:bg-white/10 hover:border-purple-500/50 transition-all flex items-center gap-2 text-gray-400 hover:text-white" title="AI 優化 Prompt">
                                    <i data-lucide="wand-2" class="w-5 h-5"></i>
                                </button>
                                <button id="btn-generate" type="button" class="bg-gradient-to-r from-purple-600 to-indigo-600 px-8 rounded-xl font-bold hover:shadow-[0_0_25px_rgba(124,58,237,0.5)] transition-all flex items-center gap-2 border border-white/10 hover:brightness-110">
                                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                                    <span>Generate</span>
                                </button>
                            </div>

                            <!-- Status Message -->
                            <div id="status-message" class="text-sm text-gray-400 text-center hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- RIGHT SETTINGS PANEL (Leonardo Style)       -->
                <!-- ============================================ -->
                <aside id="workspace-settings" class="w-80 border-l border-white/10 bg-black/30 p-6 flex flex-col gap-6 overflow-y-auto flex-shrink-0">
                    
                    <!-- Model Selector -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase mb-2 block tracking-wider">Model</label>
                        <select id="model-select" class="w-full custom-input rounded-xl p-3 text-sm cursor-pointer">
                            <option value="loading" disabled>Loading models...</option>
                        </select>
                    </div>

                    <!-- Aspect Ratio Grid -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase mb-3 block tracking-wider">Aspect Ratio</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="updateAspectRatio('1:1')" data-ratio="1:1" class="ratio-btn active p-3 rounded-xl flex flex-col items-center gap-2 bg-black/30">
                                <div class="w-8 h-8 border-2 border-current rounded-md"></div>
                                <span class="text-xs font-medium">1:1 Square</span>
                            </button>
                            <button onclick="updateAspectRatio('16:9')" data-ratio="16:9" class="ratio-btn p-3 rounded-xl flex flex-col items-center gap-2 bg-black/30 text-gray-400">
                                <div class="w-10 h-6 border-2 border-current rounded-md"></div>
                                <span class="text-xs font-medium">16:9 Cinema</span>
                            </button>
                            <button onclick="updateAspectRatio('9:16')" data-ratio="9:16" class="ratio-btn p-3 rounded-xl flex flex-col items-center gap-2 bg-black/30 text-gray-400">
                                <div class="w-6 h-10 border-2 border-current rounded-md"></div>
                                <span class="text-xs font-medium">9:16 Mobile</span>
                            </button>
                            <button onclick="updateAspectRatio('2:3')" data-ratio="2:3" class="ratio-btn p-3 rounded-xl flex flex-col items-center gap-2 bg-black/30 text-gray-400">
                                <div class="w-6 h-9 border-2 border-current rounded-md"></div>
                                <span class="text-xs font-medium">2:3 Portrait</span>
                            </button>
                        </div>
                    </div>

                    <!-- Seed Input -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase mb-2 block tracking-wider">Seed</label>
                        <div class="flex gap-2">
                            <input type="number" id="seed-input" value="-1" class="flex-1 custom-input rounded-xl p-3 text-sm" placeholder="-1 (Random)">
                            <button onclick="document.getElementById('seed-input').value = Math.floor(Math.random() * 999999999)" class="p-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition-colors" title="Random Seed">
                                <i data-lucide="shuffle" class="w-4 h-4 text-gray-400"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">-1 for random seed</p>
                    </div>

                    <!-- Batch Size -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase mb-2 block tracking-wider">Batch Size</label>
                        <div class="flex gap-2">
                            <button onclick="setBatchSize(1)" data-batch="1" class="batch-btn flex-1 py-2 rounded-lg text-sm font-medium bg-purple-500/20 border border-purple-500/50 text-white">1</button>
                            <button onclick="setBatchSize(2)" data-batch="2" class="batch-btn flex-1 py-2 rounded-lg text-sm font-medium bg-black/30 border border-white/10 text-gray-400 hover:bg-white/5">2</button>
                            <button onclick="setBatchSize(4)" data-batch="4" class="batch-btn flex-1 py-2 rounded-lg text-sm font-medium bg-black/30 border border-white/10 text-gray-400 hover:bg-white/5">4</button>
                        </div>
                    </div>

                    <!-- Separator -->
                    <div class="h-[1px] bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

                    <!-- Advanced Settings (Collapsed) -->
                    <details class="group">
                        <summary class="text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer flex items-center gap-2 hover:text-gray-300 transition-colors">
                            <i data-lucide="chevron-right" class="w-4 h-4 group-open:rotate-90 transition-transform"></i>
                            Advanced Settings
                        </summary>
                        <div class="mt-4 space-y-4 pl-6">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">CFG Scale</label>
                                <input type="range" min="1" max="20" value="7" class="w-full accent-purple-500">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Steps</label>
                                <input type="number" value="20" class="w-full custom-input rounded-lg p-2 text-sm">
                            </div>
                        </div>
                    </details>

                </aside>
            </div><!-- End studio-workspace -->
        </div><!-- End view-canvas -->

        <!-- ============================================ -->
        <!-- VIEW: Personal Gallery                      -->
        <!-- ============================================ -->
        <div id="view-gallery" class="view-section hidden h-full overflow-y-auto p-6 md:p-8">
            <div class="max-w-7xl mx-auto w-full">
                <!-- Header -->
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold mb-2 text-white">Personal Gallery</h1>
                        <p class="text-gray-400">回顧您的創作歷史，重新混音您的作品</p>
                    </div>
                    <button onclick="loadHistory()" class="glass-card px-4 py-2 rounded-lg text-sm font-medium hover:bg-white/10 flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        重新整理
                    </button>
                </div>

                <!-- Filters (未來擴展) -->
                <div class="glass-card rounded-xl p-4 mb-6 flex items-center gap-4">
                    <span class="text-sm text-gray-400">篩選:</span>
                    <button class="px-3 py-1 rounded-lg bg-purple-500/20 border border-purple-500/50 text-purple-300 text-sm">
                        全部
                    </button>
                    <button class="px-3 py-1 rounded-lg hover:bg-white/5 border border-transparent text-gray-400 text-sm">
                        已完成
                    </button>
                    <button class="px-3 py-1 rounded-lg hover:bg-white/5 border border-transparent text-gray-400 text-sm">
                        生成中
                    </button>
                </div>

                <!-- Gallery Grid -->
                <div id="gallery-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Loading State -->
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i data-lucide="loader" class="w-8 h-8 mx-auto mb-4 animate-spin"></i>
                        <p>載入歷史記錄中...</p>
                    </div>
                </div>

                <!-- Pagination (未來擴展) -->
                <div id="gallery-pagination" class="hidden mt-8 flex justify-center gap-2">
                    <button class="glass-card px-4 py-2 rounded-lg text-sm hover:bg-white/10">上一頁</button>
                    <span class="px-4 py-2 text-sm text-gray-400">第 1 頁</span>
                    <button class="glass-card px-4 py-2 rounded-lg text-sm hover:bg-white/10">下一頁</button>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- VIEW: Motion Workspace                      -->
        <!-- ============================================ -->
        <div id="view-motion" class="view-section hidden h-full">
            <div class="flex flex-1 h-full overflow-hidden">
                <!-- Left Panel: Shot Composition -->
                <div class="w-80 glass-panel border-r border-white/10 p-6 flex flex-col gap-4 overflow-y-auto h-full z-20">
                    <div>
                        <h3 class="text-sm font-bold text-white mb-2">Multi-Shot Composition</h3>
                        <p class="text-xs text-gray-500 mb-4">Add up to 5 images to create a sequence.</p>
                        <div class="space-y-3">
                            <div class="relative aspect-video bg-black/40 border border-purple-500/50 rounded-xl overflow-hidden group cursor-pointer shadow-lg shadow-purple-900/20 hover:scale-105 transition-transform">
                                <div class="absolute top-2 left-2 bg-purple-600 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">Shot 1</div>
                                <div class="absolute inset-0 flex items-center justify-center text-gray-500 text-xs">Image Loaded</div>
                            </div>
                            <div class="relative aspect-video bg-white/5 border border-dashed border-white/10 rounded-xl flex flex-col items-center justify-center hover:border-purple-500/50 hover:bg-purple-500/5 cursor-pointer transition-colors group">
                                <div class="absolute top-2 left-2 bg-gray-800 text-gray-400 text-[10px] font-bold px-2 py-0.5 rounded">Shot 2</div>
                                <i data-lucide="plus" class="text-gray-600 group-hover:text-purple-400 w-5 h-5 transition-colors group-hover:scale-125"></i>
                            </div>
                            <div class="relative aspect-video bg-white/5 border border-dashed border-white/10 rounded-xl flex flex-col items-center justify-center hover:border-purple-500/50 hover:bg-purple-500/5 cursor-pointer transition-colors group">
                                <div class="absolute top-2 left-2 bg-gray-800 text-gray-400 text-[10px] font-bold px-2 py-0.5 rounded">Shot 3</div>
                                <i data-lucide="plus" class="text-gray-600 group-hover:text-purple-400 w-5 h-5 transition-colors group-hover:scale-125"></i>
                            </div>
                            <div class="relative aspect-video bg-white/5 border border-dashed border-white/10 rounded-xl flex flex-col items-center justify-center hover:border-purple-500/50 hover:bg-purple-500/5 cursor-pointer transition-colors group">
                                <div class="absolute top-2 left-2 bg-gray-800 text-gray-400 text-[10px] font-bold px-2 py-0.5 rounded">Shot 4</div>
                                <i data-lucide="plus" class="text-gray-600 group-hover:text-purple-400 w-5 h-5 transition-colors group-hover:scale-125"></i>
                            </div>
                            <div class="relative aspect-video bg-white/5 border border-dashed border-white/10 rounded-xl flex flex-col items-center justify-center hover:border-purple-500/50 hover:bg-purple-500/5 cursor-pointer transition-colors group">
                                <div class="absolute top-2 left-2 bg-gray-800 text-gray-400 text-[10px] font-bold px-2 py-0.5 rounded">Shot 5</div>
                                <i data-lucide="plus" class="text-gray-600 group-hover:text-purple-400 w-5 h-5 transition-colors group-hover:scale-125"></i>
                            </div>
                        </div>
                    </div>
                    <button class="nav-item mt-4 w-full bg-gradient-to-r from-amber-500 to-orange-600 text-white py-3.5 rounded-xl font-bold hover:shadow-[0_0_20px_rgba(245,158,11,0.4)] transition-all flex items-center justify-center gap-2 sticky bottom-0 border border-white/10">
                        <i data-lucide="film" class="w-4 h-4"></i> Generate Full Video
                    </button>
                </div>
                
                <!-- Center: Preview Area -->
                <div class="flex-1 p-8 bg-black/20 flex flex-col relative z-10 grid-bg">
                    <div class="flex-1 flex items-center justify-center text-center text-gray-500">
                        <div>
                            <div class="w-32 h-32 rounded-full bg-white/5 flex items-center justify-center mx-auto mb-6 border border-white/5 shadow-lg">
                                <i data-lucide="play-circle" class="w-16 h-16 text-white/20"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-400 mb-2">Preview Area</h2>
                            <p class="text-sm text-gray-500">Generated video will appear here</p>
                        </div>
                    </div>
                    
                    <!-- Prompt Input Area -->
                    <div class="glass-panel rounded-2xl mt-4 p-6 relative border border-white/10 flex flex-col gap-3">
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-gray-400 uppercase font-bold tracking-wider flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-3 h-3 text-amber-400"></i> Video Prompt
                            </div>
                            <div class="text-xs text-gray-500">Describe the motion</div>
                        </div>
                        <div class="flex gap-4">
                            <textarea class="flex-1 custom-input rounded-xl p-4 text-sm text-white resize-none h-20" placeholder="Describe the camera movement, subject action, or atmosphere..."></textarea>
                            <button class="bg-gradient-to-r from-amber-500 to-orange-600 px-6 rounded-xl font-bold hover:shadow-[0_0_20px_rgba(245,158,11,0.4)] transition-all flex items-center gap-2 border border-white/10">
                                <i data-lucide="wand-2" class="w-4 h-4"></i>
                                <span>Enhance</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- VIEW: Avatar Workspace                      -->
        <!-- ============================================ -->
        <div id="view-avatar" class="view-section hidden h-full overflow-y-auto">
            <div class="flex-1 p-8">
                <div class="max-w-6xl mx-auto flex gap-8">
                    <!-- Left: Avatar List -->
                    <div class="w-1/3 space-y-6">
                        <div class="flex justify-between items-end">
                            <h1 class="text-2xl font-bold text-white drop-shadow-md">My Avatars</h1>
                            <button class="nav-item bg-emerald-500 hover:bg-emerald-400 text-white px-4 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all shadow-[0_0_15px_rgba(16,185,129,0.3)] border border-emerald-400/50">
                                <i data-lucide="plus" class="w-4 h-4"></i> New
                            </button>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="glass-card rounded-xl p-4 flex gap-4 cursor-pointer hover:bg-emerald-900/10 border-l-4 border-l-emerald-500 transition-all hover:scale-105">
                                <div class="w-14 h-14 rounded-full bg-gray-700 flex-shrink-0 border border-white/10 overflow-hidden">
                                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=CyberAgent" alt="Avatar" class="w-full h-full object-cover" />
                                </div>
                                <div>
                                    <h3 class="font-bold text-white">Cyber Agent 1</h3>
                                    <p class="text-xs text-emerald-400 mt-1 flex items-center gap-1">
                                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span> Ready for Motion
                                    </p>
                                </div>
                            </div>
                            <div class="p-4 bg-white/5 border border-white/5 rounded-xl flex gap-4 cursor-pointer hover:bg-white/10 transition-colors">
                                <div class="w-14 h-14 rounded-full bg-gray-700 flex-shrink-0 opacity-50 overflow-hidden">
                                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Marketing" alt="Avatar" class="w-full h-full object-cover opacity-50" />
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-400">Marketing Bot</h3>
                                    <p class="text-xs text-gray-600 mt-1">Training...</p>
                                </div>
                            </div>
                            <div class="p-4 bg-white/5 border border-white/5 rounded-xl flex gap-4 cursor-pointer hover:bg-white/10 transition-colors">
                                <div class="w-14 h-14 rounded-full bg-gray-700 flex-shrink-0 opacity-50 overflow-hidden">
                                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Support" alt="Avatar" class="w-full h-full object-cover opacity-50" />
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-400">Support Agent</h3>
                                    <p class="text-xs text-gray-600 mt-1">Draft</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: Motion Control Panel -->
                    <div class="flex-1 glass-panel rounded-2xl p-8 border border-white/10 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-teal-500 opacity-50"></div>
                        <div class="mb-6 flex items-center justify-between border-b border-white/5 pb-4">
                            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                                <i data-lucide="clapperboard" class="text-emerald-400"></i> Motion Control Panel
                            </h2>
                            <span class="text-xs bg-emerald-500/10 text-emerald-400 px-3 py-1 rounded-full border border-emerald-500/20 shadow-[0_0_10px_rgba(16,185,129,0.1)]">Active: Cyber Agent 1</span>
                        </div>
                        <div class="space-y-6">
                            <!-- Avatar Image Upload -->
                            <div>
                                <label class="text-sm font-bold text-gray-300 mb-2 block pl-1">Avatar Image</label>
                                <div id="avatar-image-zone" class="border-2 border-dashed border-white/10 rounded-xl p-6 flex flex-col items-center justify-center hover:border-emerald-500/50 hover:bg-emerald-500/5 transition-all cursor-pointer group bg-black/20 relative"
                                     onclick="triggerAvatarImageUpload()"
                                     ondragover="event.preventDefault(); this.classList.add('border-emerald-500/70', 'bg-emerald-500/10');"
                                     ondragleave="this.classList.remove('border-emerald-500/70', 'bg-emerald-500/10');"
                                     ondrop="handleAvatarImageDrop(event)">
                                    <input type="file" id="avatar-image-input" accept="image/*" class="hidden" onchange="handleAvatarImageSelect(event)">
                                    <!-- Placeholder -->
                                    <div id="avatar-image-placeholder" class="flex flex-col items-center">
                                        <div class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center mb-3 group-hover:bg-emerald-500/20 transition-colors">
                                            <i data-lucide="user" class="w-6 h-6 text-gray-400 group-hover:text-emerald-400 transition-colors"></i>
                                        </div>
                                        <span class="text-sm text-gray-300 font-medium">Upload Avatar Image</span>
                                        <span class="text-xs text-gray-500 mt-1">PNG, JPG supported</span>
                                    </div>
                                    <!-- Preview -->
                                    <div id="avatar-image-preview" class="hidden w-full">
                                        <div class="relative">
                                            <img src="" alt="Avatar Preview" class="max-h-32 mx-auto rounded-lg object-contain">
                                            <button onclick="event.stopPropagation(); clearAvatarImage();" class="absolute top-1 right-1 w-6 h-6 bg-red-500/80 hover:bg-red-500 rounded-full flex items-center justify-center text-white text-xs">×</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Script / Prompt -->
                            <div>
                                <label class="text-sm font-bold text-gray-300 mb-2 block pl-1">Script / Prompt</label>
                                <textarea id="avatar-script-input" class="w-full custom-input rounded-xl p-5 h-28 text-sm leading-relaxed resize-none" placeholder="Enter the script or prompt for the avatar..."></textarea>
                            </div>
                            <!-- Voice Input -->
                            <div>
                                <label class="text-sm font-bold text-gray-300 mb-2 block pl-1">Voice Input</label>
                                <div id="avatar-audio-zone" class="border-2 border-dashed border-white/10 rounded-xl p-6 flex flex-col items-center justify-center hover:border-emerald-500/50 hover:bg-emerald-500/5 transition-all cursor-pointer group bg-black/20 relative"
                                     onclick="triggerAvatarAudioUpload()"
                                     ondragover="event.preventDefault(); this.classList.add('border-emerald-500/70', 'bg-emerald-500/10');"
                                     ondragleave="this.classList.remove('border-emerald-500/70', 'bg-emerald-500/10');"
                                     ondrop="handleAvatarAudioDrop(event)">
                                    <input type="file" id="avatar-audio-input" accept="audio/wav,audio/mp3,audio/mpeg,.wav,.mp3" class="hidden" onchange="handleAvatarAudioSelect(event)">
                                    <!-- Placeholder -->
                                    <div id="avatar-audio-placeholder" class="flex flex-col items-center">
                                        <div class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center mb-3 group-hover:bg-emerald-500/20 transition-colors">
                                            <i data-lucide="mic" class="w-6 h-6 text-gray-400 group-hover:text-emerald-400 transition-colors"></i>
                                        </div>
                                        <span class="text-sm text-gray-300 font-medium">Upload Audio or Record</span>
                                        <span class="text-xs text-gray-500 mt-1">MP3, WAV supported (Max 10MB)</span>
                                    </div>
                                    <!-- Preview -->
                                    <div id="avatar-audio-preview" class="hidden w-full text-center">
                                        <div class="flex items-center justify-center gap-3">
                                            <i data-lucide="file-audio" class="w-8 h-8 text-emerald-400"></i>
                                            <span id="avatar-audio-filename" class="text-sm text-gray-300">audio.wav</span>
                                            <button onclick="event.stopPropagation(); clearAvatarAudio();" class="w-6 h-6 bg-red-500/80 hover:bg-red-500 rounded-full flex items-center justify-center text-white text-xs">×</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Status Display -->
                            <div id="avatar-status" class="hidden rounded-xl p-4 text-sm"></div>
                            <!-- Generate Button -->
                            <div class="pt-2 flex justify-end">
                                <button id="avatar-generate-btn" onclick="generateAvatarVideo()" class="nav-item bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-10 py-3.5 rounded-xl font-bold shadow-[0_0_20px_rgba(16,185,129,0.2)] hover:shadow-[0_0_30px_rgba(16,185,129,0.4)] transition-all flex items-center gap-2 border border-white/10 transform hover:-translate-y-1">
                                    <i data-lucide="video" class="w-4 h-4"></i> Generate Video
                                </button>
                            </div>
                            <!-- Result Display -->
                            <div id="avatar-result" class="hidden">
                                <label class="text-sm font-bold text-gray-300 mb-2 block pl-1">Generated Video</label>
                                <video id="avatar-video-player" controls class="w-full rounded-xl bg-black/50"></video>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- ============================================ -->
    <!-- JavaScript Logic                            -->
    <!-- ============================================ -->
    <script>
        // ==========================================
        // 初始化
        // ==========================================
        lucide.createIcons();

        // ==========================================
        // 全域狀態
        // ==========================================
        // API_BASE 已在 config.js 中定義 (支援 Ngrok 自動更新)
        // const API_BASE = 'http://127.0.0.1:5000'; // 舊版硬編碼配置
        let currentTool = 'text_to_image';
        let currentRatio = '1:1';
        let currentBatchSize = 1;
        let uploadedImages = { source: null, target: null, input: null, extra: null };
        let pollingInterval = null;

        // ==========================================
        // 移動端導航控制 (RWD)
        // ==========================================
        function openMobileSidebar() {
            document.getElementById('sidebar').classList.add('mobile-open');
            document.getElementById('mobileOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeMobileSidebar() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            document.getElementById('mobileOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // 工具配置：定義每個工具需要的上傳區域
        const toolConfig = {
            'face_swap': {
                uploads: [
                    { id: 'source', label: 'Source Face', icon: 'user' },
                    { id: 'target', label: 'Target Image', icon: 'image' }
                ],
                color: 'purple'
            },
            'multi_image_blend': {
                uploads: [
                    { id: 'source', label: 'Image A', icon: 'image' },
                    { id: 'target', label: 'Image B', icon: 'image' },
                    { id: 'extra', label: 'Image C', icon: 'image' }
                ],
                color: 'amber'
            },
            'sketch_to_image': {
                uploads: [
                    { id: 'input', label: 'Sketch Input', icon: 'pencil' }
                ],
                color: 'emerald'
            },
            'text_to_image': {
                uploads: [],
                color: 'blue'
            },
            'single_image_edit': {
                uploads: [
                    { id: 'input', label: 'Input Image', icon: 'image' }
                ],
                color: 'pink'
            }
        };

        // ==========================================
        // 導航邏輯
        // ==========================================
        function navigateTo(viewId) {
            console.warn('🔀 [Navigation] 正在切換視圖至:', viewId); // 用於除錯
            console.log('[navigateTo] 被調用！viewId =', viewId);
            console.trace(); // 顯示調用堆疊
            
            // 隱藏所有視圖
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('flex');
            });
            
            // 顯示目標視圖
            const target = document.getElementById(`view-${viewId}`);
            if (target) {
                target.classList.remove('hidden');
                if (viewId === 'dashboard') {
                    target.classList.add('flex');
                }
            }

            // 更新導航狀態
            document.querySelectorAll('.nav-item').forEach(el => {
                if (el.dataset.id === viewId) {
                    el.classList.add('active-nav');
                } else {
                    el.classList.remove('active-nav');
                }
            });

            // 移動端自動關閉側邊欄 (RWD)
            if (window.innerWidth < 768) {
                closeMobileSidebar();
            }
            // 如果切換到 Gallery，自動載入歷史記錄
            if (viewId === 'gallery') {
                loadHistory();
            }

            // 保存當前視圖到 localStorage
            localStorage.setItem('currentView', viewId);

            lucide.createIcons();
        }

        // ==========================================
        // Image Composition 選單控制
        // ==========================================
        function showCompositionMenu() {
            console.log('[showCompositionMenu] 被調用！');
            
            // 切換到 canvas 視圖
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('flex');
            });
            document.getElementById('view-canvas').classList.remove('hidden');

            // 顯示工具選單，隱藏工作區
            document.getElementById('tool-selector-overlay').classList.remove('hidden');
            document.getElementById('studio-workspace').classList.add('hidden');
            document.getElementById('studio-workspace').classList.remove('flex');

            // 更新導航狀態
            document.querySelectorAll('.nav-item').forEach(el => {
                if (el.dataset.id === 'canvas') {
                    el.classList.add('active-nav');
                } else {
                    el.classList.remove('active-nav');
                }
            });

            // 保存當前視圖到 localStorage（防止刷新後跳轉）
            localStorage.setItem('currentView', 'canvas');

            lucide.createIcons();
        }

        function hideCompositionMenu() {
            console.log('[hideCompositionMenu] 被調用！currentTool =', currentTool);
            console.trace(); // 顯示調用堆疊
            
            // 如果沒有選擇過工具，返回 Dashboard
            if (!currentTool) {
                console.log('[hideCompositionMenu] currentTool 為空，跳轉到 Dashboard');
                navigateTo('dashboard');
                return;
            }
            
            // 隱藏選單，顯示工作區
            document.getElementById('tool-selector-overlay').classList.add('hidden');
            document.getElementById('studio-workspace').classList.remove('hidden');
            document.getElementById('studio-workspace').classList.add('flex');
            
            // 保存當前視圖到 localStorage（防止刷新後跳轉）
            localStorage.setItem('currentView', 'canvas');
        }

        // ESC 鍵關閉選單 (只在 overlay 可見時)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('tool-selector-overlay');
                // 只有當 overlay 顯示時才關閉
                if (overlay && !overlay.classList.contains('hidden')) {
                    console.log('[ESC] 按下 ESC 關閉選單');
                    hideCompositionMenu();
                }
            }
        });

        // 點擊背景關閉選單 (移到 DOMContentLoaded 中統一處理)
        // document.getElementById('tool-selector-overlay')?.addEventListener('click', (e) => {
        //     if (e.target.id === 'tool-selector-overlay') {
        //         hideCompositionMenu();
        //     }
        // });

        // ==========================================
        // 工具選擇
        // ==========================================
        const toolInfo = {
            'face_swap': { name: 'Face Swap', desc: '換臉', icon: 'users', color: 'purple' },
            'multi_image_blend': { name: 'Multi-Blend', desc: '多圖融合', icon: 'layers', color: 'amber' },
            'sketch_to_image': { name: 'Sketch to Image', desc: '草稿轉精稿', icon: 'pencil', color: 'emerald' },
            'text_to_image': { name: 'Text to Image', desc: '文生圖', icon: 'type', color: 'blue' },
            'single_image_edit': { name: 'Single Image Edit', desc: '單圖編輯', icon: 'image', color: 'pink' }
        };

        function selectTool(toolId) {
            currentTool = toolId;
            
            // 隱藏工具選單，顯示工作區
            document.getElementById('tool-selector-overlay').classList.add('hidden');
            document.getElementById('studio-workspace').classList.remove('hidden');
            document.getElementById('studio-workspace').classList.add('flex');

            // 更新當前工具標題
            const info = toolInfo[toolId];
            if (info) {
                document.getElementById('current-tool-name').textContent = info.name;
                document.getElementById('current-tool-desc').textContent = info.desc;
                
                const iconContainer = document.getElementById('current-tool-icon');
                iconContainer.className = `p-2 rounded-lg bg-${info.color}-500/20 text-${info.color}-300`;
                iconContainer.innerHTML = `<i data-lucide="${info.icon}" class="w-4 h-4"></i>`;
            }

            // 重新渲染工作區
            renderWorkspace(toolId);
            
            // 保存當前視圖到 localStorage（防止刷新後跳轉）
            localStorage.setItem('currentView', 'canvas');
            
            lucide.createIcons();
        }

        // ==========================================
        // 渲染工作區 (核心函數)
        // ==========================================
        function renderWorkspace(toolId) {
            const config = toolConfig[toolId];
            if (!config) return;

            // 重置上傳圖片狀態
            uploadedImages = { source: null, target: null, input: null, extra: null };

            // 渲染上傳區域
            renderUploadZones(config.uploads, config.color);

            // 重置畫布到 placeholder 狀態
            resetCanvas();

            lucide.createIcons();
        }

        // ==========================================
        // 渲染上傳區域
        // ==========================================
        function renderUploadZones(uploads, color) {
            const container = document.getElementById('upload-zones');
            
            if (uploads.length === 0) {
                container.innerHTML = `
                    <div class="flex-1 flex items-center justify-center text-gray-500 text-sm">
                        <i data-lucide="type" class="w-5 h-5 mr-2"></i>
                        Text-to-Image mode - No image input required
                    </div>
                `;
                container.classList.add('h-12');
                container.classList.remove('h-28');
            } else {
                container.classList.remove('h-12');
                container.classList.add('h-28');
                
                container.innerHTML = uploads.map(upload => `
                    <div id="zone-${upload.id}" 
                         class="upload-zone flex-1 rounded-xl flex flex-col items-center justify-center bg-black/20 relative overflow-hidden"
                         onclick="triggerUpload('${upload.id}')"
                         ondragover="event.preventDefault(); this.classList.add('border-${color}-500/70', 'bg-${color}-500/10')"
                         ondragleave="this.classList.remove('border-${color}-500/70', 'bg-${color}-500/10')"
                         ondrop="handleDrop(event, '${upload.id}')">
                        <input type="file" id="file-${upload.id}" class="hidden" accept="image/*" onchange="handleFileSelect(event, '${upload.id}')" />
                        <div id="preview-${upload.id}" class="hidden absolute inset-0">
                            <img src="" alt="Preview" class="w-full h-full object-cover" />
                            <button onclick="event.stopPropagation(); clearUpload('${upload.id}')" class="absolute top-2 right-2 p-1 bg-black/50 rounded-full hover:bg-red-500/50 transition-colors">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="placeholder-${upload.id}" class="flex flex-col items-center">
                            <i data-lucide="${upload.icon}" class="w-6 h-6 text-gray-500 mb-2"></i>
                            <span class="text-xs uppercase font-bold text-gray-500">${upload.label}</span>
                            <span class="text-[10px] text-gray-600 mt-1">Click or Drop</span>
                        </div>
                    </div>
                `).join('');
            }

            lucide.createIcons();
        }

        // ==========================================
        // 上傳處理函數
        // ==========================================
        function triggerUpload(uploadId) {
            document.getElementById(`file-${uploadId}`).click();
        }

        function handleFileSelect(event, uploadId) {
            const file = event.target.files[0];
            if (file) {
                processUploadedFile(file, uploadId);
            }
        }

        function handleDrop(event, uploadId) {
            event.preventDefault();
            const zone = document.getElementById(`zone-${uploadId}`);
            zone.classList.remove('border-purple-500/70', 'bg-purple-500/10');
            
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                processUploadedFile(file, uploadId);
            }
        }

        function processUploadedFile(file, uploadId) {
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImages[uploadId] = e.target.result;
                
                // 顯示預覽
                const preview = document.getElementById(`preview-${uploadId}`);
                const placeholder = document.getElementById(`placeholder-${uploadId}`);
                const zone = document.getElementById(`zone-${uploadId}`);
                
                preview.querySelector('img').src = e.target.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                zone.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        function clearUpload(uploadId) {
            uploadedImages[uploadId] = null;
            
            const preview = document.getElementById(`preview-${uploadId}`);
            const placeholder = document.getElementById(`placeholder-${uploadId}`);
            const zone = document.getElementById(`zone-${uploadId}`);
            const fileInput = document.getElementById(`file-${uploadId}`);
            
            preview.classList.add('hidden');
            placeholder.classList.remove('hidden');
            zone.classList.remove('has-image');
            fileInput.value = '';
        }

        // ==========================================
        // Avatar Studio 專用處理函數
        // ==========================================
        let avatarImageData = null;  // Base64 image data
        let avatarAudioFile = null;  // File object for upload
        let avatarPollingInterval = null;

        function triggerAvatarImageUpload() {
            document.getElementById('avatar-image-input').click();
        }

        function handleAvatarImageSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                processAvatarImage(file);
            }
        }

        function handleAvatarImageDrop(event) {
            event.preventDefault();
            const zone = document.getElementById('avatar-image-zone');
            zone.classList.remove('border-emerald-500/70', 'bg-emerald-500/10');
            
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                processAvatarImage(file);
            }
        }

        function processAvatarImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                avatarImageData = e.target.result;
                
                const preview = document.getElementById('avatar-image-preview');
                const placeholder = document.getElementById('avatar-image-placeholder');
                
                preview.querySelector('img').src = e.target.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                
                lucide.createIcons();
            };
            reader.readAsDataURL(file);
        }

        function clearAvatarImage() {
            avatarImageData = null;
            document.getElementById('avatar-image-input').value = '';
            document.getElementById('avatar-image-preview').classList.add('hidden');
            document.getElementById('avatar-image-placeholder').classList.remove('hidden');
        }

        function triggerAvatarAudioUpload() {
            document.getElementById('avatar-audio-input').click();
        }

        function handleAvatarAudioSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processAvatarAudio(file);
            }
        }

        function handleAvatarAudioDrop(event) {
            event.preventDefault();
            const zone = document.getElementById('avatar-audio-zone');
            zone.classList.remove('border-emerald-500/70', 'bg-emerald-500/10');
            
            const file = event.dataTransfer.files[0];
            if (file && (file.type.includes('audio') || file.name.match(/\.(wav|mp3)$/i))) {
                processAvatarAudio(file);
            }
        }

        function processAvatarAudio(file) {
            avatarAudioFile = file;
            
            const preview = document.getElementById('avatar-audio-preview');
            const placeholder = document.getElementById('avatar-audio-placeholder');
            const filenameSpan = document.getElementById('avatar-audio-filename');
            
            filenameSpan.textContent = file.name;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            lucide.createIcons();
        }

        function clearAvatarAudio() {
            avatarAudioFile = null;
            document.getElementById('avatar-audio-input').value = '';
            document.getElementById('avatar-audio-preview').classList.add('hidden');
            document.getElementById('avatar-audio-placeholder').classList.remove('hidden');
        }

        function showAvatarStatus(message, type) {
            const statusEl = document.getElementById('avatar-status');
            statusEl.textContent = message;
            statusEl.classList.remove('hidden', 'bg-blue-500/20', 'text-blue-300', 'bg-green-500/20', 'text-green-300', 'bg-red-500/20', 'text-red-300', 'bg-yellow-500/20', 'text-yellow-300');
            
            if (type === 'info') {
                statusEl.classList.add('bg-blue-500/20', 'text-blue-300');
            } else if (type === 'success') {
                statusEl.classList.add('bg-green-500/20', 'text-green-300');
            } else if (type === 'error') {
                statusEl.classList.add('bg-red-500/20', 'text-red-300');
            } else if (type === 'warning') {
                statusEl.classList.add('bg-yellow-500/20', 'text-yellow-300');
            }
        }

        async function generateAvatarVideo() {
            const btn = document.getElementById('avatar-generate-btn');
            const originalHTML = btn.innerHTML;
            const script = document.getElementById('avatar-script-input').value.trim();
            
            // 驗證輸入
            if (!avatarImageData) {
                showAvatarStatus('❌ Please upload an avatar image first', 'error');
                return;
            }
            
            if (!avatarAudioFile && !script) {
                showAvatarStatus('❌ Please upload audio or enter a script', 'error');
                return;
            }

            // 禁用按鈕
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Processing...';
            lucide.createIcons();

            try {
                let audioPath = null;

                // 如果有音訊檔案，先上傳
                if (avatarAudioFile) {
                    showAvatarStatus('📤 Uploading audio file...', 'info');
                    
                    const formData = new FormData();
                    formData.append('file', avatarAudioFile);
                    
                    const uploadResponse = await fetch(`${API_BASE}/api/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error('Audio upload failed');
                    }
                    
                    const uploadData = await uploadResponse.json();
                    audioPath = uploadData.filename || uploadData.path;
                }

                showAvatarStatus('📤 Sending generation request...', 'info');

                // 發送生成請求
                const response = await fetch(`${API_BASE}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        workflow: 'virtual_human',
                        prompt: script || 'Generate talking avatar video',
                        seed: Math.floor(Math.random() * 999999999),
                        images: { avatar: avatarImageData },
                        audio: audioPath
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const jobId = data.job_id;

                showAvatarStatus(`⏳ Job queued: ${jobId.substring(0, 8)}...`, 'info');

                // 開始輪詢狀態
                pollAvatarStatus(jobId, btn, originalHTML);

            } catch (error) {
                console.error('Avatar generation error:', error);
                showAvatarStatus(`❌ Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                lucide.createIcons();
            }
        }

        function pollAvatarStatus(jobId, btn, originalHTML) {
            if (avatarPollingInterval) {
                clearInterval(avatarPollingInterval);
            }

            let pollCount = 0;
            const maxPolls = 450; // 15 分鐘超時 (virtual human video generation takes longer)

            avatarPollingInterval = setInterval(async () => {
                pollCount++;

                if (pollCount > maxPolls) {
                    clearInterval(avatarPollingInterval);
                    showAvatarStatus('⏰ Timeout: Generation took too long', 'warning');
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    lucide.createIcons();
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/status/${jobId}`);
                    if (!response.ok) throw new Error('Status check failed');

                    const data = await response.json();

                    if (data.status === 'processing') {
                        showAvatarStatus(`🔄 Processing... ${data.progress || 0}%`, 'info');
                    } else if (data.status === 'queued') {
                        showAvatarStatus('⏳ Waiting in queue...', 'info');
                    } else if (data.status === 'finished') {
                        clearInterval(avatarPollingInterval);

                        const outputPath = data.image_url || data.output_path;
                        if (outputPath) {
                            const filename = outputPath.split('/').pop().split('\\').pop();
                            const videoUrl = `${API_BASE}/outputs/${filename}`;
                            
                            // 顯示視頻結果
                            const resultDiv = document.getElementById('avatar-result');
                            const videoPlayer = document.getElementById('avatar-video-player');
                            videoPlayer.src = videoUrl;
                            resultDiv.classList.remove('hidden');
                            
                            showAvatarStatus('✅ Video generation complete!', 'success');
                        } else {
                            showAvatarStatus('⚠️ Finished but no video path returned', 'warning');
                        }

                        btn.disabled = false;
                        btn.innerHTML = originalHTML;
                        lucide.createIcons();

                    } else if (data.status === 'failed') {
                        clearInterval(avatarPollingInterval);
                        showAvatarStatus(`❌ Failed: ${data.error || 'Unknown error'}`, 'error');
                        btn.disabled = false;
                        btn.innerHTML = originalHTML;
                        lucide.createIcons();
                    }

                } catch (error) {
                    console.error('Poll error:', error);
                    showAvatarStatus(`🔄 Checking status... (retry ${pollCount})`, 'info');
                }

            }, 2000);
        }

        // ==========================================
        // 畫布控制
        // ==========================================
        function resetCanvas() {
            document.getElementById('canvas-placeholder').classList.remove('hidden');
            document.getElementById('canvas-results').classList.add('hidden');
            document.getElementById('results-grid').innerHTML = '';
        }

        function showResult(imageUrls) {
            // 支援單張或多張圖片
            const urls = Array.isArray(imageUrls) ? imageUrls : [imageUrls];
            const placeholder = document.getElementById('canvas-placeholder');
            const resultsContainer = document.getElementById('canvas-results');
            const resultsGrid = document.getElementById('results-grid');
            
            // 清空之前的結果
            resultsGrid.innerHTML = '';
            
            // 根據圖片數量設定網格
            const count = urls.length;
            if (count === 1) {
                resultsGrid.className = 'grid gap-4 w-full h-full place-items-center grid-cols-1';
            } else if (count === 2) {
                resultsGrid.className = 'grid gap-4 w-full h-full place-items-center grid-cols-2';
            } else {
                resultsGrid.className = 'grid gap-4 w-full h-full place-items-center grid-cols-2 grid-rows-2';
            }
            
            // 生成圖片卡片
            urls.forEach((url, index) => {
                const card = document.createElement('div');
                card.className = 'relative group flex flex-col items-center';
                card.innerHTML = `
                    <div class="relative overflow-hidden rounded-2xl border border-white/10 shadow-2xl">
                        <img src="${url}" alt="Generated Image ${index + 1}" 
                             class="max-w-full max-h-[60vh] object-contain" 
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 fill=%22gray%22>載入失敗</text></svg>'" />
                        <!-- 懸停時顯示下載按鈕 -->
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <button onclick="downloadImage('${url}', ${index + 1})" 
                                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl font-bold text-white flex items-center gap-2 hover:brightness-110 transition-all shadow-lg">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                <span>下載圖片</span>
                            </button>
                        </div>
                    </div>
                    <span class="text-xs text-gray-500 mt-2">Image ${index + 1}</span>
                `;
                resultsGrid.appendChild(card);
            });
            
            // 顯示結果，隱藏 placeholder
            placeholder.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            
            // 重新初始化圖示
            lucide.createIcons();
        }
        
        // 下載圖片函數
        function downloadImage(url, index) {
            const link = document.createElement('a');
            link.href = url;
            link.download = `generated_image_${index}_${Date.now()}.png`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus(`✅ 圖片 ${index} 下載中...`, 'success');
        }

        // ==========================================
        // Aspect Ratio 控制
        // ==========================================
        function updateAspectRatio(ratio) {
            currentRatio = ratio;
            
            document.querySelectorAll('.ratio-btn').forEach(btn => {
                if (btn.dataset.ratio === ratio) {
                    btn.classList.add('active');
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('text-white');
                } else {
                    btn.classList.remove('active', 'text-white');
                    btn.classList.add('text-gray-400');
                }
            });
        }

        // ==========================================
        // Batch Size 控制
        // ==========================================
        function setBatchSize(size) {
            currentBatchSize = size;
            
            document.querySelectorAll('.batch-btn').forEach(btn => {
                if (parseInt(btn.dataset.batch) === size) {
                    btn.classList.remove('bg-black/30', 'border-white/10', 'text-gray-400');
                    btn.classList.add('bg-purple-500/20', 'border-purple-500/50', 'text-white');
                } else {
                    btn.classList.add('bg-black/30', 'border-white/10', 'text-gray-400');
                    btn.classList.remove('bg-purple-500/20', 'border-purple-500/50', 'text-white');
                }
            });
        }

        // ==========================================
        // Prompt 優化
        // ==========================================
        async function enhancePrompt() {
            const promptInput = document.getElementById('prompt-input');
            const btn = document.getElementById('btn-enhance');
            const originalPrompt = promptInput.value.trim();
            
            if (!originalPrompt) {
                showStatus('⚠️ 請先輸入 Prompt', 'warning');
                return;
            }

            // 顯示載入狀態
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>';
            lucide.createIcons();

            try {
                // TODO [Day 8]: 呼叫後端 AI 優化 API - POST /api/enhance-prompt
                console.log('[Enhance] 🔮 Prompt 優化功能 - 準備中 (Day 8 實作)');
                console.log('[Enhance] 原始 Prompt:', originalPrompt);
                
                // 目前使用模擬優化
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 模擬優化結果 (實際應呼叫 /api/enhance-prompt)
                const enhanced = `${originalPrompt}, highly detailed, 8k resolution, cinematic lighting, professional photography, masterpiece`;
                promptInput.value = enhanced;
                
                console.log('[Enhance] 優化後 Prompt:', enhanced);
                showStatus('✨ Prompt 已優化', 'success');
            } catch (error) {
                showStatus('❌ 優化失敗', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                lucide.createIcons();
            }
        }

        // ==========================================
        // 生成處理
        // ==========================================
        async function handleGenerate(event) {
            // 阻止任何預設行為
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
            }
            
            console.log('[Generate] 開始處理...');
            
            // 檢查是否已選擇工具
            if (!currentTool) {
                showStatus('⚠️ 請先選擇一個工具', 'warning');
                return Promise.reject('No tool selected');
            }
            
            const btn = document.getElementById('btn-generate');
            if (!btn) {
                console.error('[Generate] 找不到 Generate 按鈕');
                return Promise.reject('Button not found');
            }
            
            const statusDiv = document.getElementById('status-message');
            const promptInput = document.getElementById('prompt-input');
            const seedInput = document.getElementById('seed-input');
            const modelSelect = document.getElementById('model-select');
            
            const prompt = promptInput ? promptInput.value.trim() : '';
            const seed = seedInput ? (parseInt(seedInput.value) || -1) : -1;
            const model = modelSelect ? modelSelect.value : 'turbo_fp8';

            // 驗證輸入
            if (!prompt && currentTool === 'text_to_image') {
                showStatus('⚠️ Please enter a prompt', 'warning');
                return Promise.reject('No prompt');
            }

            // 驗證圖片上傳
            const config = toolConfig[currentTool];
            if (config && config.uploads) {
                for (const upload of config.uploads) {
                    if (!uploadedImages[upload.id]) {
                        showStatus(`⚠️ Please upload ${upload.label}`, 'warning');
                        return Promise.reject('Missing image upload');
                    }
                }
            }

            // 禁用按鈕並顯示載入狀態
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed');
            btn.innerHTML = `
                <div class="flex gap-1 items-center">
                    <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
                <span>Processing...</span>
            `;

            showStatus('📤 Sending request...', 'info');

            try {
                // 發送 API 請求
                const response = await fetch(`${API_BASE}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        workflow: currentTool,
                        prompt: prompt,
                        seed: seed,
                        model: model,
                        aspect_ratio: currentRatio,
                        batch_size: currentBatchSize,
                        images: uploadedImages
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const jobId = data.job_id;

                showStatus(`⏳ Job queued: ${jobId.substring(0, 8)}...`, 'info');

                // 開始輪詢狀態
                pollStatus(jobId, btn, originalHTML);

            } catch (error) {
                console.error('Generate error:', error);
                showStatus(`❌ Error: ${error.message}`, 'error');
                restoreButton(btn, originalHTML);
                return Promise.reject(error);
            }
            
            return Promise.resolve();
        }

        // ==========================================
        // 狀態輪詢
        // ==========================================
        function pollStatus(jobId, btn, originalHTML) {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            let pollCount = 0;
            const maxPolls = 450; // 15 分鐘超時 (increased for complex workflows)

            pollingInterval = setInterval(async () => {
                pollCount++;

                if (pollCount > maxPolls) {
                    clearInterval(pollingInterval);
                    showStatus('⏰ Timeout: Generation took too long', 'warning');
                    restoreButton(btn, originalHTML);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/status/${jobId}`);
                    if (!response.ok) throw new Error('Status check failed');

                    const data = await response.json();

                    if (data.status === 'processing') {
                        showStatus(`🔄 Processing... ${data.progress || 0}%`, 'info');
                    } else if (data.status === 'queued') {
                        showStatus('⏳ Waiting in queue...', 'info');
                    } else if (data.status === 'finished') {
                        clearInterval(pollingInterval);

                        const outputPath = data.image_url || data.output_path;
                        if (outputPath) {
                            const filename = outputPath.split('/').pop().split('\\').pop();
                            showResult(`${API_BASE}/outputs/${filename}`);
                            showStatus('✅ Generation complete!', 'success');
                        } else {
                            showStatus('⚠️ Finished but no image path returned', 'warning');
                        }

                        restoreButton(btn, originalHTML);

                    } else if (data.status === 'failed') {
                        clearInterval(pollingInterval);
                        showStatus(`❌ Failed: ${data.error || 'Unknown error'}`, 'error');
                        restoreButton(btn, originalHTML);
                    }

                } catch (error) {
                    console.error('Poll error:', error);
                    showStatus(`🔄 Checking status... (retry ${pollCount})`, 'info');
                }

            }, 2000);
        }

        // ==========================================
        // 輔助函數
        // ==========================================
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden', 'text-gray-400', 'text-amber-400', 'text-red-400', 'text-green-400');
            
            switch (type) {
                case 'warning':
                    statusDiv.classList.add('text-amber-400');
                    break;
                case 'error':
                    statusDiv.classList.add('text-red-400');
                    break;
                case 'success':
                    statusDiv.classList.add('text-green-400');
                    break;
                default:
                    statusDiv.classList.add('text-gray-400');
            }
        }

        function restoreButton(btn, originalHTML) {
            btn.disabled = false;
            btn.classList.remove('opacity-70', 'cursor-not-allowed');
            btn.innerHTML = originalHTML;
            lucide.createIcons();
        }

        // ==========================================
        // 動態載入模型列表
        // ==========================================
        async function fetchModels() {
            const modelSelect = document.getElementById('model-select');
            if (!modelSelect) return;
            
            try {
                console.log('[Models] 開始獲取模型列表...');
                const response = await fetch(`${API_BASE}/api/models`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('[Models] 獲取成功:', data);
                
                // 清空現有選項
                modelSelect.innerHTML = '';
                
                // 優先使用 UNET 模型
                const unetModels = data.unet_models || [];
                const checkpointModels = data.models || [];
                
                // 添加 UNET 模型
                if (unetModels.length > 0) {
                    const unetGroup = document.createElement('optgroup');
                    unetGroup.label = 'UNET Models';
                    unetModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model.split('/').pop().replace('.safetensors', '');
                        unetGroup.appendChild(option);
                    });
                    modelSelect.appendChild(unetGroup);
                }
                
                // 添加 Checkpoint 模型
                if (checkpointModels.length > 0) {
                    const ckptGroup = document.createElement('optgroup');
                    ckptGroup.label = 'Checkpoint Models';
                    checkpointModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model.replace('.safetensors', '').replace('.ckpt', '');
                        ckptGroup.appendChild(option);
                    });
                    modelSelect.appendChild(ckptGroup);
                }
                
                console.log(`[Models] 已載入 ${unetModels.length} 個 UNET 模型, ${checkpointModels.length} 個 Checkpoint 模型`);
                
            } catch (error) {
                console.error('[Models] 載入失敗:', error);
                // Fallback: 添加預設選項
                modelSelect.innerHTML = '<option value="turbo_fp8">Default (Z-Image Turbo)</option>';
                showStatus('⚠️ 無法載入模型列表，使用預設模型', 'warning');
            }
        }

        // ==========================================
        // Personal Gallery 功能
        // ==========================================
        
        /**
         * 載入歷史記錄並渲染 Gallery
         */
        async function loadHistory() {
            const galleryGrid = document.getElementById('gallery-grid');
            
            // 顯示 Loading 狀態
            galleryGrid.innerHTML = `
                <div class="col-span-full text-center py-12 text-gray-500">
                    <i data-lucide="loader" class="w-8 h-8 mx-auto mb-4 animate-spin"></i>
                    <p>載入歷史記錄中...</p>
                </div>
            `;
            lucide.createIcons();
            
            try {
                const response = await fetch(`${API_BASE}/api/history?limit=50&offset=0`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const jobs = data.jobs || [];
                
                console.log('[Gallery] 載入歷史記錄:', jobs.length, '筆');
                console.log('[Gallery] API Response:', data); // 除錯用
                
                if (jobs.length === 0) {
                    galleryGrid.innerHTML = `
                        <div class="col-span-full text-center py-20 text-gray-500">
                            <i data-lucide="image-off" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                            <p class="text-lg">目前沒有任何創作記錄</p>
                            <p class="text-sm mt-2">開始您的第一個創作吧！</p>
                        </div>
                    `;
                } else {
                    renderGalleryItems(jobs);
                }
                
                lucide.createIcons();
            } catch (error) {
                console.error('[Gallery] 載入失敗:', error);
                galleryGrid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-red-400">
                        <i data-lucide="alert-circle" class="w-8 h-8 mx-auto mb-4"></i>
                        <p>載入失敗: ${error.message}</p>
                        <button onclick="loadHistory()" class="mt-4 px-4 py-2 glass-card rounded-lg hover:bg-white/10">
                            重試
                        </button>
                    </div>
                `;
                lucide.createIcons();
            }
        }
        
        /**
         * 渲染 Gallery 項目
         */
        function renderGalleryItems(jobs) {
            const galleryGrid = document.getElementById('gallery-grid');
            
            const htmlItems = jobs.map(job => {
                // 處理 output_path: 可能是 "/outputs/xxx.png" 或 "/outputs/xxx.png,/outputs/yyy.png"
                const outputPaths = job.output_path ? job.output_path.split(',').map(p => p.trim()).filter(p => p) : [];
                // 取第一張圖作為縮圖，並轉換為完整 URL
                const firstImage = outputPaths[0] ? `${API_BASE}${outputPaths[0]}` : '';
                const imageCount = outputPaths.length;
                
                const date = job.created_at ? new Date(job.created_at).toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '未知時間';
                
                const statusColors = {
                    'finished': 'bg-green-500/20 text-green-300 border-green-500/50',
                    'failed': 'bg-red-500/20 text-red-300 border-red-500/50',
                    'processing': 'bg-yellow-500/20 text-yellow-300 border-yellow-500/50',
                    'queued': 'bg-blue-500/20 text-blue-300 border-blue-500/50',
                    'cancelled': 'bg-gray-500/20 text-gray-300 border-gray-500/50'
                };
                const statusClass = statusColors[job.status] || 'bg-gray-500/20 text-gray-300';
                
                return `
                    <div class="glass-card rounded-xl overflow-hidden group hover:scale-105 transition-transform cursor-pointer">
                        <div class="relative aspect-video bg-black/40 overflow-hidden">
                            ${firstImage ? `
                                <img src="${firstImage}" alt="Generated" loading="lazy"
                                     class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" 
                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'200\\' height=\\'200\\'%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' fill=\\'gray\\'%3E載入失敗%3C/text%3E%3C/svg%3E'" />
                            ` : `
                                <div class="w-full h-full flex items-center justify-center text-gray-600">
                                    <i data-lucide="image-off" class="w-8 h-8"></i>
                                </div>
                            `}
                            ${imageCount > 1 ? `
                                <div class="absolute top-2 right-2 bg-black/70 backdrop-blur-sm px-2 py-1 rounded-lg text-xs font-medium">
                                    <i data-lucide="images" class="w-3 h-3 inline mr-1"></i>
                                    ${imageCount}
                                </div>
                            ` : ''}
                            <div class="absolute top-2 left-2 ${statusClass} px-2 py-1 rounded-lg text-xs font-medium border">
                                ${job.status}
                            </div>
                        </div>
                        <div class="p-4">
                            <p class="text-sm text-white font-medium mb-2 line-clamp-2 min-h-[2.5rem]">
                                ${job.prompt || '(無提示詞)'}
                            </p>
                            <div class="flex items-center gap-2 text-xs text-gray-500 mb-3">
                                <span class="px-2 py-0.5 bg-white/5 rounded">${job.workflow}</span>
                                <span class="px-2 py-0.5 bg-white/5 rounded">${job.aspect_ratio || '1:1'}</span>
                            </div>
                            <div class="text-xs text-gray-600 mb-3">${date}</div>
                            <div class="flex gap-2">
                                <button onclick='remixJob(${JSON.stringify(job).replace(/'/g, "&#39;")})' 
                                        class="flex-1 glass-card px-3 py-2 rounded-lg text-sm hover:bg-purple-500/20 hover:border-purple-500/50 border border-white/10 flex items-center justify-center gap-2">
                                    <i data-lucide="repeat" class="w-4 h-4"></i>
                                    Remix
                                </button>
                                ${firstImage ? `
                                    <a href="${firstImage}" download 
                                       class="glass-card px-3 py-2 rounded-lg text-sm hover:bg-white/10 border border-white/10 flex items-center justify-center"
                                       onclick="event.stopPropagation()">
                                        <i data-lucide="download" class="w-4 h-4"></i>
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            galleryGrid.innerHTML = htmlItems;
            lucide.createIcons();
        }
        
        /**
         * Remix 功能
         */
        function remixJob(jobData) {
            console.log('[Gallery] Remix Job:', jobData);
            
            showCompositionMenu();
            setTimeout(() => {
                const toolMapping = {
                    'text_to_image': 'text_to_image',
                    'face_swap': 'face_swap',
                    'multi_image_blend': 'multi_blend',
                    'sketch_to_image': 'sketch',
                    'single_image_edit': 'single_edit'
                };
                const toolId = toolMapping[jobData.workflow] || 'text_to_image';
                selectTool(toolId);
                
                setTimeout(() => {
                    const promptInput = document.getElementById('prompt-input');
                    if (promptInput && jobData.prompt) promptInput.value = jobData.prompt;
                    
                    const seedInput = document.getElementById('seed-input');
                    if (seedInput && jobData.seed !== undefined) seedInput.value = jobData.seed;
                    
                    const modelSelect = document.getElementById('model-select');
                    if (modelSelect && jobData.model) modelSelect.value = jobData.model;
                    
                    if (jobData.aspect_ratio) {
                        const ratioButtons = document.querySelectorAll('.ratio-btn');
                        ratioButtons.forEach(btn => {
                            if (btn.dataset.ratio === jobData.aspect_ratio) btn.click();
                        });
                    }
                    
                    console.log('[Gallery] Remix 參數已填充');
                }, 300);
            }, 300);
        }

        // ==========================================
        // System HUD Monitoring (輪詢 /api/metrics)
        // ==========================================
        async function updateSystemMetrics() {
            try {
                const response = await fetch(`${API_BASE}/api/metrics`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // 更新 Server 狀態 (假設能收到回應就是 online)
                document.getElementById('server-status-indicator').className = 'w-3 h-3 rounded-full bg-green-500 shadow-lg shadow-green-500/50 animate-pulse';
                document.getElementById('server-status-text').textContent = 'ONLINE';
                document.getElementById('server-status-text').className = 'text-sm font-bold text-green-400';
                
                // 更新 Worker 狀態
                const workerOnline = data.worker_status === 'online';
                const workerIndicator = document.getElementById('worker-status-indicator');
                const workerText = document.getElementById('worker-status-text');
                
                if (workerOnline) {
                    workerIndicator.className = 'w-3 h-3 rounded-full bg-green-500 shadow-lg shadow-green-500/50 animate-pulse';
                    workerText.textContent = 'ONLINE';
                    workerText.className = 'text-sm font-bold text-green-400';
                } else {
                    workerIndicator.className = 'w-3 h-3 rounded-full bg-red-500 shadow-lg shadow-red-500/50';
                    workerText.textContent = 'DISCONNECTED';
                    workerText.className = 'text-sm font-bold text-red-400';
                }
                
                // 更新 Queue 數量
                document.getElementById('queue-count').textContent = data.queue_length || 0;
                
            } catch (error) {
                console.error('[HUD] 無法獲取系統指標:', error);
                
                // 設置為離線狀態
                document.getElementById('server-status-indicator').className = 'w-3 h-3 rounded-full bg-red-500';
                document.getElementById('server-status-text').textContent = 'OFFLINE';
                document.getElementById('server-status-text').className = 'text-sm font-bold text-red-400';
                
                document.getElementById('worker-status-indicator').className = 'w-3 h-3 rounded-full bg-red-500';
                document.getElementById('worker-status-text').textContent = 'DISCONNECTED';
                document.getElementById('worker-status-text').className = 'text-sm font-bold text-red-400';
            }
        }

        // ==========================================
        // 頁面載入完成後初始化
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Init] 頁面載入完成');
            lucide.createIcons();
            
            // 初始狀態
            currentTool = null;
            
            // 載入模型列表
            fetchModels();
            
            // 啟動系統監控輪詢 (每 5 秒更新一次)
            updateSystemMetrics();  // 立即執行一次
            setInterval(updateSystemMetrics, 5000);
            console.log('[HUD] 系統監控已啟動 (5秒輪詢)');
            
            // 防止重複點擊的標記
            let isGenerating = false;
            
            // 使用事件委派 - 綁定到 document (使用 capture 模式)
            document.addEventListener('click', function(e) {
                // 1. Generate 按鈕攔截 (最高優先級)
                const genBtn = e.target.closest('#btn-generate');
                if (genBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    // 防止重複觸發
                    if (isGenerating) {
                        console.log('[Generate] 已在處理中，忽略重複點擊');
                        return false;
                    }
                    
                    // 雙重保險：如果按鈕已經 disable，不要再觸發
                    if (genBtn.disabled || genBtn.classList.contains('cursor-not-allowed')) {
                        console.log('[Generate] 按鈕禁用中，忽略點擊');
                        return false;
                    }

                    console.log('[Generate] 按鈕被點擊');
                    isGenerating = true;
                    handleGenerate(e).finally(() => {
                        // 任務完成或失敗後，重置標記
                        setTimeout(() => { isGenerating = false; }, 500);
                    });
                    return false;
                }
                
                // 2. Enhance 按鈕
                if (e.target.closest('#btn-enhance')) {
                    e.preventDefault();
                    e.stopPropagation();
                    enhancePrompt();
                    return false;
                }
                
                // 3. Tool Selector Overlay 背景點擊
                // 確保只在點擊 overlay 本體時觸發，而不是子元素
                const overlay = document.getElementById('tool-selector-overlay');
                if (e.target === overlay) {
                    console.log('[Overlay] 點擊背景，關閉選單');
                    hideCompositionMenu();
                    return;
                }
            });
            
            // 防止表單誤送 (如果有意外包裹的 form)
            document.addEventListener('submit', function(e) {
                e.preventDefault();
                console.warn('⚠️ [Form] 攔截到表單提交，已阻止');
                return false;
            });
            
            console.log('[Init] 事件委派已設定');

            // ==========================================
            // 恢復上次的視圖狀態
            // ==========================================
            const savedView = localStorage.getItem('currentView');
            if (savedView && savedView !== 'dashboard') {
                console.log('[Init] 恢復上次視圖:', savedView);
                navigateTo(savedView);
            } else {
                console.log('[Init] 顯示預設 Dashboard');
                // 確保 Dashboard 為預設顯示
                navigateTo('dashboard');
            }
        });
    </script>
</body>
</html>
