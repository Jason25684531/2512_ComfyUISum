<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIGEN.IO - Creative Studio</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- API Configuration -->
    <script src="config.js"></script>
    <!-- Google Fonts - Orbitron (Tech/Futuristic Font) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <style>
        /* Hide Scrollbar */
        ::-webkit-scrollbar {
            display: none;
        }

        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animations */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Glass Effects */
        .glass-sidebar {
            background: rgba(5, 5, 8, 0.7);
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-card {
            background: rgba(10, 10, 15, 0.5);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .glass-card:hover {
            background: rgba(20, 20, 30, 0.6);
            border-color: rgba(168, 85, 247, 0.5);
            transform: translateY(-4px);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.8), 0 0 20px rgba(168, 85, 247, 0.2);
        }

        /* Tool Icon Styles */
        .tool-icon {
            transition: all 0.3s ease;
        }

        .tool-icon:hover {
            transform: scale(1.05);
        }

        /* Nav Item */
        .nav-item {
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            right: 0;
            top: 20%;
            bottom: 20%;
            width: 3px;
            background: #a78bfa;
            border-radius: 4px 0 0 4px;
            box-shadow: 0 0 10px #a78bfa;
        }

        .nav-item.active {
            background: rgba(168, 85, 247, 0.15);
            color: #a78bfa;
        }

        /* Background Image */
        .bg-image {
            background-image: url('image/BG_v02.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* Status Indicator */
        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .status-dot {
            animation: pulse-dot 2s infinite;
        }

        /* Neon Stroke Flow Animation */
        @keyframes neon-stroke-flow {
            0% {
                filter:
                    drop-shadow(0 0 5px #a855f7) drop-shadow(0 0 10px #a855f7) drop-shadow(0 0 15px #7c3aed);
                -webkit-text-stroke-color: #f3c8ff;
            }

            25% {
                filter:
                    drop-shadow(0 0 8px #c084fc) drop-shadow(0 0 15px #a855f7) drop-shadow(0 0 20px #7c3aed);
                -webkit-text-stroke-color: #e9d5ff;
            }

            50% {
                filter:
                    drop-shadow(0 0 10px #e9d5ff) drop-shadow(0 0 20px #c084fc) drop-shadow(0 0 25px #a855f7);
                -webkit-text-stroke-color: #fae8ff;
            }

            75% {
                filter:
                    drop-shadow(0 0 8px #c084fc) drop-shadow(0 0 15px #a855f7) drop-shadow(0 0 20px #7c3aed);
                -webkit-text-stroke-color: #e9d5ff;
            }

            100% {
                filter:
                    drop-shadow(0 0 5px #a855f7) drop-shadow(0 0 10px #a855f7) drop-shadow(0 0 15px #7c3aed);
                -webkit-text-stroke-color: #f3c8ff;
            }
        }

        .neon-title {
            animation: neon-stroke-flow 4s ease-in-out infinite;
        }

        /* Glass Panel (from old dashboard) */
        .glass-panel {
            background: rgba(5, 5, 8, 0.85);
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed rgba(255, 255, 255, 0.15);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-zone:hover {
            border-color: rgba(168, 85, 247, 0.5);
            background: rgba(168, 85, 247, 0.05);
        }

        .upload-zone.has-image {
            border-style: solid;
            border-color: rgba(168, 85, 247, 0.4);
        }

        /* Aspect Ratio Button */
        .ratio-btn {
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ratio-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .ratio-btn.active {
            border-color: rgba(168, 85, 247, 0.8);
            background: rgba(168, 85, 247, 0.15);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.2);
        }

        /* Grid Background Pattern */
        .grid-bg {
            background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Tool Card */
        .tool-card {
            transition: all 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.8);
        }

        /* Custom Input */
        .custom-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        .custom-input:focus {
            outline: none;
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.1);
        }

        /* Overlay Backdrop */
        .overlay-backdrop {
            animation: overlay-fade-in 0.2s ease-out;
        }

        @keyframes overlay-fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="h-screen w-full flex overflow-hidden bg-[#020205] text-white font-sans selection:bg-purple-500/30">

    <!-- Background Layer (Home Layout Only) -->
    <div id="home-bg-layer" class="fixed inset-0 z-0 pointer-events-none">
        <!-- Background Image -->
        <div class="absolute inset-0 bg-image"></div>
        <!-- Gradient Overlay -->
        <div class="absolute inset-0 bg-gradient-to-b from-[#020205]/0 via-[#020205]/90 to-[#020205]/100"></div>
        <!-- Noise Texture -->
        <div
            class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-40 mix-blend-overlay">
        </div>
    </div>

    <!-- Left Sidebar (Wide with Labels - Home Layout) -->
    <aside id="home-sidebar"
        class="w-64 flex-shrink-0 glass-panel flex flex-col border-r border-white/5 h-full z-30 relative bg-[#0b0c15]/80">
        <!-- Logo -->
        <div class="h-20 flex items-center px-6 border-b border-white/5 cursor-pointer"
            onclick="navigateTo('dashboard')">
            <div class="flex items-center gap-2 group">
                <div
                    class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-600 to-indigo-800 flex items-center justify-center shadow-lg border border-white/20 relative overflow-hidden group-hover:border-purple-500/50 transition-colors">
                    <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/20 to-transparent"></div>
                    <i data-lucide="sparkles" class="text-white w-5 h-5 z-10"></i>
                </div>
                <span
                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white via-gray-200 to-gray-500 drop-shadow-sm tracking-tight group-hover:text-white transition-colors">
                    AIGEN.IO
                </span>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-2">
            <div class="px-3 mb-3 text-xs font-bold text-gray-500 uppercase tracking-wider">Core Tools</div>

            <button onclick="navigateTo('dashboard')"
                class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item hover:bg-white/5 hover:text-white transition-all active"
                data-id="dashboard">
                <i data-lucide="home" class="w-5 h-5 group-hover:text-blue-300"></i>
                Dashboard
            </button>

            <button onclick="showCompositionMenu()"
                class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item hover:bg-white/5 hover:text-white transition-all"
                data-id="canvas">
                <i data-lucide="layers" class="w-5 h-5 group-hover:text-purple-300"></i>
                Image Composition
            </button>

            <button onclick="navigateTo('motion'); showVideoToolMenu();"
                class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item hover:bg-white/5 hover:text-white transition-all"
                data-id="motion">
                <i data-lucide="film" class="w-5 h-5 group-hover:text-amber-300"></i>
                Image to Video
            </button>

            <button onclick="navigateTo('avatar')"
                class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item hover:bg-white/5 hover:text-white transition-all"
                data-id="avatar">
                <i data-lucide="user-circle-2" class="w-5 h-5 group-hover:text-emerald-300"></i>
                Avatar Studio
            </button>

            <div class="my-4 border-t border-white/5 mx-3"></div>

            <button onclick="navigateTo('gallery')"
                class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item hover:bg-white/5 hover:text-white transition-all"
                data-id="gallery">
                <i data-lucide="image" class="w-5 h-5 group-hover:text-pink-300"></i>
                Personal Gallery
            </button>
        </nav>

        <!-- Bottom: System Status -->
        <div class="p-4 border-t border-white/5">
            <div id="system-status"
                class="flex items-center gap-3 p-3 rounded-xl bg-white/5 cursor-pointer hover:bg-white/10 transition-colors"
                title="System Status">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 status-dot"></div>
                </div>
                <i data-lucide="activity" class="w-5 h-5 text-gray-400"></i>
                <span class="text-xs text-gray-400">System Online</span>
            </div>
        </div>

        <!-- User Profile (Bottom) -->
        <div class="p-4 border-t border-white/5">
            <!-- Guest State -->
            <a id="auth-guest" href="/login.html"
                class="hidden flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                <i data-lucide="log-in" class="w-5 h-5"></i>
                <span class="text-sm font-medium">登入 / 註冊</span>
            </a>

            <!-- User State -->
            <a id="auth-user" href="/profile.html"
                class="hidden flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 transition-all group">
                <div
                    class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 border border-white/20 flex items-center justify-center group-hover:border-purple-500/50 transition-colors">
                    <i data-lucide="user" class="w-5 h-5 text-white"></i>
                </div>
                <div class="flex-1">
                    <span id="sidebar-user-name"
                        class="text-sm font-medium text-gray-300 group-hover:text-white transition-colors block">會員中心</span>
                    <span class="text-xs text-gray-500">管理個人資料</span>
                </div>
            </a>
        </div>
    </aside>

    <!-- Workspace User Interface (Full Layout) -->
    <div id="workspace-wrapper" class="hidden fixed inset-0 z-50 flex bg-[#0b0c15]">

        <!-- Workspace Sidebar -->
        <aside id="workspace-sidebar"
            class="w-64 flex-shrink-0 glass-panel flex flex-col border-r border-white/5 bg-[#0b0c15]">
            <!-- Logo -->
            <div class="h-20 flex items-center px-6 border-b border-white/5 cursor-pointer"
                onclick="navigateTo('dashboard')">
                <div class="flex items-center gap-2 group">
                    <div
                        class="w-8 h-8 rounded-lg bg-gradient-to-br from-slate-700 to-slate-900 flex items-center justify-center shadow-[0_2px_10px_rgba(0,0,0,0.5)] border border-white/20 relative overflow-hidden group-hover:border-purple-500/50 transition-colors">
                        <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/20 to-transparent">
                        </div>
                        <i data-lucide="sparkles" class="text-white w-4 h-4 z-10"></i>
                    </div>
                    <span
                        class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white via-gray-200 to-gray-500 drop-shadow-sm tracking-tight group-hover:text-white transition-colors">
                        AIGEN.IO
                    </span>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-2">
                <div class="px-3 mb-3 text-xs font-bold text-gray-500 uppercase tracking-wider">Core Tools</div>

                <button onclick="showCompositionMenu()"
                    class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item hover:bg-white/5 hover:text-white transition-all"
                    data-id="canvas">
                    <i data-lucide="layers" class="w-5 h-5 group-hover:text-purple-300"></i>
                    Image Composition
                </button>

                <button onclick="navigateTo('motion'); showVideoToolMenu();"
                    class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item hover:bg-white/5 hover:text-white transition-all"
                    data-id="motion">
                    <i data-lucide="film" class="w-5 h-5 group-hover:text-amber-300"></i>
                    Image to Video
                </button>

                <button onclick="navigateTo('avatar')"
                    class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item hover:bg-white/5 hover:text-white transition-all"
                    data-id="avatar">
                    <i data-lucide="user-circle-2" class="w-5 h-5 group-hover:text-emerald-300"></i>
                    Avatar Studio
                </button>

                <div class="my-4 border-t border-white/5 mx-3"></div>

                <button onclick="navigateTo('dashboard')"
                    class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item hover:bg-white/5 hover:text-white transition-all">
                    <i data-lucide="layout-grid" class="w-5 h-5 group-hover:text-blue-300"></i>
                    Dashboard
                </button>

                <button onclick="navigateTo('gallery')"
                    class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium text-gray-400 group nav-item hover:bg-white/5 hover:text-white transition-all"
                    data-id="gallery">
                    <i data-lucide="image" class="w-5 h-5 group-hover:text-pink-300"></i>
                    Personal Gallery
                </button>
            </nav>
        </aside>

        <!-- Workspace Content Container (Views will be moved here by JS) -->
        <main id="workspace-content" class="flex-1 relative h-full bg-[#020205] overflow-hidden"></main>
    </div>

    <!-- Main Content Area -->
    <main id="home-main" class="flex-1 h-full flex flex-col overflow-hidden relative z-10">

        <!-- Top Bar -->
        <header class="h-20 flex-shrink-0 flex items-center justify-end px-10 relative">

            <!-- Top Right: User Info -->
            <div id="top-right-auth">
                <!-- Guest -->
                <a id="topbar-guest" href="/login.html"
                    class="hidden items-center gap-2 px-5 py-2.5 rounded-xl bg-white/10 backdrop-blur-md border border-white/20 text-white text-sm font-medium hover:bg-white/20 hover:border-purple-500/50 transition-all">
                    <i data-lucide="log-in" class="w-4 h-4"></i>
                    <span>登入 / 註冊</span>
                </a>

                <!-- User -->
                <a id="topbar-user" href="/profile.html"
                    class="hidden items-center gap-3 px-4 py-2.5 rounded-xl bg-white/5 backdrop-blur-md border border-white/10 hover:bg-white/10 hover:border-purple-500/30 transition-all group">
                    <div
                        class="w-8 h-8 rounded-full bg-gradient-to-b from-purple-500 to-purple-800 border border-white/20 flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                    </div>
                    <span id="topbar-user-name"
                        class="text-sm font-medium text-gray-300 group-hover:text-white transition-colors">會員中心</span>
                    <i data-lucide="chevron-right"
                        class="w-4 h-4 text-gray-500 group-hover:text-purple-400 transition-colors"></i>
                </a>
            </div>
        </header>

        <!-- Main Content: Tool Grid -->
        <div class="flex-1 overflow-y-auto px-10 pb-10 flex flex-col items-center justify-center pt-80">
            <div class="max-w-7xl mx-auto w-full text-center">

                <!-- Neon Title - Centered (Outline Style) -->
                <h1 class="text-7xl md:text-9xl lg:text-9xl font-bold mb-20 animate-fade-in neon-title"
                    style="font-family: 'Orbitron', sans-serif; -webkit-text-stroke: 2px #f3c8ff; color: transparent; transform: skewX(-10deg); letter-spacing: 0.05em;">
                    Let's Create
                </h1>

                <!-- Dashboard View -->
                <div id="view-dashboard" class="animate-fade-in">
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-10">



                        <!-- Image Composition -->
                        <button onclick="showCompositionMenu()"
                            class="tool-icon glass-card rounded-2xl p-8 flex flex-col items-center justify-center gap-4 group">
                            <div
                                class="w-20 h-20 rounded-2xl bg-gradient-to-br from-blue-500/20 to-cyan-600/20 border border-blue-500/30 flex items-center justify-center group-hover:border-blue-500/60 transition-all">
                                <i data-lucide="layers" class="w-10 h-10 text-blue-400"></i>
                            </div>
                            <div class="text-center">
                                <h3 class="text-2xl font-semibold text-white mb-1"
                                    style="font-family: 'Orbitron', sans-serif;">Image Studio</h3>
                                <p class="text-base text-gray-200">圖片合成工具</p>
                            </div>
                        </button>

                        <!-- Video Generation -->
                        <button onclick="navigateTo('motion'); showVideoToolMenu();"
                            class="tool-icon glass-card rounded-2xl p-8 flex flex-col items-center justify-center gap-4 group">
                            <div
                                class="w-20 h-20 rounded-2xl bg-gradient-to-br from-amber-500/20 to-orange-600/20 border border-amber-500/30 flex items-center justify-center group-hover:border-amber-500/60 transition-all">
                                <i data-lucide="film" class="w-10 h-10 text-amber-400"></i>
                            </div>
                            <div class="text-center">
                                <h3 class="text-2xl font-semibold text-white mb-1"
                                    style="font-family: 'Orbitron', sans-serif;">Video Studio</h3>
                                <p class="text-base text-gray-200">影片生成工具</p>
                            </div>
                        </button>

                        <!-- Avatar Studio -->
                        <button onclick="navigateTo('avatar')"
                            class="tool-icon glass-card rounded-2xl p-8 flex flex-col items-center justify-center gap-4 group">
                            <div
                                class="w-20 h-20 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-teal-600/20 border border-emerald-500/30 flex items-center justify-center group-hover:border-emerald-500/60 transition-all">
                                <i data-lucide="user-circle-2" class="w-10 h-10 text-emerald-400"></i>
                            </div>
                            <div class="text-center">
                                <h3 class="text-2xl font-semibold text-white mb-1"
                                    style="font-family: 'Orbitron', sans-serif;">Avatar Studio</h3>
                                <p class="text-base text-gray-200">虛擬人像生成</p>
                            </div>
                        </button>

                    </div>

                    <!-- To Be Continue Button -->
                    <div class="mt-10 w-full">
                        <button disabled
                            class="w-1/2 py-5 rounded-2xl bg-white/5 border border-dashed border-white/20 text-gray-500 text-lg font-medium cursor-not-allowed hover:border-purple-500/30 transition-all">
                            <span class="opacity-60" style="font-family: 'Orbitron', sans-serif;">To Be Continue
                                ...</span>
                        </button>
                    </div>
                </div>

                <!-- Image Composition Workspace (Full Implementation) -->
                <!-- Image Composition Workspace (Full Implementation) -->
                <!-- Image Composition Workspace (Full Implementation) -->
                <div id="view-canvas" class="hidden">

                    <!-- Tool Selector Overlay -->
                    <div id="tool-selector-overlay"
                        class="absolute inset-0 z-50 flex items-center justify-center overlay-backdrop"
                        style="background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);">
                        <div
                            class="floating-toolbar glass-panel rounded-3xl p-12 max-w-6xl w-full mx-6 border border-white/10">
                            <!-- Header -->
                            <div class="flex items-center justify-between mb-10">
                                <div class="flex items-center gap-4">
                                    <div
                                        class="p-4 rounded-2xl bg-gradient-to-r from-purple-500 to-indigo-600 shadow-lg shadow-purple-500/30">
                                        <i data-lucide="layers" class="w-8 h-8"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-3xl font-bold text-white">Image Composition</h2>
                                        <p class="text-base text-gray-400 mt-1">選擇一個工具開始創作</p>
                                    </div>
                                </div>
                                <button onclick="hideCompositionMenu()"
                                    class="p-3 rounded-xl hover:bg-white/10 transition-colors text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-8 h-8"></i>
                                </button>
                            </div>

                            <!-- Tool Grid -->
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
                                <!-- Face Swap -->
                                <button onclick="selectTool('face_swap')"
                                    class="tool-card glass-card rounded-3xl p-6 text-center cursor-pointer hover:border-purple-500/50 group">
                                    <div
                                        class="p-4 rounded-2xl bg-purple-500/10 text-purple-300 mx-auto w-fit mb-4 group-hover:bg-purple-500/20 group-hover:scale-110 transition-all border border-purple-500/20">
                                        <i data-lucide="users" class="w-10 h-10"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">Face Swap</h3>
                                    <p class="text-xs text-gray-500">換臉</p>
                                </button>

                                <!-- Multi-Blend -->
                                <button onclick="selectTool('multi_image_blend')"
                                    class="tool-card glass-card rounded-3xl p-6 text-center cursor-pointer hover:border-amber-500/50 group">
                                    <div
                                        class="p-4 rounded-2xl bg-amber-500/10 text-amber-300 mx-auto w-fit mb-4 group-hover:bg-amber-500/20 group-hover:scale-110 transition-all border border-amber-500/20">
                                        <i data-lucide="layers" class="w-10 h-10"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">Multi-Blend</h3>
                                    <p class="text-xs text-gray-500">多圖融合</p>
                                </button>

                                <!-- Sketch to Image -->
                                <button onclick="selectTool('sketch_to_image')"
                                    class="tool-card glass-card rounded-3xl p-6 text-center cursor-pointer hover:border-emerald-500/50 group">
                                    <div
                                        class="p-4 rounded-2xl bg-emerald-500/10 text-emerald-300 mx-auto w-fit mb-4 group-hover:bg-emerald-500/20 group-hover:scale-110 transition-all border border-emerald-500/20">
                                        <i data-lucide="pencil" class="w-10 h-10"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">Sketch</h3>
                                    <p class="text-xs text-gray-500">草稿轉精稿</p>
                                </button>

                                <!-- Text to Image -->
                                <button onclick="selectTool('text_to_image')"
                                    class="tool-card glass-card rounded-3xl p-6 text-center cursor-pointer hover:border-blue-500/50 group">
                                    <div
                                        class="p-4 rounded-2xl bg-blue-500/10 text-blue-300 mx-auto w-fit mb-4 group-hover:bg-blue-500/20 group-hover:scale-110 transition-all border border-blue-500/20">
                                        <i data-lucide="type" class="w-10 h-10"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">Text2Img</h3>
                                    <p class="text-xs text-gray-500">文生圖</p>
                                </button>

                                <!-- Single Image Edit -->
                                <button onclick="selectTool('single_image_edit')"
                                    class="tool-card glass-card rounded-3xl p-6 text-center cursor-pointer hover:border-pink-500/50 group">
                                    <div
                                        class="p-4 rounded-2xl bg-pink-500/10 text-pink-300 mx-auto w-fit mb-4 group-hover:bg-pink-500/20 group-hover:scale-110 transition-all border border-pink-500/20">
                                        <i data-lucide="image" class="w-10 h-10"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">Edit</h3>
                                    <p class="text-xs text-gray-500">單圖編輯</p>
                                </button>
                            </div>

                            <p class="text-center text-base text-gray-500 mt-10">按 ESC 或點擊外部區域關閉</p>
                        </div>
                    </div>

                    <!-- Studio Workspace -->
                    <div id="studio-workspace" class="hidden flex h-full">
                        <!-- Center Stage -->
                        <div class="flex-1 flex flex-col relative grid-bg">
                            <!-- Current Tool Header -->
                            <div id="current-tool-header"
                                class="flex items-center gap-4 px-6 py-4 border-b border-white/5 bg-black/20">
                                <button onclick="showCompositionMenu()"
                                    class="p-2 rounded-lg hover:bg-white/10 transition-colors text-gray-400 hover:text-white"
                                    title="切換工具">
                                    <i data-lucide="grid-3x3" class="w-5 h-5"></i>
                                </button>
                                <div class="h-6 w-[1px] bg-white/10"></div>
                                <div id="current-tool-info" class="flex items-center gap-3">
                                    <div id="current-tool-icon" class="p-2 rounded-lg bg-purple-500/20 text-purple-300">
                                        <i data-lucide="type" class="w-4 h-4"></i>
                                    </div>
                                    <div>
                                        <span id="current-tool-name" class="text-sm font-bold text-white">Text to
                                            Image</span>
                                        <span id="current-tool-desc" class="text-xs text-gray-500 ml-2">文生圖</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Canvas Area -->
                            <div id="workspace-canvas"
                                class="flex-1 flex items-center justify-center p-8 overflow-auto">
                                <!-- Placeholder State -->
                                <div id="canvas-placeholder" class="text-center opacity-50">
                                    <div
                                        class="w-32 h-32 border-4 border-dashed border-gray-600 rounded-full mx-auto mb-6 flex items-center justify-center">
                                        <i data-lucide="image" class="w-12 h-12 text-gray-600"></i>
                                    </div>
                                    <h2 class="text-2xl font-bold text-gray-400 mb-2">Ready to Generate</h2>
                                    <p class="text-sm text-gray-500">Select a tool and enter your prompt below</p>
                                </div>
                                <!-- Result Images Grid -->
                                <div id="canvas-results" class="hidden w-full h-full">
                                    <div id="results-grid" class="grid gap-4 w-full h-full place-items-center">
                                    </div>
                                </div>
                            </div>

                            <!-- Bottom Control Panel -->
                            <div id="workspace-controls" class="glass-panel p-6 relative">
                                <div class="max-w-4xl mx-auto flex flex-col gap-4">
                                    <!-- Upload Zones -->
                                    <div id="upload-zones" class="flex gap-4 h-28"></div>

                                    <!-- Prompt Bar -->
                                    <div id="single-prompt-row" class="flex gap-4">
                                        <textarea id="prompt-input"
                                            class="flex-1 custom-input rounded-xl p-4 text-sm resize-none h-16"
                                            placeholder="Describe your image..."></textarea>
                                        <button id="btn-enhance" type="button"
                                            class="px-4 rounded-xl font-medium bg-white/5 border border-white/10 hover:bg-white/10 hover:border-purple-500/50 transition-all flex items-center gap-2 text-gray-400 hover:text-white"
                                            title="AI 優化 Prompt">
                                            <i data-lucide="wand-2" class="w-5 h-5"></i>
                                        </button>
                                        <button id="btn-generate" type="button"
                                            class="bg-gradient-to-r from-purple-600 to-indigo-600 px-8 rounded-xl font-bold hover:shadow-[0_0_25px_rgba(124,58,237,0.5)] transition-all flex items-center gap-2 border border-white/10 hover:brightness-110">
                                            <i data-lucide="sparkles" class="w-5 h-5"></i>
                                            <span>Generate</span>
                                        </button>
                                    </div>

                                    <!-- Status Message -->
                                    <div id="status-message" class="text-sm text-gray-400 text-center hidden"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Settings Panel -->
                        <aside id="workspace-settings"
                            class="w-80 border-l border-white/10 bg-black/30 p-6 flex flex-col gap-6 overflow-y-auto flex-shrink-0">
                            <!-- Model Selector -->
                            <div>
                                <label
                                    class="text-xs font-bold text-gray-500 uppercase mb-2 block tracking-wider">Model</label>
                                <select id="model-select"
                                    class="w-full custom-input rounded-xl p-3 text-sm cursor-pointer">
                                    <option value="loading" disabled>Loading models...</option>
                                </select>
                            </div>

                            <!-- Aspect Ratio -->
                            <div>
                                <label
                                    class="text-xs font-bold text-gray-500 uppercase mb-3 block tracking-wider">Aspect
                                    Ratio</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="updateAspectRatio('1:1')" data-ratio="1:1"
                                        class="ratio-btn active p-3 rounded-xl flex flex-col items-center gap-2 bg-black/30">
                                        <div class="w-8 h-8 border-2 border-current rounded-md"></div>
                                        <span class="text-xs font-medium">1:1 Square</span>
                                    </button>
                                    <button onclick="updateAspectRatio('16:9')" data-ratio="16:9"
                                        class="ratio-btn p-3 rounded-xl flex flex-col items-center gap-2 bg-black/30 text-gray-400">
                                        <div class="w-10 h-6 border-2 border-current rounded-md"></div>
                                        <span class="text-xs font-medium">16:9 Cinema</span>
                                    </button>
                                    <button onclick="updateAspectRatio('9:16')" data-ratio="9:16"
                                        class="ratio-btn p-3 rounded-xl flex flex-col items-center gap-2 bg-black/30 text-gray-400">
                                        <div class="w-6 h-10 border-2 border-current rounded-md"></div>
                                        <span class="text-xs font-medium">9:16 Mobile</span>
                                    </button>
                                    <button onclick="updateAspectRatio('2:3')" data-ratio="2:3"
                                        class="ratio-btn p-3 rounded-xl flex flex-col items-center gap-2 bg-black/30 text-gray-400">
                                        <div class="w-6 h-9 border-2 border-current rounded-md"></div>
                                        <span class="text-xs font-medium">2:3 Portrait</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Seed Input -->
                            <div>
                                <label
                                    class="text-xs font-bold text-gray-500 uppercase mb-2 block tracking-wider">Seed</label>
                                <div class="flex gap-2">
                                    <input type="number" id="seed-input"
                                        class="flex-1 custom-input rounded-xl p-3 text-sm" placeholder="-1 (Random)"
                                        value="-1">
                                    <button
                                        onclick="document.getElementById('seed-input').value = Math.floor(Math.random() * 999999999)"
                                        class="px-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition-all"
                                        title="Random">
                                        <i data-lucide="shuffle" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Batch Size -->
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase mb-3 block tracking-wider">Batch
                                    Size</label>
                                <div class="flex gap-2">
                                    <button onclick="setBatchSize(1)" data-batch="1"
                                        class="batch-btn flex-1 py-2 rounded-lg text-sm font-medium bg-purple-500/20 border border-purple-500/50 text-white">1</button>
                                    <button onclick="setBatchSize(2)" data-batch="2"
                                        class="batch-btn flex-1 py-2 rounded-lg text-sm font-medium bg-black/30 border border-white/10 text-gray-400">2</button>
                                    <button onclick="setBatchSize(4)" data-batch="4"
                                        class="batch-btn flex-1 py-2 rounded-lg text-sm font-medium bg-black/30 border border-white/10 text-gray-400">4</button>
                                </div>
                            </div>

                            <!-- Separator -->
                            <div class="h-[1px] bg-gradient-to-r from-transparent via-white/10 to-transparent">
                            </div>

                            <!-- Advanced Settings (Collapsed) -->
                            <details class="group">
                                <summary
                                    class="text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer flex items-center gap-2 hover:text-gray-300 transition-colors">
                                    <i data-lucide="chevron-right"
                                        class="w-4 h-4 group-open:rotate-90 transition-transform"></i>
                                    Advanced Settings
                                </summary>
                                <div class="mt-4 space-y-4 pl-6">
                                    <div>
                                        <label class="text-xs text-gray-500 mb-1 block">CFG Scale</label>
                                        <input type="range" min="1" max="20" value="7" class="w-full accent-purple-500">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 mb-1 block">Steps</label>
                                        <input type="number" value="20"
                                            class="w-full custom-input rounded-lg p-2 text-sm">
                                    </div>
                                </div>
                            </details>
                        </aside>
                    </div>
                </div>

                <!-- Motion Workspace (Full Implementation) -->
                <!-- Motion Workspace (Full Implementation) -->
                <!-- Motion Workspace (Full Implementation) -->
                <div id="view-motion" class="hidden">
                    <!-- Video Tool Selector Overlay -->
                    <div id="video-tool-selector-overlay"
                        class="absolute inset-0 z-50 flex items-center justify-center overlay-backdrop"
                        style="background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);">
                        <div
                            class="floating-toolbar glass-panel rounded-3xl p-12 max-w-4xl w-full mx-6 border border-white/10">
                            <div class="flex items-center justify-between mb-10">
                                <div class="flex items-center gap-4">
                                    <div
                                        class="p-4 rounded-2xl bg-gradient-to-r from-amber-500 to-orange-600 shadow-lg shadow-amber-500/30">
                                        <i data-lucide="film" class="w-8 h-8"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-3xl font-bold text-white">Video Studio</h2>
                                        <p class="text-base text-gray-400 mt-1">選擇一種影片生成方式</p>
                                    </div>
                                </div>
                                <button onclick="hideVideoToolMenu()"
                                    class="p-3 rounded-xl hover:bg-white/10 transition-colors text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-8 h-8"></i>
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <button onclick="selectVideoTool('veo3_long_video')"
                                    class="tool-card glass-card rounded-3xl p-8 text-center cursor-pointer hover:border-amber-500/50 group">
                                    <div
                                        class="p-5 rounded-2xl bg-amber-500/10 text-amber-300 mx-auto w-fit mb-5 group-hover:bg-amber-500/20 group-hover:scale-110 transition-all border border-amber-500/20">
                                        <i data-lucide="film" class="w-12 h-12"></i>
                                    </div>
                                    <h3 class="text-lg font-bold text-white mb-2">長片生成</h3>
                                    <p class="text-sm text-gray-500">Multi-Shot (1-5)</p>
                                </button>
                                <button onclick="selectVideoTool('t2v_veo3')"
                                    class="tool-card glass-card rounded-3xl p-8 text-center cursor-pointer hover:border-blue-500/50 group">
                                    <div
                                        class="p-5 rounded-2xl bg-blue-500/10 text-blue-300 mx-auto w-fit mb-5 group-hover:bg-blue-500/20 group-hover:scale-110 transition-all border border-blue-500/20">
                                        <i data-lucide="type" class="w-12 h-12"></i>
                                    </div>
                                    <h3 class="text-lg font-bold text-white mb-2">文字轉影片</h3>
                                    <p class="text-sm text-gray-500">Text to Video</p>
                                </button>
                                <button onclick="selectVideoTool('flf_veo3')"
                                    class="tool-card glass-card rounded-3xl p-8 text-center cursor-pointer hover:border-purple-500/50 group">
                                    <div
                                        class="p-5 rounded-2xl bg-purple-500/10 text-purple-300 mx-auto w-fit mb-5 group-hover:bg-purple-500/20 group-hover:scale-110 transition-all border border-purple-500/20">
                                        <i data-lucide="image" class="w-12 h-12"></i>
                                    </div>
                                    <h3 class="text-lg font-bold text-white mb-2">首尾禎動畫</h3>
                                    <p class="text-sm text-gray-500">First-Last Frame</p>
                                </button>
                            </div>
                            <p class="text-center text-base text-gray-500 mt-10">按 ESC 或點擊外部區域關閉</p>
                        </div>
                    </div>

                    <!-- Video Workspace -->
                    <div id="video-workspace" class="hidden flex flex-col h-full">
                        <!-- Main Content Area (Left Panel + Center Preview) -->
                        <div class="flex flex-1 overflow-hidden">
                            <!-- Left Panel: Multi-Shot Composition -->
                            <div class="w-48 glass-panel border-r border-white/10 flex flex-col z-20">
                                <!-- Tool Header -->
                                <div id="video-tool-header"
                                    class="flex items-center gap-2 p-4 border-b border-white/10">
                                    <button onclick="showVideoToolMenu()"
                                        class="p-1.5 rounded-lg hover:bg-white/10 transition-colors text-gray-400 hover:text-white"
                                        title="切換工具">
                                        <i data-lucide="grid-3x3" class="w-4 h-4"></i>
                                    </button>
                                    <div class="h-4 w-[1px] bg-white/10"></div>
                                    <div id="video-tool-icon" class="p-1.5 rounded-lg bg-amber-500/20 text-amber-300">
                                        <i data-lucide="film" class="w-3.5 h-3.5"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <span id="video-tool-name"
                                            class="text-xs font-bold text-white block truncate">長片生成</span>
                                        <span id="video-tool-desc"
                                            class="text-[10px] text-gray-500 block truncate">Multi-Shot</span>
                                    </div>
                                </div>

                                <!-- Panel: Multi-Shot -->
                                <div id="panel-veo3_long_video" class="flex-1 overflow-y-auto p-4">
                                    <div class="mb-4">
                                        <h3 class="text-xs font-bold text-white mb-1">Multi-Shot Composition</h3>
                                        <p class="text-[10px] text-gray-500">Add up to 5 images to create a sequence.
                                        </p>
                                    </div>
                                    <!-- Shot Upload Zones -->
                                    <div class="space-y-3" id="motion-shots-upload"></div>
                                    <!-- Multi Prompts (in sidebar for multi mode) -->
                                    <div id="veo3-multi-prompts" class="hidden space-y-2 mt-4">
                                        <h4 class="text-[10px] font-bold text-white uppercase">Shot Prompts</h4>
                                    </div>
                                </div>

                                <!-- Panel: T2V -->
                                <div id="panel-t2v_veo3" class="hidden flex-1 overflow-y-auto p-4">
                                    <h3 class="text-xs font-bold text-white mb-2">文字轉影片</h3>
                                    <p class="text-[10px] text-gray-500 mb-4">直接輸入描述，無需圖片即可生成影片。</p>
                                    <div class="glass-card rounded-xl p-3 border border-blue-500/20 bg-blue-500/10">
                                        <div class="flex items-center gap-2">
                                            <div class="p-1.5 rounded-lg bg-blue-500/20">
                                                <i data-lucide="type" class="w-4 h-4 text-blue-300"></i>
                                            </div>
                                            <div>
                                                <div class="text-xs font-bold text-white">純文字模式</div>
                                                <div class="text-[10px] text-gray-400">在下方輸入 Prompt 即可</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Panel: FLF -->
                                <div id="panel-flf_veo3" class="hidden flex-1 overflow-y-auto p-4">
                                    <h3 class="text-xs font-bold text-white mb-2">首尾禎動畫</h3>
                                    <p class="text-[10px] text-gray-500 mb-4">上傳首禎與尾禎圖片。</p>
                                    <div class="space-y-3" id="flf-dropzones">
                                        <div id="zone-first_frame"
                                            class="upload-zone relative flex flex-col items-center justify-center rounded-xl cursor-pointer bg-black/20 p-3 min-h-[80px]"
                                            onclick="triggerFLFUpload('first_frame')">
                                            <input type="file" id="file-first_frame" class="hidden" accept="image/*"
                                                onchange="handleFLFSelect(event, 'first_frame')" />
                                            <div id="preview-first_frame" class="hidden absolute inset-0">
                                                <img src="" alt="Preview"
                                                    class="w-full h-full object-cover rounded-xl" />
                                                <button onclick="event.stopPropagation(); clearFLFImage('first_frame')"
                                                    class="absolute top-1 right-1 p-0.5 bg-black/70 rounded-full hover:bg-red-500/80 z-10">
                                                    <i data-lucide="x" class="w-3 h-3 text-white"></i>
                                                </button>
                                            </div>
                                            <div id="placeholder-first_frame"
                                                class="flex flex-col items-center pointer-events-none">
                                                <i data-lucide="image" class="w-6 h-6 text-purple-400 mb-1"></i>
                                                <span class="text-xs font-bold text-white">首禎</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-center">
                                            <i data-lucide="arrow-down" class="w-4 h-4 text-gray-500"></i>
                                        </div>
                                        <div id="zone-last_frame"
                                            class="upload-zone relative flex flex-col items-center justify-center rounded-xl cursor-pointer bg-black/20 p-3 min-h-[80px]"
                                            onclick="triggerFLFUpload('last_frame')">
                                            <input type="file" id="file-last_frame" class="hidden" accept="image/*"
                                                onchange="handleFLFSelect(event, 'last_frame')" />
                                            <div id="preview-last_frame" class="hidden absolute inset-0">
                                                <img src="" alt="Preview"
                                                    class="w-full h-full object-cover rounded-xl" />
                                                <button onclick="event.stopPropagation(); clearFLFImage('last_frame')"
                                                    class="absolute top-1 right-1 p-0.5 bg-black/70 rounded-full hover:bg-red-500/80 z-10">
                                                    <i data-lucide="x" class="w-3 h-3 text-white"></i>
                                                </button>
                                            </div>
                                            <div id="placeholder-last_frame"
                                                class="flex flex-col items-center pointer-events-none">
                                                <i data-lucide="image" class="w-6 h-6 text-purple-400 mb-1"></i>
                                                <span class="text-xs font-bold text-white">尾禎</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Preview Area -->
                            <div class="flex-1 flex flex-col relative">
                                <!-- Preview Container -->
                                <div id="motion-preview" class="flex-1 flex items-center justify-center p-8 relative">
                                    <!-- Radial Gradient Background -->
                                    <div class="absolute inset-0 pointer-events-none"
                                        style="background: radial-gradient(ellipse 60% 50% at 50% 50%, rgba(6, 182, 212, 0.15) 0%, transparent 70%);">
                                    </div>

                                    <!-- Placeholder -->
                                    <div id="motion-preview-placeholder" class="text-center relative z-10">
                                        <div class="w-24 h-24 rounded-full bg-white/5 border border-white/10 mx-auto mb-6 flex items-center justify-center
                                            shadow-[0_0_40px_rgba(6,182,212,0.2)]">
                                            <i data-lucide="play" class="w-10 h-10 text-white/40"></i>
                                        </div>
                                        <h2 class="text-xl font-bold text-white mb-2">Preview Area</h2>
                                        <p class="text-sm text-gray-500">Generated video will appear here</p>
                                    </div>

                                    <!-- Video Player (hidden by default) -->
                                    <div id="motion-video-wrapper"
                                        class="hidden absolute inset-4 flex items-center justify-center">
                                        <video id="motion-video-player" controls
                                            class="max-w-full max-h-full rounded-2xl shadow-2xl">
                                            您的瀏覽器不支持視頻播放。
                                        </video>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom: Video Prompt Bar (Fixed at bottom) -->
                        <div class="glass-panel border-t border-white/10 p-4">
                            <div class="max-w-5xl mx-auto">
                                <!-- Header Row -->
                                <div class="flex justify-between items-center mb-3">
                                    <div
                                        class="text-xs text-gray-400 uppercase font-bold tracking-wider flex items-center gap-2">
                                        <i data-lucide="sparkles" class="w-3 h-3 text-amber-400"></i>
                                        VIDEO PROMPT
                                    </div>
                                    <button id="toggle-veo3-mode" onclick="toggleVeo3Mode()"
                                        class="text-xs px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 transition-colors text-gray-400 hover:text-white border border-white/10 flex items-center gap-1.5">
                                        <i data-lucide="layers" class="w-3 h-3"></i>
                                        <span id="mode-label">切換至多段模式</span>
                                    </button>
                                </div>

                                <!-- Single Prompt Mode -->
                                <div id="motion-single-prompt" class="flex gap-4">
                                    <textarea id="motion-prompt-input"
                                        class="flex-1 custom-input rounded-xl p-4 text-sm resize-none h-14"
                                        placeholder="Describe the camera movement, subject action, or atmosphere..."></textarea>
                                    <button id="btn-motion-generate" type="button" onclick="handleMotionGenerate()"
                                        class="bg-gradient-to-r from-amber-600 to-orange-600 px-6 rounded-xl font-bold hover:shadow-[0_0_25px_rgba(245,158,11,0.5)] transition-all flex items-center gap-2 border border-white/10 whitespace-nowrap">
                                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                                        <span>Generate</span>
                                    </button>
                                </div>

                                <!-- Multi Prompts Mode (Veo3 Long Video) -->
                                <div id="motion-multi-prompts" class="hidden"
                                    style="flex-direction: column; gap: 0.75rem;">
                                    <div class="text-xs text-amber-400 mb-2 flex items-center gap-2">
                                        <i data-lucide="info" class="w-3 h-3"></i>
                                        可選填 1-5 個片段，空白片段將自動跳過
                                    </div>
                                    <div class="space-y-2">
                                        <input type="text" id="veo3-segment-0"
                                            class="w-full custom-input rounded-lg p-3 text-sm"
                                            placeholder="Segment 1 (Optional)" />
                                        <input type="text" id="veo3-segment-1"
                                            class="w-full custom-input rounded-lg p-3 text-sm"
                                            placeholder="Segment 2 (Optional)" />
                                        <input type="text" id="veo3-segment-2"
                                            class="w-full custom-input rounded-lg p-3 text-sm"
                                            placeholder="Segment 3 (Optional)" />
                                        <input type="text" id="veo3-segment-3"
                                            class="w-full custom-input rounded-lg p-3 text-sm"
                                            placeholder="Segment 4 (Optional)" />
                                        <input type="text" id="veo3-segment-4"
                                            class="w-full custom-input rounded-lg p-3 text-sm"
                                            placeholder="Segment 5 (Optional)" />
                                    </div>
                                    <button id="btn-motion-generate-multi" type="button"
                                        onclick="handleMotionGenerate()"
                                        class="w-fit bg-gradient-to-r from-amber-600 to-orange-600 px-8 py-3 rounded-xl font-bold hover:shadow-[0_0_25px_rgba(245,158,11,0.5)] transition-all flex items-center gap-2 border border-white/10">
                                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                                        <span>Generate Long Video</span>
                                    </button>
                                </div>

                                <!-- Status -->
                                <div id="motion-status" class="text-sm text-center hidden mt-3"></div>
                            </div>
                        </div>

                        <!-- Motion Results Display -->
                        <div id="motion-results" class="hidden max-w-4xl mx-auto p-6"></div>
                    </div>
                    <!-- Avatar Workspace -->
                    <div id="view-avatar" class="hidden h-full">
                        <!-- Close Button -->
                        <button onclick="navigateTo('dashboard')"
                            class="absolute top-6 right-6 p-2 rounded-full bg-white/10 hover:bg-white/20 transition-all z-50">
                            <i data-lucide="x" class="w-6 h-6 text-white"></i>
                        </button>

                        <!-- Two-Column Layout: Left Control + Right Preview -->
                        <div class="flex h-full gap-6 p-6">

                            <!-- Left Panel: Controls (約 40% 寬度) -->
                            <div class="w-2/5 flex flex-col overflow-y-auto">
                                <!-- Header -->
                                <div class="flex items-center gap-4 mb-6">
                                    <div
                                        class="p-3 rounded-xl bg-gradient-to-r from-emerald-500/20 to-teal-600/20 border border-emerald-500/30">
                                        <i data-lucide="user-circle-2" class="w-8 h-8 text-emerald-400"></i>
                                    </div>
                                    <div>
                                        <h1 class="text-2xl font-bold text-white">Avatar Studio</h1>
                                        <p class="text-gray-400 text-sm">輸入台詞，上傳人像與參考語音</p>
                                    </div>
                                </div>

                                <!-- Upload Zones (2 columns) -->
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <!-- Image Upload -->
                                    <div id="avatar-image-zone"
                                        class="upload-zone rounded-xl p-4 min-h-[140px] flex flex-col items-center justify-center relative"
                                        onclick="triggerAvatarImageUpload()">
                                        <input type="file" id="avatar-image-input" class="hidden" accept="image/*"
                                            onchange="handleAvatarImageSelect(event)" />
                                        <div id="avatar-image-preview" class="hidden absolute inset-0 p-2">
                                            <img src="" alt="Avatar Preview"
                                                class="w-full h-full object-cover rounded-lg" />
                                            <button onclick="event.stopPropagation(); clearAvatarImage()"
                                                class="absolute top-3 right-3 p-1 bg-black/70 rounded-full hover:bg-red-500/80 z-10">
                                                <i data-lucide="x" class="w-4 h-4 text-white"></i>
                                            </button>
                                        </div>
                                        <div id="avatar-image-placeholder" class="flex flex-col items-center">
                                            <i data-lucide="user" class="w-8 h-8 text-emerald-400 mb-2"></i>
                                            <span class="text-sm font-bold text-white">人像圖片</span>
                                            <span class="text-xs text-gray-500">PNG / JPG</span>
                                        </div>
                                    </div>

                                    <!-- Audio Upload -->
                                    <div id="avatar-audio-zone"
                                        class="upload-zone rounded-xl p-4 min-h-[140px] flex flex-col items-center justify-center"
                                        onclick="triggerAvatarAudioUpload()">
                                        <input type="file" id="avatar-audio-input" class="hidden"
                                            accept="audio/*,.wav,.mp3" onchange="handleAvatarAudioSelect(event)" />
                                        <div id="avatar-audio-preview" class="hidden flex flex-col items-center gap-2">
                                            <div class="p-2 rounded-lg bg-emerald-500/20">
                                                <i data-lucide="music" class="w-6 h-6 text-emerald-300"></i>
                                            </div>
                                            <span id="avatar-audio-filename"
                                                class="text-white text-xs font-medium truncate max-w-full px-2">audio.wav</span>
                                            <button onclick="event.stopPropagation(); clearAvatarAudio()"
                                                class="p-1 rounded hover:bg-red-500/50 text-gray-400 hover:text-white">
                                                <i data-lucide="x" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                        <div id="avatar-audio-placeholder" class="flex flex-col items-center">
                                            <i data-lucide="mic" class="w-8 h-8 text-emerald-400 mb-2"></i>
                                            <span class="text-sm font-bold text-white">參考語音</span>
                                            <span class="text-xs text-gray-500">WAV / MP3</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Script Input (台詞輸入) -->
                                <div class="glass-card rounded-xl p-4 mb-4 flex-1">
                                    <label class="text-xs font-bold text-emerald-400 uppercase mb-2 block">
                                        📝 台詞 Script
                                        <span class="text-gray-500 normal-case ml-1">(虛擬人要說的話)</span>
                                    </label>
                                    <textarea id="avatar-prompt-input"
                                        class="w-full custom-input rounded-xl p-3 text-sm resize-none h-32" placeholder="輸入虛擬人要說的台詞內容...

例如：
謝謝你的支持，真的很感動。
老實講，有時候直播久了會累，
但看到有人願意花時間、甚至願意支持我，
那種感覺真的像被補滿能量一樣。"></textarea>
                                    <p class="text-xs text-gray-500 mt-2">💡 台詞會透過 TTS 語音合成轉為聲音</p>
                                </div>

                                <!-- Generate Button -->
                                <button id="avatar-generate-btn" onclick="generateAvatarVideo()"
                                    class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 py-4 rounded-xl font-bold text-lg hover:shadow-[0_0_25px_rgba(16,185,129,0.5)] transition-all flex items-center justify-center gap-3">
                                    <i data-lucide="video" class="w-6 h-6"></i>
                                    <span>生成虛擬人影片</span>
                                </button>

                                <!-- Status -->
                                <div id="avatar-status" class="hidden mt-4 p-4 rounded-xl text-center"></div>
                            </div>

                            <!-- Right Panel: Video Preview (約 60% 寬度) -->
                            <div class="w-3/5 flex flex-col">
                                <!-- Preview Header -->
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="monitor-play" class="w-5 h-5 text-emerald-400"></i>
                                        <span class="text-white font-medium">影片預覽</span>
                                    </div>
                                    <span id="avatar-preview-status" class="text-xs text-gray-500">等待生成...</span>
                                </div>

                                <!-- Video Preview Area -->
                                <div id="avatar-preview-container"
                                    class="flex-1 glass-card rounded-2xl overflow-hidden flex items-center justify-center relative">
                                    <!-- Placeholder -->
                                    <div id="avatar-preview-placeholder"
                                        class="flex flex-col items-center text-center p-8">
                                        <div
                                            class="w-24 h-24 rounded-full bg-emerald-500/10 flex items-center justify-center mb-6">
                                            <i data-lucide="video" class="w-12 h-12 text-emerald-500/50"></i>
                                        </div>
                                        <h3 class="text-xl font-bold text-white mb-2">影片預覽區</h3>
                                        <p class="text-gray-500 text-sm max-w-xs">
                                            完成左側設定後點擊「生成虛擬人影片」，<br>
                                            生成的影片將在此顯示
                                        </p>
                                    </div>

                                    <!-- Video Player (hidden by default) -->
                                    <div id="avatar-video-wrapper" class="hidden absolute inset-0 flex flex-col">
                                        <video id="avatar-video-player" controls
                                            class="w-full h-full object-contain bg-black">
                                            您的瀏覽器不支持視頻播放。
                                        </video>
                                        <!-- Video Controls -->
                                        <div
                                            class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent">
                                            <div class="flex items-center justify-between">
                                                <span class="text-white text-sm font-medium">生成完成</span>
                                                <div class="flex gap-2">
                                                    <a id="avatar-download-btn" href="#" download
                                                        class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg text-white text-sm font-medium flex items-center gap-2 transition-colors">
                                                        <i data-lucide="download" class="w-4 h-4"></i>
                                                        下載影片
                                                    </a>
                                                    <button
                                                        onclick="window.open(document.getElementById('avatar-video-player').src, '_blank')"
                                                        class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white text-sm font-medium flex items-center gap-2 transition-colors">
                                                        <i data-lucide="external-link" class="w-4 h-4"></i>
                                                        新視窗
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hidden legacy results div -->
                                <div id="avatar-results" class="hidden"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Gallery Workspace -->
                    <!-- Gallery Workspace -->
                    <!-- Gallery Workspace -->
                    <div id="view-gallery" class="hidden">
                        <!-- Close Button -->
                        <button onclick="navigateTo('dashboard')"
                            class="absolute top-6 right-6 p-2 rounded-full bg-white/10 hover:bg-white/20 transition-all z-50">
                            <i data-lucide="x" class="w-6 h-6 text-white"></i>
                        </button>
                        <div class="max-w-7xl mx-auto">
                            <div class="flex items-center justify-between mb-8">
                                <div>
                                    <h1 class="text-3xl font-bold mb-2 text-white">Personal Gallery</h1>
                                    <p class="text-gray-400">回顧您的創作歷史，重新混音您的作品</p>
                                </div>
                                <button onclick="loadHistory()"
                                    class="glass-card px-4 py-2 rounded-lg text-sm font-medium hover:bg-white/10 flex items-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    重新整理
                                </button>
                            </div>
                            <div class="glass-card rounded-xl p-4 mb-6 flex items-center gap-4">
                                <span class="text-sm text-gray-400">篩選:</span>
                                <button
                                    class="px-3 py-1 rounded-lg bg-purple-500/20 border border-purple-500/50 text-purple-300 text-sm">全部</button>
                                <button
                                    class="px-3 py-1 rounded-lg hover:bg-white/5 border border-transparent text-gray-400 text-sm">已完成</button>
                                <button
                                    class="px-3 py-1 rounded-lg hover:bg-white/5 border border-transparent text-gray-400 text-sm">生成中</button>
                            </div>
                            <div id="gallery-grid"
                                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                <div class="col-span-full text-center py-12 text-gray-500">
                                    <i data-lucide="loader" class="w-8 h-8 mx-auto mb-4 animate-spin"></i>
                                    <p>載入歷史記錄中...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
    </main>

    <script>
        // ==========================================
        // Enhanced Lucide Icons Initialization
        // ==========================================

        // Initialize immediately when script loads
        if (typeof lucide !== 'undefined') {
            console.log('[Lucide] Library loaded, initializing icons...');
            lucide.createIcons();
        }

        // Backup initialization on window load
        window.addEventListener('load', () => {
            console.log('[Lucide] Window loaded, re-initializing icons...');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });

        // API Configuration
        const API_BASE = (typeof window.API_URL !== 'undefined') ? window.API_URL : '';
        console.log('[Dashboard] API_BASE:', API_BASE || '(relative path)');

        // Current View State
        let currentView = 'dashboard';

        /**
         * Navigation Function
         */
        // ==========================================
        // Layout & Navigation System
        // ==========================================
        function toggleLayout(model) {
            const homeSidebar = document.getElementById('home-sidebar');
            const homeMain = document.getElementById('home-main');
            const homeBg = document.getElementById('home-bg-layer');
            const workspaceWrapper = document.getElementById('workspace-wrapper');

            if (model === 'home') {
                if (homeSidebar) homeSidebar.classList.remove('hidden');
                if (homeMain) homeMain.classList.remove('hidden');
                if (homeBg) homeBg.classList.remove('hidden');
                if (workspaceWrapper) workspaceWrapper.classList.add('hidden');
            } else {
                if (homeSidebar) homeSidebar.classList.add('hidden');
                if (homeMain) homeMain.classList.add('hidden');
                if (homeBg) homeBg.classList.add('hidden');
                if (workspaceWrapper) workspaceWrapper.classList.remove('hidden');
            }
        }

        function navigateTo(viewName) {
            console.log('[Nav] Navigating to:', viewName);

            // Toggle Layout Container
            const isHome = (viewName === 'dashboard');
            toggleLayout(isHome ? 'home' : 'workspace');

            // View Switching Logic
            const allViews = document.querySelectorAll('[id^="view-"]');
            allViews.forEach(view => view.classList.add('hidden'));

            const targetView = document.getElementById(`view-${viewName}`);
            const workspaceContent = document.getElementById('workspace-content');

            if (targetView) {
                // 如果不是 dashboard，需要將視圖移動到 workspace-content 中
                if (!isHome && workspaceContent) {
                    workspaceContent.appendChild(targetView);
                    // 添加全屏樣式類
                    targetView.classList.add('absolute', 'inset-0', 'w-full', 'h-full', 'bg-[#020205]', 'overflow-hidden');
                }
                targetView.classList.remove('hidden');
                targetView.classList.add('animate-fade-in');
            }

            // Sync Nav State (Both Home and Workspace Sidebars)
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                const onclick = item.getAttribute('onclick');
                if ((onclick && onclick.includes(`navigateTo('${viewName}')`)) || item.dataset.id === viewName) {
                    item.classList.add('active');
                }
            });

            // 特殊處理：進入 Gallery 時載入歷史記錄
            if (viewName === 'gallery') {
                loadHistory();
            }

            currentView = viewName;
            localStorage.setItem('currentView', viewName);

            setTimeout(() => {
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }, 100);
        }



        /**
         * Check Login Status
         */
        async function checkLoginStatus() {
            console.log('[Auth] Checking login status...');

            const authGuest = document.getElementById('auth-guest');
            const authUser = document.getElementById('auth-user');
            const topbarGuest = document.getElementById('topbar-guest');
            const topbarUser = document.getElementById('topbar-user');

            try {
                const response = await fetch(`${API_BASE}/api/me`, {
                    credentials: 'include'
                });
                const data = await response.json();
                console.log('[Auth] Response:', data);

                if (data.logged_in && data.user) {
                    // Logged in
                    authGuest.classList.add('hidden');
                    authUser.classList.remove('hidden');
                    authUser.classList.add('flex');

                    topbarGuest.classList.add('hidden');
                    topbarUser.classList.remove('hidden');
                    topbarUser.classList.add('flex');

                    document.getElementById('topbar-user-name').textContent = data.user.name || '會員中心';
                    console.log('[Auth] Logged in as:', data.user.email);
                } else {
                    // Not logged in
                    authGuest.classList.remove('hidden');
                    authGuest.classList.add('flex');
                    authUser.classList.add('hidden');

                    topbarGuest.classList.remove('hidden');
                    topbarGuest.classList.add('flex');
                    topbarUser.classList.add('hidden');

                    console.log('[Auth] Not logged in');
                }

                lucide.createIcons();
            } catch (error) {
                console.error('[Auth] Check failed:', error);
                // Show guest state on error
                authGuest.classList.remove('hidden');
                authGuest.classList.add('flex');
                authUser.classList.add('hidden');
                topbarGuest.classList.remove('hidden');
                topbarGuest.classList.add('flex');
                topbarUser.classList.add('hidden');
            }
        }

        /**
         * Initialize on Page Load
         */
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Dashboard] Initializing...');

            // Restore last view
            const savedView = localStorage.getItem('currentView');
            if (savedView && savedView !== 'dashboard') {
                // 特殊處理：如果是 canvas 視圖，需要使用 showCompositionMenu
                if (savedView === 'canvas') {
                    showCompositionMenu();
                    // 如果有之前選擇的工具，直接恢復工作區
                    if (currentTool) {
                        selectTool(currentTool);
                    }
                } else if (savedView === 'motion') {
                    navigateTo('motion');
                    showVideoToolMenu();
                    if (currentVideoTool) {
                        selectVideoTool(currentVideoTool);
                    }
                } else {
                    navigateTo(savedView);
                }
            }

            // Check login status
            checkLoginStatus();

            // Initialize Multi-Shot UI if motion workspace exists
            if (document.getElementById('motion-shots-upload')) {
                initMotionShotsUI();
            }

            // Final icon initialization
            console.log('[Lucide] DOMContentLoaded - Final initialization');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
                console.log('[Lucide] Icons created successfully');
            }
        });

        // ==========================================
        // Global State
        // ==========================================
        let currentTool = 'text_to_image';
        let currentVideoTool = 'veo3_long_video';
        let currentRatio = '1:1';
        let currentBatchSize = 1;
        let uploadedImages = { source: null, target: null, input: null, extra: null };

        // Tool States
        window.toolStates = {
            text_to_image: { prompt: '', images: {}, isGenerating: false },
            face_swap: { prompt: '', images: {}, isGenerating: false },
            multi_image_blend: { prompt: '', images: {}, isGenerating: false },
            sketch_to_image: { prompt: '', images: {}, isGenerating: false },
            single_image_edit: { prompt: '', images: {}, isGenerating: false }
        };

        // Tool Configuration
        const toolConfig = {
            'face_swap': { uploads: [{ id: 'source', label: 'Source Face', icon: 'user' }, { id: 'target', label: 'Target Image', icon: 'image' }], color: 'purple' },
            'multi_image_blend': { uploads: [{ id: 'source', label: 'Image A', icon: 'image' }, { id: 'target', label: 'Image B', icon: 'image' }, { id: 'extra', label: 'Image C', icon: 'image' }], color: 'amber' },
            'sketch_to_image': { uploads: [{ id: 'input', label: 'Sketch Input', icon: 'pencil' }], color: 'emerald' },
            'text_to_image': { uploads: [], color: 'blue' },
            'single_image_edit': { uploads: [{ id: 'input', label: 'Input Image', icon: 'image' }], color: 'pink' }
        };

        const toolInfo = {
            'face_swap': { name: 'Face Swap', desc: '換臉', icon: 'users', color: 'purple' },
            'multi_image_blend': { name: 'Multi-Blend', desc: '多圖融合', icon: 'layers', color: 'amber' },
            'sketch_to_image': { name: 'Sketch to Image', desc: '草稿轉精稿', icon: 'pencil', color: 'emerald' },
            'text_to_image': { name: 'Text to Image', desc: '文生圖', icon: 'type', color: 'blue' },
            'single_image_edit': { name: 'Single Image Edit', desc: '單圖編輯', icon: 'image', color: 'pink' }
        };

        // ==========================================
        // Image Composition Menu Control
        // ==========================================


        // ==========================================
        // Tool Selection
        // ==========================================
        function selectTool(toolId) {
            console.log(`[Tool] 切換工具: ${currentTool} -> ${toolId}`);

            // 1. 保存當前工具的狀態（如果有的話）
            if (currentTool && currentTool !== toolId) {
                saveToolState(currentTool);
            }

            // 2. 更新當前工具
            currentTool = toolId;

            // 3. 隱藏工具選單，顯示工作區
            hideCompositionMenu();

            // 4. 更新當前工具標題
            updateToolHeader();

            // 5. 重新渲染工作區
            renderWorkspace();

            // 6. 載入該工具的保存狀態
            setTimeout(() => {
                loadToolState(toolId);
            }, 100);

            lucide.createIcons();
        }

        /**
         * 保存當前工具的狀態
         */
        function saveToolState(toolName) {
            if (!toolName || !window.toolStates[toolName]) return;

            const promptInput = document.getElementById('prompt-input');
            const canvasResults = document.getElementById('canvas-results');
            const resultsGrid = document.getElementById('results-grid');

            // 保存 prompt
            window.toolStates[toolName].prompt = promptInput ? promptInput.value : '';

            // 保存上傳的圖片（深拷貝避免引用污染）
            window.toolStates[toolName].images = JSON.parse(JSON.stringify(uploadedImages));

            // 保存 canvas 結果
            if (resultsGrid) {
                window.toolStates[toolName].canvasHtml = resultsGrid.innerHTML;
                window.toolStates[toolName].canvasHidden = canvasResults ? canvasResults.classList.contains('hidden') : true;
            }

            console.log(`[State] 已保存 ${toolName} 的狀態`, window.toolStates[toolName]);
        }

        /**
         * 載入工具的保存狀態
         */
        function loadToolState(toolName) {
            if (!toolName || !window.toolStates[toolName]) return;

            const state = window.toolStates[toolName];
            const promptInput = document.getElementById('prompt-input');
            const canvasResults = document.getElementById('canvas-results');
            const canvasPlaceholder = document.getElementById('canvas-placeholder');
            const resultsGrid = document.getElementById('results-grid');
            const btn = document.getElementById('btn-generate');

            // 恢復 prompt
            if (promptInput) {
                promptInput.value = state.prompt || '';
            }

            // 恢復上傳圖片（深拷貝）
            uploadedImages = JSON.parse(JSON.stringify(state.images || {}));

            // 恢復上傳圖片的 UI 顯示
            Object.keys(uploadedImages).forEach(uploadId => {
                if (uploadedImages[uploadId]) {
                    const preview = document.getElementById(`preview-${uploadId}`);
                    const placeholder = document.getElementById(`placeholder-${uploadId}`);
                    const zone = document.getElementById(`zone-${uploadId}`);

                    if (preview && placeholder && zone) {
                        const img = preview.querySelector('img');
                        if (img) img.src = uploadedImages[uploadId];
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                        zone.classList.add('has-image');
                    }
                }
            });

            // 恢復 canvas 結果
            if (state.canvasHtml && resultsGrid) {
                resultsGrid.innerHTML = state.canvasHtml;

                if (state.canvasHidden) {
                    if (canvasPlaceholder) canvasPlaceholder.classList.remove('hidden');
                    if (canvasResults) canvasResults.classList.add('hidden');
                } else {
                    if (canvasPlaceholder) canvasPlaceholder.classList.add('hidden');
                    if (canvasResults) canvasResults.classList.remove('hidden');
                }

                lucide.createIcons();
            }

            // 恢復按鈕狀態
            if (btn) {
                if (state.isGenerating) {
                    btn.disabled = true;
                    btn.classList.add('opacity-70', 'cursor-not-allowed');
                    btn.innerHTML = `
                        <div class="flex gap-1 items-center">
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                        <span>Processing...</span>
                    `;
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-70', 'cursor-not-allowed');
                    btn.innerHTML = `
                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                        <span>Generate</span>
                    `;
                    lucide.createIcons();
                }
            }

            console.log(`[State] 已載入 ${toolName} 的狀態，isGenerating: ${state.isGenerating}`);
        }

        function updateToolHeader() {
            const info = toolInfo[currentTool];
            if (!info) return;
            const iconEl = document.getElementById('current-tool-icon');
            iconEl.className = `p-2 rounded-lg bg-${info.color}-500/20 text-${info.color}-300`;
            iconEl.innerHTML = `<i data-lucide="${info.icon}" class="w-4 h-4"></i>`;
            document.getElementById('current-tool-name').textContent = info.name;
            document.getElementById('current-tool-desc').textContent = info.desc;
            lucide.createIcons();
        }

        function renderWorkspace() {
            const config = toolConfig[currentTool];
            const uploadZones = document.getElementById('upload-zones');
            if (!config || !uploadZones) return;

            // 重置上傳圖片狀態
            uploadedImages = { source: null, target: null, input: null, extra: null };

            if (config.uploads.length === 0) {
                uploadZones.innerHTML = `
                    <div class="flex-1 flex items-center justify-center text-gray-500 text-sm">
                        <i data-lucide="type" class="w-5 h-5 mr-2"></i>
                        Text-to-Image mode - No image input required
                    </div>
                `;
                uploadZones.classList.add('h-12');
                uploadZones.classList.remove('h-28');
            } else {
                uploadZones.classList.remove('h-12');
                uploadZones.classList.add('h-28');
                uploadZones.innerHTML = config.uploads.map(upload => `
                    <div id="zone-${upload.id}" 
                         class="upload-zone flex-1 rounded-xl flex flex-col items-center justify-center p-4 relative bg-black/20 overflow-hidden"
                         onclick="triggerUpload('${upload.id}')" 
                         ondragover="event.preventDefault(); this.classList.add('border-${config.color}-500/70', 'bg-${config.color}-500/10')"
                         ondragleave="this.classList.remove('border-${config.color}-500/70', 'bg-${config.color}-500/10')"
                         ondrop="handleDrop(event, '${upload.id}')">
                        <input type="file" id="file-${upload.id}" class="hidden" accept="image/*" onchange="handleFileSelect(event, '${upload.id}')" />
                        <div id="preview-${upload.id}" class="hidden absolute inset-0">
                            <img src="" alt="Preview" class="w-full h-full object-cover rounded-xl" />
                            <button onclick="event.stopPropagation(); clearUpload('${upload.id}')" class="absolute top-2 right-2 p-1 bg-black/70 rounded-full hover:bg-red-500/80 z-10">
                                <i data-lucide="x" class="w-4 h-4 text-white"></i>
                            </button>
                        </div>
                        <div id="placeholder-${upload.id}" class="flex flex-col items-center pointer-events-none">
                            <i data-lucide="${upload.icon}" class="w-6 h-6 text-gray-400 mb-2"></i>
                            <span class="text-xs font-bold uppercase text-gray-400">${upload.label}</span>
                            <span class="text-[10px] text-gray-600 mt-1">Click or Drop</span>
                        </div>
                    </div>
                `).join('');
            }

            // 重置畫布到 placeholder 狀態
            resetCanvas();

            lucide.createIcons();
        }

        /**
         * 重置畫布到初始狀態
         */
        function resetCanvas() {
            const canvasPlaceholder = document.getElementById('canvas-placeholder');
            const canvasResults = document.getElementById('canvas-results');
            const resultsGrid = document.getElementById('results-grid');

            if (canvasPlaceholder) canvasPlaceholder.classList.remove('hidden');
            if (canvasResults) canvasResults.classList.add('hidden');
            if (resultsGrid) resultsGrid.innerHTML = '';
        }

        // ==========================================
        // Upload Handling
        // ==========================================
        function triggerUpload(id) {
            document.getElementById(`file-${id}`).click();
        }

        function handleFileSelect(event, id) {
            const file = event.target.files[0];
            if (file) processFile(file, id);
        }

        function handleDrop(event, id) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file) processFile(file, id);
        }

        function processFile(file, id) {
            const reader = new FileReader();
            reader.onload = function (e) {
                uploadedImages[id] = e.target.result;
                const preview = document.getElementById(`preview-${id}`);
                const placeholder = document.getElementById(`placeholder-${id}`);
                const zone = document.getElementById(`zone-${id}`);
                if (preview && placeholder && zone) {
                    preview.querySelector('img').src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    zone.classList.add('has-image');
                }
            };
            reader.readAsDataURL(file);
        }

        function clearUpload(id) {
            uploadedImages[id] = null;
            const preview = document.getElementById(`preview-${id}`);
            const placeholder = document.getElementById(`placeholder-${id}`);
            const zone = document.getElementById(`zone-${id}`);
            const fileInput = document.getElementById(`file-${id}`);
            if (preview) preview.classList.add('hidden');
            if (placeholder) placeholder.classList.remove('hidden');
            if (zone) zone.classList.remove('has-image');
            if (fileInput) fileInput.value = '';
        }

        // ==========================================
        // Image Composition Menu Control
        // ==========================================
        function showCompositionMenu() {
            console.log('[showCompositionMenu] Called');

            // 切換到 workspace 布局
            toggleLayout('workspace');

            // 取得元素
            const viewCanvas = document.getElementById('view-canvas');
            const workspaceContent = document.getElementById('workspace-content');
            const toolOverlay = document.getElementById('tool-selector-overlay');
            const studioWorkspace = document.getElementById('studio-workspace');

            // 隱藏所有視圖
            const allViews = document.querySelectorAll('[id^="view-"]');
            allViews.forEach(view => view.classList.add('hidden'));

            // 將 view-canvas 移動到 workspace-content 並顯示
            if (viewCanvas && workspaceContent) {
                workspaceContent.appendChild(viewCanvas);
                viewCanvas.classList.add('absolute', 'inset-0', 'w-full', 'h-full', 'bg-[#020205]', 'overflow-hidden');
                viewCanvas.classList.remove('hidden');
            }

            // 顯示工具選單，隱藏工作區
            if (toolOverlay) toolOverlay.classList.remove('hidden');
            if (studioWorkspace) {
                studioWorkspace.classList.add('hidden');
                studioWorkspace.classList.remove('flex');
            }

            localStorage.setItem('currentView', 'canvas');
            currentView = 'canvas';

            // 同步導航狀態
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id === 'canvas') item.classList.add('active');
            });

            lucide.createIcons();
        }

        function hideCompositionMenu() {
            console.log('[hideCompositionMenu] Called');

            const toolOverlay = document.getElementById('tool-selector-overlay');
            const studioWorkspace = document.getElementById('studio-workspace');

            // 如果沒有選擇過工具，返回 Dashboard
            if (!currentTool) {
                navigateTo('dashboard');
                return;
            }

            // 隱藏選單，顯示工作區
            if (toolOverlay) toolOverlay.classList.add('hidden');
            if (studioWorkspace) {
                studioWorkspace.classList.remove('hidden');
                studioWorkspace.classList.add('flex');
            }

            localStorage.setItem('currentView', 'canvas');
        }

        // ==========================================
        // Aspect Ratio & Batch Size
        // ==========================================
        function updateAspectRatio(ratio) {
            currentRatio = ratio;
            document.querySelectorAll('.ratio-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.ratio === ratio);
                btn.classList.toggle('text-gray-400', btn.dataset.ratio !== ratio);
            });
        }

        function setBatchSize(size) {
            currentBatchSize = size;
            document.querySelectorAll('.batch-btn').forEach(btn => {
                const isActive = btn.dataset.batch === String(size);
                btn.className = `batch-btn flex-1 py-2 rounded-lg text-sm font-medium ${isActive ? 'bg-purple-500/20 border border-purple-500/50 text-white' : 'bg-black/30 border border-white/10 text-gray-400'}`;
            });
        }

        // ==========================================
        // Video Studio Menu Control
        // ==========================================
        function showVideoToolMenu() {
            console.log('[showVideoToolMenu] Called');

            // 切換到 workspace 布局
            toggleLayout('workspace');

            // 取得元素
            const viewMotion = document.getElementById('view-motion');
            const workspaceContent = document.getElementById('workspace-content');
            const videoOverlay = document.getElementById('video-tool-selector-overlay');
            const videoWorkspace = document.getElementById('video-workspace');

            // 隱藏所有視圖
            const allViews = document.querySelectorAll('[id^="view-"]');
            allViews.forEach(view => view.classList.add('hidden'));

            // 將 view-motion 移動到 workspace-content 並顯示
            if (viewMotion && workspaceContent) {
                workspaceContent.appendChild(viewMotion);
                viewMotion.classList.add('absolute', 'inset-0', 'w-full', 'h-full', 'bg-[#020205]', 'overflow-hidden');
                viewMotion.classList.remove('hidden');
            }

            // 顯示工具選單，隱藏工作區
            if (videoOverlay) videoOverlay.classList.remove('hidden');
            if (videoWorkspace) {
                videoWorkspace.classList.add('hidden');
                videoWorkspace.classList.remove('flex');
            }

            localStorage.setItem('currentView', 'motion');
            currentView = 'motion';

            // 同步導航狀態
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id === 'motion') item.classList.add('active');
            });

            // 初始化 Motion Shots UI
            if (document.getElementById('motion-shots-upload')) {
                initMotionShotsUI();
            }

            lucide.createIcons();
        }

        function hideVideoToolMenu() {
            console.log('[hideVideoToolMenu] Called');

            const videoOverlay = document.getElementById('video-tool-selector-overlay');
            const videoWorkspace = document.getElementById('video-workspace');

            // 如果沒有選擇過工具，返回 Dashboard
            if (!currentVideoTool) {
                navigateTo('dashboard');
                return;
            }

            // 隱藏選單，顯示工作區
            if (videoOverlay) videoOverlay.classList.add('hidden');
            if (videoWorkspace) {
                videoWorkspace.classList.remove('hidden');
                videoWorkspace.classList.add('flex');
            }

            localStorage.setItem('currentView', 'motion');
        }

        function selectVideoTool(toolId) {
            console.log('[selectVideoTool] Selecting:', toolId);
            currentVideoTool = toolId;
            hideVideoToolMenu();
            // Update panels
            ['veo3_long_video', 't2v_veo3', 'flf_veo3'].forEach(id => {
                const panel = document.getElementById(`panel-${id}`);
                if (panel) panel.classList.toggle('hidden', id !== toolId);
            });
            // Update header
            const names = { veo3_long_video: '長片生成', t2v_veo3: '文字轉影片', flf_veo3: '首尾禎動畫' };
            const descs = { veo3_long_video: 'Multi-Shot', t2v_veo3: 'Text to Video', flf_veo3: 'First-Last Frame' };
            document.getElementById('video-tool-name').textContent = names[toolId] || '';
            document.getElementById('video-tool-desc').textContent = descs[toolId] || '';
            lucide.createIcons();
        }

        // Veo3 Mode Toggle
        window.veo3MultiMode = false; // Default to Single Mode
        function toggleVeo3Mode() {
            window.veo3MultiMode = !window.veo3MultiMode;
            const modeLabel = document.getElementById('mode-label');
            const singlePrompt = document.getElementById('motion-single-prompt');
            const multiPrompts = document.getElementById('motion-multi-prompts');
            const toggleBtn = document.getElementById('toggle-veo3-mode');

            console.log('[Video Studio] Toggling mode to:', window.veo3MultiMode ? 'Multi' : 'Single');

            if (window.veo3MultiMode) {
                // Switch to Multi Mode
                modeLabel.textContent = '切換至單段模式';
                if (toggleBtn && toggleBtn.querySelector('i')) {
                    toggleBtn.querySelector('i').setAttribute('data-lucide', 'layout');
                }
                if (singlePrompt) {
                    singlePrompt.style.display = 'none';
                }
                if (multiPrompts) {
                    multiPrompts.classList.remove('hidden');
                    multiPrompts.style.display = 'flex';
                }
            } else {
                // Switch to Single Mode
                modeLabel.textContent = '切換至多段模式';
                if (toggleBtn && toggleBtn.querySelector('i')) {
                    toggleBtn.querySelector('i').setAttribute('data-lucide', 'layers');
                }
                if (singlePrompt) {
                    singlePrompt.style.display = 'flex';
                }
                if (multiPrompts) {
                    multiPrompts.classList.add('hidden');
                    multiPrompts.style.display = 'none';
                }
            }
            lucide.createIcons();
        }

        function updateMultiPrompts() {
            const container = document.getElementById('veo3-multi-prompts');
            if (!container) return;

            // 清除現有內容（保留標題）
            const existingPrompts = container.querySelectorAll('.shot-prompt-input');
            existingPrompts.forEach(el => el.remove());

            // 為有圖片的 shot 添加 prompt 輸入框
            for (let i = 1; i <= 5; i++) {
                const preview = document.getElementById(`motion-preview-${i}`);
                if (preview && !preview.classList.contains('hidden')) {
                    const promptDiv = document.createElement('div');
                    promptDiv.className = 'shot-prompt-input';
                    promptDiv.innerHTML = `
                        <label class="text-xs text-gray-400 mb-1 block">Shot ${i} Prompt</label>
                        <textarea id="motion-prompt-${i}" 
                            class="w-full custom-input rounded-lg p-2 text-xs resize-none h-12" 
                            placeholder="Describe shot ${i}..."></textarea>
                    `;
                    container.appendChild(promptDiv);
                }
            }
        }

        // Motion Shots UI
        function initMotionShotsUI() {
            const container = document.getElementById('motion-shots-upload');
            if (!container) return;
            container.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                container.innerHTML += `
                    <div id="motion-shot-${i}" class="upload-zone rounded-lg p-3 flex items-center gap-3 cursor-pointer" onclick="triggerMotionShot(${i})">
                        <input type="file" id="motion-file-${i}" class="hidden" accept="image/*" onchange="handleMotionShotSelect(event, ${i})" />
                        <div id="motion-preview-${i}" class="hidden w-12 h-12 rounded-lg overflow-hidden">
                            <img src="" class="w-full h-full object-cover" />
                        </div>
                        <div id="motion-placeholder-${i}" class="flex items-center gap-2">
                            <i data-lucide="image" class="w-5 h-5 text-gray-400"></i>
                            <span class="text-sm text-gray-400">Shot ${i}</span>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function triggerMotionShot(num) {
            document.getElementById(`motion-file-${num}`).click();
        }

        function handleMotionShotSelect(event, num) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById(`motion-preview-${num}`);
                const placeholder = document.getElementById(`motion-placeholder-${num}`);
                const zone = document.getElementById(`motion-shot-${num}`);
                preview.querySelector('img').src = e.target.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                zone.classList.add('has-image');

                // 如果是 Multi Mode，更新 prompt 輸入框
                if (!window.veo3SingleMode) {
                    updateMultiPrompts();
                }
            };
            reader.readAsDataURL(file);
        }

        // FLF Upload
        function triggerFLFUpload(frameType) {
            document.getElementById(`file-${frameType}`).click();
        }

        function handleFLFSelect(event, frameType) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById(`preview-${frameType}`);
                const placeholder = document.getElementById(`placeholder-${frameType}`);
                const zone = document.getElementById(`zone-${frameType}`);
                preview.querySelector('img').src = e.target.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                zone.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        function clearFLFImage(frameType) {
            const preview = document.getElementById(`preview-${frameType}`);
            const placeholder = document.getElementById(`placeholder-${frameType}`);
            const zone = document.getElementById(`zone-${frameType}`);
            const fileInput = document.getElementById(`file-${frameType}`);
            if (preview) preview.classList.add('hidden');
            if (placeholder) placeholder.classList.remove('hidden');
            if (zone) zone.classList.remove('has-image');
            if (fileInput) fileInput.value = '';
        }

        // 辅助函数：将文件转换为 Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Motion Generate
        async function handleMotionGenerate() {
            console.log('[Motion] Generate triggered, currentVideoTool:', currentVideoTool);
            const statusEl = document.getElementById('motion-status');
            const btn = document.getElementById('btn-motion-generate') || document.getElementById('btn-motion-generate-multi');

            // 获取 prompt，优先使用 motion-prompt-input
            let prompt = document.getElementById('motion-prompt-input')?.value || '';

            statusEl.classList.remove('hidden');
            statusEl.textContent = '正在處理...';
            statusEl.className = 'text-sm text-center text-amber-400';

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';

            try {
                let workflow = '';
                let payload = {
                    images: {},
                    prompt: prompt
                };

                if (currentVideoTool === 'flf_veo3') {
                    workflow = 'FLF';
                    const firstFrame = document.getElementById('file-first_frame')?.files[0];
                    const lastFrame = document.getElementById('file-last_frame')?.files[0];

                    if (!firstFrame || !lastFrame) {
                        throw new Error('請上傳首尾幀圖片');
                    }

                    // 转换为 Base64
                    payload.images.first_frame = await fileToBase64(firstFrame);
                    payload.images.last_frame = await fileToBase64(lastFrame);

                } else if (currentVideoTool === 't2v_veo3') {
                    workflow = 'T2V';

                    if (!prompt) {
                        throw new Error('請輸入提示詞');
                    }

                } else if (currentVideoTool === 'veo3_long_video') {
                    workflow = 'veo3_long_video';
                    const isMultiMode = window.veo3MultiMode || false;

                    if (isMultiMode) {
                        // Multi Mode: 使用 veo3-segment-0 到 veo3-segment-4
                        const prompts = [];
                        for (let i = 0; i < 5; i++) {
                            const segmentInput = document.getElementById(`veo3-segment-${i}`);
                            if (segmentInput && segmentInput.value.trim()) {
                                prompts.push(segmentInput.value.trim());
                            }
                        }

                        if (prompts.length > 0) {
                            payload.prompts = prompts;
                            delete payload.prompt;
                        }
                    }

                    // 收集所有上傳的圖片
                    let shotCount = 0;
                    for (let i = 1; i <= 5; i++) {
                        const file = document.getElementById(`motion-file-${i}`)?.files[0];
                        if (file) {
                            payload.images[`shot${i}`] = await fileToBase64(file);
                            shotCount++;
                        }
                    }

                    if (shotCount === 0) {
                        throw new Error('請至少上傳一個鏡頭');
                    }

                    payload.mode = isMultiMode ? 'multi' : 'single';
                }

                payload.workflow = workflow;

                const response = await fetch(`${API_URL}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.job_id) {
                    statusEl.textContent = '任務已提交，正在生成...';
                    pollMotionStatus(data.job_id, btn, originalHTML);
                } else {
                    throw new Error('No job_id received');
                }
            } catch (error) {
                console.error('Motion generation error:', error);
                statusEl.textContent = `錯誤: ${error.message}`;
                statusEl.className = 'text-sm text-center text-red-400';
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.innerHTML = originalHTML;
            }
        }

        function pollMotionStatus(jobId, btn, originalHTML) {
            const statusEl = document.getElementById('motion-status');
            let pollCount = 0;
            const maxPolls = 1200;

            const interval = setInterval(async () => {
                pollCount++;
                if (pollCount > maxPolls) {
                    clearInterval(interval);
                    statusEl.textContent = '生成超時';
                    statusEl.className = 'text-sm text-center text-red-400';
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML = originalHTML;
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/status/${jobId}`, {
                        credentials: 'include'
                    });
                    const data = await response.json();

                    if (data.status === 'finished') {
                        clearInterval(interval);
                        statusEl.textContent = '生成完成！';
                        statusEl.className = 'text-sm text-center text-green-400';

                        // 🔧 修復：後端返回 image_url，需要處理完整路徑
                        const outputPath = data.image_url || data.output_path || data.result;
                        if (outputPath) {
                            let fullVideoUrl = outputPath;
                            if (!outputPath.startsWith('http')) {
                                const filename = outputPath.split('/').pop().split('\\').pop();
                                fullVideoUrl = `${API_URL}/outputs/${filename}`;
                            }
                            showMotionResult(fullVideoUrl);
                        } else {
                            statusEl.textContent = '⚠️ 生成完成但未返回輸出路徑';
                            statusEl.className = 'text-sm text-center text-yellow-400';
                        }

                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        btn.innerHTML = originalHTML;
                    } else if (data.status === 'failed') {
                        clearInterval(interval);
                        statusEl.textContent = `生成失敗: ${data.error || '未知錯誤'}`;
                        statusEl.className = 'text-sm text-center text-red-400';
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        btn.innerHTML = originalHTML;
                    } else if (data.status === 'processing') {
                        statusEl.textContent = `處理中... (${data.progress || 0}%)`;
                    } else if (data.status === 'queued') {
                        statusEl.textContent = '排隊中...';
                    }
                } catch (error) {
                    console.error('Poll error:', error);
                }
            }, 2000);
        }

        function showMotionResult(videoUrl) {
            const resultsDiv = document.getElementById('motion-results');
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = `
                <div class="glass-card rounded-xl p-4">
                    <video controls class="w-full rounded-xl mb-4" src="${videoUrl}">
                        您的瀏覽器不支持視頻播放。
                    </video>
                    <a href="${videoUrl}" download class="block w-full px-4 py-2 bg-amber-600 hover:bg-amber-700 rounded-xl text-center transition-colors">
                        下載視頻
                    </a>
                </div>
            `;
        }

        // ==========================================
        // Avatar Studio
        // ==========================================
        let avatarImage = null;
        let avatarAudio = null;

        function triggerAvatarImageUpload() {
            document.getElementById('avatar-image-input').click();
        }

        function handleAvatarImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            avatarImage = file;
            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById('avatar-image-preview');
                const placeholder = document.getElementById('avatar-image-placeholder');
                const zone = document.getElementById('avatar-image-zone');
                preview.querySelector('img').src = e.target.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                zone.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        function clearAvatarImage() {
            avatarImage = null;
            document.getElementById('avatar-image-preview').classList.add('hidden');
            document.getElementById('avatar-image-placeholder').classList.remove('hidden');
            document.getElementById('avatar-image-zone').classList.remove('has-image');
            document.getElementById('avatar-image-input').value = '';
        }

        function triggerAvatarAudioUpload() {
            document.getElementById('avatar-audio-input').click();
        }

        function handleAvatarAudioSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            avatarAudio = file;
            document.getElementById('avatar-audio-filename').textContent = file.name;
            document.getElementById('avatar-audio-preview').classList.remove('hidden');
            document.getElementById('avatar-audio-placeholder').classList.add('hidden');
            document.getElementById('avatar-audio-zone').classList.add('has-image');
        }

        function clearAvatarAudio() {
            avatarAudio = null;
            document.getElementById('avatar-audio-preview').classList.add('hidden');
            document.getElementById('avatar-audio-placeholder').classList.remove('hidden');
            document.getElementById('avatar-audio-zone').classList.remove('has-image');
            document.getElementById('avatar-audio-input').value = '';
        }

        async function generateAvatarVideo() {
            console.log('[Avatar] Generate triggered');
            const statusEl = document.getElementById('avatar-status');
            const btn = document.getElementById('avatar-generate-btn');

            if (!avatarImage || !avatarAudio) {
                statusEl.classList.remove('hidden');
                statusEl.textContent = '請上傳頭像圖片和音頻文件';
                statusEl.className = 'mt-4 p-4 rounded-xl text-center bg-red-500/10 text-red-400';
                return;
            }

            statusEl.classList.remove('hidden');
            statusEl.textContent = '正在處理...';
            statusEl.className = 'mt-4 p-4 rounded-xl text-center bg-blue-500/10 text-blue-400';

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';

            try {
                // 转换文件为 Base64
                const imageBase64 = await fileToBase64(avatarImage);
                const audioBase64 = await fileToBase64(avatarAudio);

                // 获取 prompt
                const prompt = document.getElementById('avatar-prompt-input')?.value || '';

                const payload = {
                    workflow: 'virtual_human',
                    prompt: prompt,
                    images: {
                        avatar: imageBase64
                    },
                    audio: audioBase64
                };

                const response = await fetch(`${API_URL}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.job_id) {
                    statusEl.textContent = '任務已提交，正在生成...';
                    pollAvatarStatus(data.job_id, btn, originalHTML);
                } else {
                    throw new Error('No job_id received');
                }
            } catch (error) {
                console.error('Avatar generation error:', error);
                statusEl.textContent = `錯誤: ${error.message}`;
                statusEl.className = 'mt-4 p-4 rounded-xl text-center bg-red-500/10 text-red-400';
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.innerHTML = originalHTML;
            }
        }

        function pollAvatarStatus(jobId, btn, originalHTML) {
            const statusEl = document.getElementById('avatar-status');
            let pollCount = 0;
            const maxPolls = 1200;

            const interval = setInterval(async () => {
                pollCount++;
                if (pollCount > maxPolls) {
                    clearInterval(interval);
                    statusEl.textContent = '生成超時';
                    statusEl.className = 'mt-4 p-4 rounded-xl text-center bg-red-500/10 text-red-400';
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML = originalHTML;
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/status/${jobId}`, {
                        credentials: 'include'
                    });
                    const data = await response.json();

                    if (data.status === 'finished') {
                        clearInterval(interval);
                        statusEl.textContent = '生成完成！';
                        statusEl.className = 'mt-4 p-4 rounded-xl text-center bg-green-500/10 text-green-400';

                        // 🔧 修復：後端返回 image_url，需要處理完整路徑
                        const outputPath = data.image_url || data.output_path || data.result;
                        if (outputPath) {
                            // 處理路徑：如果是相對路徑，加上 API_URL 前綴
                            let fullVideoUrl = outputPath;
                            if (!outputPath.startsWith('http')) {
                                const filename = outputPath.split('/').pop().split('\\').pop();
                                fullVideoUrl = `${API_URL}/outputs/${filename}`;
                            }
                            showAvatarResult(fullVideoUrl);
                        } else {
                            statusEl.textContent = '⚠️ 生成完成但未返回輸出路徑';
                            statusEl.className = 'mt-4 p-4 rounded-xl text-center bg-yellow-500/10 text-yellow-400';
                        }

                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        btn.innerHTML = originalHTML;
                    } else if (data.status === 'failed') {
                        clearInterval(interval);
                        statusEl.textContent = `生成失敗: ${data.error || '未知錯誤'}`;
                        statusEl.className = 'mt-4 p-4 rounded-xl text-center bg-red-500/10 text-red-400';
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        btn.innerHTML = originalHTML;
                    } else if (data.status === 'processing') {
                        statusEl.textContent = `處理中... (${data.progress || 0}%)`;
                    } else if (data.status === 'queued') {
                        statusEl.textContent = '排隊中...';
                    }
                } catch (error) {
                    console.error('Poll error:', error);
                }
            }, 2000);
        }

        function showAvatarResult(videoUrl) {
            // 更新右側預覽區狀態
            const previewStatus = document.getElementById('avatar-preview-status');
            if (previewStatus) {
                previewStatus.textContent = '✅ 生成完成';
                previewStatus.className = 'text-xs text-emerald-400';
            }

            // 隱藏 placeholder，顯示 video wrapper
            const placeholder = document.getElementById('avatar-preview-placeholder');
            const videoWrapper = document.getElementById('avatar-video-wrapper');
            const videoPlayer = document.getElementById('avatar-video-player');
            const downloadBtn = document.getElementById('avatar-download-btn');

            if (placeholder) placeholder.classList.add('hidden');
            if (videoWrapper) videoWrapper.classList.remove('hidden');

            // 設置影片來源
            if (videoPlayer) {
                videoPlayer.src = videoUrl;
                videoPlayer.load();
            }

            // 設置下載連結
            if (downloadBtn) {
                downloadBtn.href = videoUrl;
                // 從 URL 提取檔名
                const filename = videoUrl.split('/').pop().split('\\').pop() || 'avatar_video.mp4';
                downloadBtn.download = filename;
            }

            // 更新 Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // 兼容舊版：同時更新 legacy results div
            const resultsDiv = document.getElementById('avatar-results');
            if (resultsDiv) {
                resultsDiv.classList.remove('hidden');
                resultsDiv.innerHTML = `
                    <div class="glass-card rounded-xl p-4">
                        <video controls class="w-full rounded-xl mb-4" src="${videoUrl}">
                            您的瀏覽器不支持視頻播放。
                        </video>
                        <a href="${videoUrl}" download class="block w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-xl text-center transition-colors">
                            下載視頻
                        </a>
                    </div>
                `;
            }
        }

        // ==========================================
        // Gallery
        // ==========================================
        async function loadHistory() {
            console.log('[Gallery] Loading history...');
            const grid = document.getElementById('gallery-grid');
            if (!grid) return;
            grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500"><i data-lucide="loader" class="w-8 h-8 mx-auto mb-4 animate-spin"></i><p>載入歷史記錄中...</p></div>';
            lucide.createIcons();
            try {
                const response = await fetch(`${API_BASE}/api/history`, { credentials: 'include' });
                const data = await response.json();
                // 支援兩種回應格式：data.history 或 data.jobs
                const items = data.history || data.jobs || [];
                if (items.length > 0) {
                    grid.innerHTML = items.map(item => `
                        <div class="glass-card rounded-xl overflow-hidden group">
                            <div class="aspect-square relative">
                                <img src="${item.output_url || item.output_path || '/static/placeholder.png'}" alt="${item.tool || item.workflow}" class="w-full h-full object-cover" />
                                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                                    <a href="${item.output_url || item.output_path}" target="_blank" class="p-2 rounded-lg bg-white/20 hover:bg-white/30"><i data-lucide="external-link" class="w-5 h-5"></i></a>
                                </div>
                            </div>
                            <div class="p-4">
                                <div class="text-sm font-bold text-white mb-1">${item.tool || item.workflow}</div>
                                <div class="text-xs text-gray-500">${new Date(item.created_at).toLocaleString()}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4"></i><p>目前沒有歷史記錄</p></div>';
                }
                lucide.createIcons();
            } catch (error) {
                console.error('[Gallery] Error:', error);
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-red-400"><i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-4"></i><p>載入失敗</p></div>';
                lucide.createIcons();
            }
        }

        // ==========================================
        // Generate 功能 - 核心 API 通訊
        // ==========================================

        // 工具輪詢間隔管理
        const toolPollingIntervals = {};

        /**
         * 處理生成請求
         */
        async function handleGenerate(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            console.log('[Generate] 開始處理...');

            if (!currentTool) {
                showStatus('⚠️ 請先選擇一個工具', 'warning');
                return Promise.reject('No tool selected');
            }

            const btn = document.getElementById('btn-generate');
            if (!btn) {
                console.error('[Generate] 找不到 Generate 按鈕');
                return Promise.reject('Button not found');
            }

            const promptInput = document.getElementById('prompt-input');
            const seedInput = document.getElementById('seed-input');
            const modelSelect = document.getElementById('model-select');

            const prompt = promptInput ? promptInput.value.trim() : '';
            const seed = seedInput ? (parseInt(seedInput.value) || -1) : -1;
            const model = modelSelect ? modelSelect.value : 'turbo_fp8';

            // 驗證輸入
            if (!prompt && currentTool === 'text_to_image') {
                showStatus('⚠️ Please enter a prompt', 'warning');
                return Promise.reject('No prompt');
            }

            // 驗證圖片上傳
            const config = toolConfig[currentTool];
            if (config && config.uploads) {
                for (const upload of config.uploads) {
                    if (!uploadedImages[upload.id]) {
                        showStatus(`⚠️ Please upload ${upload.label}`, 'warning');
                        return Promise.reject('Missing image upload');
                    }
                }
            }

            // 禁用按鈕並顯示載入狀態
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed');
            btn.innerHTML = `
                <div class="flex gap-1 items-center">
                    <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
                <span>Processing...</span>
            `;

            showStatus('📤 Sending request...', 'info');

            try {
                // 標記當前工具正在生成
                window.toolStates[currentTool].isGenerating = true;
                saveToolState(currentTool);

                // 構建 payload
                let payload = {
                    workflow: currentTool,
                    prompt: prompt,
                    seed: seed,
                    model: model,
                    aspect_ratio: currentRatio,
                    batch_size: currentBatchSize,
                    images: uploadedImages
                };

                // 發送 API 請求
                const response = await fetch(`${API_BASE}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const jobId = data.job_id;

                showStatus(`⏳ Job queued: ${jobId.substring(0, 8)}...`, 'info');

                // 開始輪詢狀態
                pollStatus(jobId, btn, originalHTML, currentTool);

            } catch (error) {
                console.error('Generate error:', error);
                showStatus(`❌ Error: ${error.message}`, 'error');
                restoreButton(btn, originalHTML);
                window.toolStates[currentTool].isGenerating = false;
                return Promise.reject(error);
            }

            return Promise.resolve();
        }

        /**
         * 輪詢任務狀態
         */
        function pollStatus(jobId, btn, originalHTML, toolName) {
            if (toolPollingIntervals[toolName]) {
                clearInterval(toolPollingIntervals[toolName]);
            }

            let pollCount = 0;
            const maxPolls = 1200;

            console.log(`[Poll] 開始輪詢 ${toolName} 的任務: ${jobId}`);

            toolPollingIntervals[toolName] = setInterval(async () => {
                pollCount++;

                if (pollCount > maxPolls) {
                    clearInterval(toolPollingIntervals[toolName]);
                    delete toolPollingIntervals[toolName];

                    if (currentTool === toolName) {
                        showStatus('⏰ 超時: 生成時間超過40分鐘', 'warning');
                        restoreButton(btn, originalHTML);
                    }
                    window.toolStates[toolName].isGenerating = false;
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/status/${jobId}`, {
                        credentials: 'include'
                    });
                    if (!response.ok) throw new Error('Status check failed');

                    const data = await response.json();

                    if (data.status === 'processing') {
                        showStatus(`🔄 Processing... ${data.progress || 0}%`, 'info');
                    } else if (data.status === 'queued') {
                        showStatus('⏳ Waiting in queue...', 'info');
                    } else if (data.status === 'finished') {
                        clearInterval(toolPollingIntervals[toolName]);
                        delete toolPollingIntervals[toolName];

                        const outputPath = data.image_url || data.output_path;
                        if (outputPath) {
                            const filename = outputPath.split('/').pop().split('\\').pop();
                            const imageUrl = `${API_BASE}/outputs/${filename}`;

                            if (currentTool === toolName) {
                                showResult(imageUrl);
                                showStatus('✅ Generation complete!', 'success');
                                restoreButton(btn, originalHTML);
                            } else {
                                // 保存結果到該工具的狀態
                                const tempCanvasHtml = `
                                    <div class="relative group flex flex-col items-center">
                                        <div class="relative overflow-hidden rounded-2xl border border-white/10 shadow-2xl">
                                            <img src="${imageUrl}" alt="Generated Image" 
                                                 class="max-w-full max-h-[60vh] object-contain" />
                                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                                <a href="${imageUrl}" download class="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl font-bold text-white flex items-center gap-2 hover:brightness-110 transition-all shadow-lg">
                                                    <i data-lucide="download" class="w-5 h-5"></i>
                                                    <span>下載圖片</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                window.toolStates[toolName].canvasHtml = tempCanvasHtml;
                                window.toolStates[toolName].canvasHidden = false;
                            }
                        } else {
                            if (currentTool === toolName) {
                                showStatus('⚠️ Finished but no image path returned', 'warning');
                            }
                        }

                        window.toolStates[toolName].isGenerating = false;

                    } else if (data.status === 'failed') {
                        clearInterval(toolPollingIntervals[toolName]);
                        delete toolPollingIntervals[toolName];

                        if (currentTool === toolName) {
                            showStatus(`❌ Failed: ${data.error || 'Unknown error'}`, 'error');
                            restoreButton(btn, originalHTML);
                        }
                        window.toolStates[toolName].isGenerating = false;
                    }

                } catch (error) {
                    console.error('Poll error:', error);
                    showStatus(`🔄 Checking status... (retry ${pollCount})`, 'info');
                }

            }, 2000);
        }

        /**
         * 顯示生成結果
         */
        function showResult(imageUrl) {
            const canvasPlaceholder = document.getElementById('canvas-placeholder');
            const canvasResults = document.getElementById('canvas-results');
            const resultsGrid = document.getElementById('results-grid');

            if (!resultsGrid) return;

            resultsGrid.innerHTML = `
                <div class="relative group flex flex-col items-center">
                    <div class="relative overflow-hidden rounded-2xl border border-white/10 shadow-2xl">
                        <img src="${imageUrl}" alt="Generated Image" 
                             class="max-w-full max-h-[60vh] object-contain" />
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <a href="${imageUrl}" download class="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl font-bold text-white flex items-center gap-2 hover:brightness-110 transition-all shadow-lg">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                <span>下載圖片</span>
                            </a>
                        </div>
                    </div>
                </div>
            `;

            if (canvasPlaceholder) canvasPlaceholder.classList.add('hidden');
            if (canvasResults) canvasResults.classList.remove('hidden');

            lucide.createIcons();
        }

        /**
         * 顯示狀態訊息
         */
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            if (!statusDiv) return;

            statusDiv.textContent = message;
            statusDiv.className = 'text-sm text-center transition-opacity';

            switch (type) {
                case 'warning':
                    statusDiv.classList.add('text-amber-400');
                    break;
                case 'error':
                    statusDiv.classList.add('text-red-400');
                    break;
                case 'success':
                    statusDiv.classList.add('text-green-400');
                    break;
                default:
                    statusDiv.classList.add('text-gray-400');
            }

            statusDiv.classList.remove('hidden');

            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
        }

        /**
         * 恢復按鈕狀態
         */
        function restoreButton(btn, originalHTML) {
            if (!btn) return;
            btn.disabled = false;
            btn.classList.remove('opacity-70', 'cursor-not-allowed');
            btn.innerHTML = originalHTML;
            lucide.createIcons();
        }

        /**
         * 載入模型列表
         */
        async function fetchModels() {
            const modelSelect = document.getElementById('model-select');
            if (!modelSelect) return;

            try {
                console.log('[Models] 獲取模型列表...');
                const response = await fetch(`${API_BASE}/api/models`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('[Models] 獲取成功:', data);

                modelSelect.innerHTML = '';

                const unetModels = data.unet_models || [];
                const checkpointModels = data.models || [];

                if (unetModels.length > 0) {
                    const unetGroup = document.createElement('optgroup');
                    unetGroup.label = 'UNET Models';
                    unetModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model.split('/').pop().replace('.safetensors', '');
                        unetGroup.appendChild(option);
                    });
                    modelSelect.appendChild(unetGroup);
                }

                if (checkpointModels.length > 0) {
                    const ckptGroup = document.createElement('optgroup');
                    ckptGroup.label = 'Checkpoint Models';
                    checkpointModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model.split('/').pop().replace('.safetensors', '');
                        ckptGroup.appendChild(option);
                    });
                    modelSelect.appendChild(ckptGroup);
                }

                if (unetModels.length === 0 && checkpointModels.length === 0) {
                    modelSelect.innerHTML = '<option value="">No models available</option>';
                }

            } catch (error) {
                console.error('[Models] 獲取失敗:', error);
                modelSelect.innerHTML = '<option value="">Failed to load models</option>';
            }
        }

        // ==========================================
        // 綁定按鈕事件
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            // 綁定 Generate 按鈕
            const btnGenerate = document.getElementById('btn-generate');
            if (btnGenerate) {
                btnGenerate.addEventListener('click', handleGenerate);
                console.log('[Init] Generate 按鈕事件已綁定');
            }

            // 綁定 Enhance 按鈕
            const btnEnhance = document.getElementById('btn-enhance');
            if (btnEnhance) {
                btnEnhance.addEventListener('click', () => {
                    showStatus('⏳ AI 優化功能開發中...', 'info');
                });
            }

            // 載入模型列表
            fetchModels();
        });

        // ESC key handler
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const imageOverlay = document.getElementById('tool-selector-overlay');
                const videoOverlay = document.getElementById('video-tool-selector-overlay');
                if (imageOverlay && !imageOverlay.classList.contains('hidden')) {
                    hideCompositionMenu();
                } else if (videoOverlay && !videoOverlay.classList.contains('hidden')) {
                    hideVideoToolMenu();
                }
            }
        });
    </script>

</body>

</html>