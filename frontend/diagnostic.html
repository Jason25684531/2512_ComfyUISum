<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿè¯Šæ–­é¢æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">ğŸ” ComfyUI Studio è¯Šæ–­é¢æ¿</h1>
        
        <!-- 1. Worker çŠ¶æ€æ£€æŸ¥ -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">1. Worker çŠ¶æ€æ£€æŸ¥ âš ï¸ æœ€é‡è¦</h2>
            <p class="text-gray-400 mb-4">Worker å¿…é¡»è¿è¡Œæ‰èƒ½å¤„ç†ä»»åŠ¡</p>
            <div class="bg-black p-4 rounded font-mono text-sm mb-4">
                <div class="text-green-400"># åœ¨æ–°çš„ PowerShell ç»ˆç«¯è¿è¡Œ:</div>
                <div class="text-yellow-400">cd D:\01_Project\2512_ComfyUISum</div>
                <div class="text-yellow-400">python worker/src/main.py</div>
            </div>
            <div class="text-sm text-gray-500">
                <strong>æˆåŠŸæ ‡å¿—:</strong><br>
                <code>[Worker] âœ… Redis é€£æ¥æˆåŠŸ</code><br>
                <code>[Worker] âœ… ComfyUI é€£æ¥æˆåŠŸ</code><br>
                <code>[Worker] ç­‰å¾…ä»»å‹™ä¸­...</code>
            </div>
        </div>

        <!-- 2. æœåŠ¡è¿æ¥æµ‹è¯• -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">2. æœåŠ¡è¿æ¥æµ‹è¯•</h2>
            <div class="space-y-3">
                <button onclick="testBackend()" class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">
                    æµ‹è¯• Backend API (http://127.0.0.1:5000)
                </button>
                <button onclick="testComfyUI()" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                    æµ‹è¯• ComfyUI API (http://127.0.0.1:8188)
                </button>
                <button onclick="testHistory()" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                    æµ‹è¯• History API (/api/history)
                </button>
            </div>
            <div id="test-result" class="mt-4 p-4 bg-black rounded text-sm font-mono hidden"></div>
        </div>

        <!-- 3. LocalStorage æµ‹è¯• -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">3. LocalStorage è§†å›¾ä¿æŒæµ‹è¯•</h2>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <button onclick="setView('dashboard')" class="flex-1 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">
                        è®¾ç½®: Dashboard
                    </button>
                    <button onclick="setView('gallery')" class="flex-1 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">
                        è®¾ç½®: Gallery
                    </button>
                    <button onclick="setView('canvas')" class="flex-1 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">
                        è®¾ç½®: Canvas
                    </button>
                </div>
                <button onclick="checkView()" class="w-full bg-amber-600 hover:bg-amber-700 px-4 py-2 rounded">
                    è¯»å–å½“å‰ä¿å­˜çš„è§†å›¾
                </button>
                <button onclick="clearView()" class="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded">
                    æ¸…é™¤ LocalStorage
                </button>
            </div>
            <div id="storage-result" class="mt-4 p-4 bg-black rounded text-sm font-mono"></div>
            <p class="text-xs text-gray-500 mt-2">
                ğŸ’¡ æç¤º: è®¾ç½®è§†å›¾ååˆ·æ–°é¡µé¢ï¼Œä¸»é¡µé¢åº”è¯¥ä¿æŒåœ¨è¯¥è§†å›¾
            </p>
        </div>

        <!-- 4. æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥ -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">4. æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥</h2>
            <p class="text-gray-400 mb-2">æ‰“å¼€ä¸»é¡µé¢ï¼ŒæŒ‰ F12ï¼Œæ£€æŸ¥ä»¥ä¸‹å†…å®¹:</p>
            <ul class="list-disc list-inside space-y-2 text-sm text-gray-300">
                <li>æ˜¯å¦æœ‰çº¢è‰²é”™è¯¯ä¿¡æ¯ï¼Ÿ</li>
                <li>æŸ¥æ‰¾ <code class="bg-black px-2 py-1 rounded">[Init]</code> å¼€å¤´çš„æ—¥å¿—</li>
                <li>æŸ¥æ‰¾ <code class="bg-black px-2 py-1 rounded">[Navigation]</code> å¼€å¤´çš„æ—¥å¿—</li>
                <li>åˆ·æ–°åæ˜¯å¦æ˜¾ç¤º: <code class="bg-black px-2 py-1 rounded">[Init] æ¢å¾©ä¸Šæ¬¡è¦–åœ–: xxx</code></li>
            </ul>
        </div>

        <!-- 5. ä»»åŠ¡æäº¤æµ‹è¯• -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4">5. å®Œæ•´æµç¨‹æµ‹è¯•</h2>
            <button onclick="submitTestJob()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 px-4 py-3 rounded font-bold">
                ğŸš€ æäº¤æµ‹è¯•ä»»åŠ¡ (test image)
            </button>
            <div id="job-result" class="mt-4 p-4 bg-black rounded text-sm font-mono hidden"></div>
            <div class="mt-4 text-xs text-gray-500">
                <strong>é¢„æœŸæµç¨‹:</strong><br>
                1. Backend: ä»»åŠ¡æ¨é€åˆ° Redis é˜Ÿåˆ—<br>
                2. Backend: ä»»åŠ¡å†™å…¥ MySQL æ•°æ®åº“<br>
                3. <strong class="text-yellow-400">Worker: ä»é˜Ÿåˆ—æ‹‰å–ä»»åŠ¡ (å¦‚æœ Worker æœªè¿è¡Œï¼Œè¿™é‡Œä¼šå¡ä½)</strong><br>
                4. Worker: æäº¤åˆ° ComfyUI<br>
                5. ComfyUI: ç”Ÿæˆå›¾ç‰‡<br>
                6. Worker: æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º completed<br>
                7. Frontend: è½®è¯¢çŠ¶æ€ï¼Œæ˜¾ç¤ºç»“æœ
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000';
        const COMFYUI_BASE = 'http://127.0.0.1:8188';

        // æµ‹è¯• Backend
        async function testBackend() {
            const result = document.getElementById('test-result');
            result.classList.remove('hidden');
            result.innerHTML = '<div class="text-yellow-400">â³ æµ‹è¯•ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                result.innerHTML = `
                    <div class="text-green-400">âœ… Backend è¿æ¥æˆåŠŸ</div>
                    <pre class="mt-2">${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                result.innerHTML = `<div class="text-red-400">âŒ Backend è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯• ComfyUI
        async function testComfyUI() {
            const result = document.getElementById('test-result');
            result.classList.remove('hidden');
            result.innerHTML = '<div class="text-yellow-400">â³ æµ‹è¯•ä¸­...</div>';
            
            try {
                const response = await fetch(`${COMFYUI_BASE}/system_stats`);
                const data = await response.json();
                result.innerHTML = `
                    <div class="text-green-400">âœ… ComfyUI è¿æ¥æˆåŠŸ</div>
                    <pre class="mt-2">${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                result.innerHTML = `<div class="text-red-400">âŒ ComfyUI è¿æ¥å¤±è´¥: ${error.message}</div>
                <div class="text-gray-400 mt-2">è¯·ç¡®ä¿ ComfyUI å·²å¯åŠ¨åœ¨ http://127.0.0.1:8188</div>`;
            }
        }

        // æµ‹è¯• History API
        async function testHistory() {
            const result = document.getElementById('test-result');
            result.classList.remove('hidden');
            result.innerHTML = '<div class="text-yellow-400">â³ æµ‹è¯•ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/history?limit=5`);
                const data = await response.json();
                result.innerHTML = `
                    <div class="text-green-400">âœ… History API æˆåŠŸ</div>
                    <div class="text-gray-400 mt-2">æ€»è®°å½•: ${data.total} ç¬”</div>
                    <pre class="mt-2">${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                result.innerHTML = `<div class="text-red-400">âŒ History API å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è®¾ç½®è§†å›¾
        function setView(viewName) {
            localStorage.setItem('currentView', viewName);
            checkView();
        }

        // æ£€æŸ¥è§†å›¾
        function checkView() {
            const result = document.getElementById('storage-result');
            const current = localStorage.getItem('currentView');
            result.innerHTML = `
                <div class="text-blue-400">ğŸ“¦ LocalStorage çŠ¶æ€:</div>
                <div class="mt-2">currentView = <span class="text-yellow-400">"${current || '(æœªè®¾ç½®)'}"</span></div>
                ${current ? '<div class="text-green-400 mt-2">âœ… åˆ·æ–°ä¸»é¡µé¢åº”è¯¥ä¿æŒåœ¨: ' + current + '</div>' : ''}
            `;
        }

        // æ¸…é™¤è§†å›¾
        function clearView() {
            localStorage.removeItem('currentView');
            checkView();
        }

        // æäº¤æµ‹è¯•ä»»åŠ¡
        async function submitTestJob() {
            const result = document.getElementById('job-result');
            result.classList.remove('hidden');
            result.innerHTML = '<div class="text-yellow-400">â³ æäº¤ä»»åŠ¡ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: 'diagnostic test image',
                        workflow: 'text_to_image',
                        model: 'sd15',
                        aspect_ratio: '1:1',
                        batch_size: 1,
                        seed: -1
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `
                        <div class="text-green-400">âœ… ä»»åŠ¡æäº¤æˆåŠŸ</div>
                        <div class="mt-2">Job ID: <span class="text-yellow-400">${data.job_id}</span></div>
                        <div class="text-gray-400 mt-4">
                            <strong>ä¸‹ä¸€æ­¥:</strong><br>
                            1. æ£€æŸ¥ Backend ç»ˆç«¯ï¼Œåº”è¯¥çœ‹åˆ°: <code>âœ“ ä»»åŠ¡å·²æ¨é€åˆ°é˜Ÿåˆ—</code><br>
                            2. <strong class="text-yellow-400">æ£€æŸ¥ Worker ç»ˆç«¯ï¼Œåº”è¯¥çœ‹åˆ°: <code>[Worker] ğŸ“¥ æ”¶åˆ°ä»»å‹™</code></strong><br>
                            3. å¦‚æœ Worker æ²¡æœ‰è¾“å‡ºï¼Œè¯´æ˜ Worker æœªè¿è¡Œï¼<br>
                            4. ç­‰å¾… 30 ç§’ï¼Œç„¶ååˆ·æ–°ä¸»é¡µé¢çš„ Gallery æŸ¥çœ‹ç»“æœ
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="text-red-400">âŒ æäº¤å¤±è´¥: ${data.error || response.statusText}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="text-red-400">âŒ æäº¤å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
        window.addEventListener('DOMContentLoaded', () => {
            checkView();
        });
    </script>
</body>
</html>
