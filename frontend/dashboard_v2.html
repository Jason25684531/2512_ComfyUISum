<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIGEN.IO - Creative Studio</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- API Configuration -->
    <script src="config.js"></script>
    <!-- Google Fonts - Orbitron (Tech/Futuristic Font) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <style>
        /* Hide Scrollbar */
        ::-webkit-scrollbar {
            display: none;
        }

        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animations */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Glass Effects */
        .glass-sidebar {
            background: rgba(5, 5, 8, 0.7);
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-card {
            background: rgba(10, 10, 15, 0.5);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .glass-card:hover {
            background: rgba(20, 20, 30, 0.6);
            border-color: rgba(168, 85, 247, 0.5);
            transform: translateY(-4px);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.8), 0 0 20px rgba(168, 85, 247, 0.2);
        }

        /* Tool Icon Styles */
        .tool-icon {
            transition: all 0.3s ease;
        }

        .tool-icon:hover {
            transform: scale(1.05);
        }

        /* Nav Item */
        .nav-item {
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            right: 0;
            top: 20%;
            bottom: 20%;
            width: 3px;
            background: #a78bfa;
            border-radius: 4px 0 0 4px;
            box-shadow: 0 0 10px #a78bfa;
        }

        .nav-item.active {
            background: rgba(168, 85, 247, 0.15);
            color: #a78bfa;
        }

        /* Background Image */
        .bg-image {
            background-image: url('image/BG_v02.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* Status Indicator */
        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .status-dot {
            animation: pulse-dot 2s infinite;
        }

        /* Neon Stroke Flow Animation */
        @keyframes neon-stroke-flow {
            0% {
                filter:
                    drop-shadow(0 0 5px #a855f7) drop-shadow(0 0 10px #a855f7) drop-shadow(0 0 15px #7c3aed);
                -webkit-text-stroke-color: #f3c8ff;
            }

            25% {
                filter:
                    drop-shadow(0 0 8px #c084fc) drop-shadow(0 0 15px #a855f7) drop-shadow(0 0 20px #7c3aed);
                -webkit-text-stroke-color: #e9d5ff;
            }

            50% {
                filter:
                    drop-shadow(0 0 10px #e9d5ff) drop-shadow(0 0 20px #c084fc) drop-shadow(0 0 25px #a855f7);
                -webkit-text-stroke-color: #fae8ff;
            }

            75% {
                filter:
                    drop-shadow(0 0 8px #c084fc) drop-shadow(0 0 15px #a855f7) drop-shadow(0 0 20px #7c3aed);
                -webkit-text-stroke-color: #e9d5ff;
            }

            100% {
                filter:
                    drop-shadow(0 0 5px #a855f7) drop-shadow(0 0 10px #a855f7) drop-shadow(0 0 15px #7c3aed);
                -webkit-text-stroke-color: #f3c8ff;
            }
        }

        .neon-title {
            animation: neon-stroke-flow 4s ease-in-out infinite;
        }

        /* Glass Panel (from old dashboard) */
        .glass-panel {
            background: rgba(5, 5, 8, 0.85);
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed rgba(255, 255, 255, 0.15);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-zone:hover {
            border-color: rgba(168, 85, 247, 0.5);
            background: rgba(168, 85, 247, 0.05);
        }

        .upload-zone.has-image {
            border-style: solid;
            border-color: rgba(168, 85, 247, 0.4);
        }

        /* Aspect Ratio Button */
        .ratio-btn {
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ratio-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .ratio-btn.active {
            border-color: rgba(168, 85, 247, 0.8);
            background: rgba(168, 85, 247, 0.15);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.2);
        }

        /* Grid Background Pattern */
        .grid-bg {
            background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Tool Card */
        .tool-card {
            transition: all 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.8);
        }

        /* Custom Input */
        .custom-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        .custom-input:focus {
            outline: none;
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.1);
        }

        /* Overlay Backdrop */
        .overlay-backdrop {
            animation: overlay-fade-in 0.2s ease-out;
        }

        @keyframes overlay-fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="h-screen w-full flex overflow-hidden bg-[#020205] text-white font-sans selection:bg-purple-500/30">

    <!-- Background Layer (pointer-events-none 確保不會阻擋點擊) -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <!-- Background Image -->
        <div class="absolute inset-0 bg-image"></div>
        <!-- Gradient Overlay -->
        <div class="absolute inset-0 bg-gradient-to-b from-[#020205]/0 via-[#020205]/90 to-[#020205]/100"></div>
        <!-- Noise Texture -->
        <div
            class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-40 mix-blend-overlay">
        </div>
    </div>

    <!-- Left Sidebar (Icon Only) -->
    <aside class="glass-sidebar w-20 flex-shrink-0 flex flex-col h-full z-30 relative">
        <!-- Logo -->
        <div class="h-20 flex items-center justify-center border-b border-white/5">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-600 to-indigo-800 flex items-center justify-center shadow-lg border border-white/10 hover:border-purple-500/50 transition-colors cursor-pointer group">
                <i data-lucide="sparkles" class="text-white w-6 h-6 group-hover:scale-110 transition-transform"></i>
            </div>
        </div>

        <!-- Navigation Icons -->
        <nav class="flex-1 py-6 px-3 space-y-3">
            <button onclick="navigateTo('dashboard')"
                class="nav-item active w-full p-4 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all"
                title="Dashboard">
                <i data-lucide="home" class="w-7 h-7 mx-auto"></i>
            </button>
            <button onclick="navigateTo('canvas')"
                class="nav-item w-full p-4 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all"
                title="Image Studio">
                <i data-lucide="layers" class="w-7 h-7 mx-auto"></i>
            </button>
            <button onclick="navigateTo('motion')"
                class="nav-item w-full p-4 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all"
                title="Video Studio">
                <i data-lucide="film" class="w-7 h-7 mx-auto"></i>
            </button>
            <button onclick="navigateTo('avatar')"
                class="nav-item w-full p-4 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all"
                title="Avatar Studio">
                <i data-lucide="user-circle-2" class="w-7 h-7 mx-auto"></i>
            </button>
            <div class="h-[1px] bg-white/10 my-4"></div>
            <button onclick="navigateTo('gallery')"
                class="nav-item w-full p-4 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all"
                title="Gallery">
                <i data-lucide="image" class="w-7 h-7 mx-auto"></i>
            </button>
        </nav>

        <!-- Bottom: System Status -->
        <div class="p-4 border-t border-white/5">
            <div id="system-status"
                class="flex flex-col items-center gap-2 p-3 rounded-xl bg-white/5 cursor-pointer hover:bg-white/10 transition-colors"
                title="System Status">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 status-dot"></div>
                </div>
                <i data-lucide="activity" class="w-5 h-5 text-gray-400"></i>
            </div>
        </div>

        <!-- User Profile (Bottom) -->
        <div class="p-4 border-t border-white/5">
            <!-- Guest State -->
            <a id="auth-guest" href="/login.html"
                class="hidden flex-col items-center gap-2 p-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all"
                title="Login">
                <i data-lucide="log-in" class="w-6 h-6"></i>
            </a>

            <!-- User State -->
            <a id="auth-user" href="/profile.html"
                class="hidden flex-col items-center gap-2 p-3 rounded-xl hover:bg-white/5 transition-all group"
                title="Profile">
                <div
                    class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 border border-white/20 flex items-center justify-center group-hover:border-purple-500/50 transition-colors">
                    <i data-lucide="user" class="w-5 h-5"></i>
                </div>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 h-full flex flex-col overflow-hidden relative z-10">

        <!-- Top Bar -->
        <header class="h-20 flex-shrink-0 flex items-center justify-end px-10 relative">

            <!-- Top Right: User Info -->
            <div id="top-right-auth">
                <!-- Guest -->
                <a id="topbar-guest" href="/login.html"
                    class="hidden items-center gap-2 px-5 py-2.5 rounded-xl bg-white/10 backdrop-blur-md border border-white/20 text-white text-sm font-medium hover:bg-white/20 hover:border-purple-500/50 transition-all">
                    <i data-lucide="log-in" class="w-4 h-4"></i>
                    <span>登入 / 註冊</span>
                </a>

                <!-- User -->
                <a id="topbar-user" href="/profile.html"
                    class="hidden items-center gap-3 px-4 py-2.5 rounded-xl bg-white/5 backdrop-blur-md border border-white/10 hover:bg-white/10 hover:border-purple-500/30 transition-all group">
                    <div
                        class="w-8 h-8 rounded-full bg-gradient-to-b from-purple-500 to-purple-800 border border-white/20 flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                    </div>
                    <span id="topbar-user-name"
                        class="text-sm font-medium text-gray-300 group-hover:text-white transition-colors">會員中心</span>
                    <i data-lucide="chevron-right"
                        class="w-4 h-4 text-gray-500 group-hover:text-purple-400 transition-colors"></i>
                </a>
            </div>
        </header>

        <!-- Main Content: Tool Grid -->
        <div class="flex-1 overflow-y-auto px-10 pb-10 flex flex-col items-center justify-center pt-80">
            <div class="max-w-7xl mx-auto w-full text-center">

                <!-- Neon Title - Centered (Outline Style) -->
                <h1 class="text-7xl md:text-9xl lg:text-9xl font-bold mb-20 animate-fade-in neon-title"
                    style="font-family: 'Orbitron', sans-serif; -webkit-text-stroke: 2px #f3c8ff; color: transparent; transform: skewX(-10deg); letter-spacing: 0.05em;">
                    Let's Create
                </h1>

                <!-- Dashboard View -->
                <div id="view-dashboard" class="animate-fade-in">
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-10">



                        <!-- Image Composition -->
                        <button onclick="navigateTo('canvas')"
                            class="tool-icon glass-card rounded-2xl p-8 flex flex-col items-center justify-center gap-4 group">
                            <div
                                class="w-20 h-20 rounded-2xl bg-gradient-to-br from-blue-500/20 to-cyan-600/20 border border-blue-500/30 flex items-center justify-center group-hover:border-blue-500/60 transition-all">
                                <i data-lucide="layers" class="w-10 h-10 text-blue-400"></i>
                            </div>
                            <div class="text-center">
                                <h3 class="text-2xl font-semibold text-white mb-1"
                                    style="font-family: 'Orbitron', sans-serif;">Image Studio</h3>
                                <p class="text-base text-gray-200">圖片合成工具</p>
                            </div>
                        </button>

                        <!-- Video Generation -->
                        <button onclick="navigateTo('motion')"
                            class="tool-icon glass-card rounded-2xl p-8 flex flex-col items-center justify-center gap-4 group">
                            <div
                                class="w-20 h-20 rounded-2xl bg-gradient-to-br from-amber-500/20 to-orange-600/20 border border-amber-500/30 flex items-center justify-center group-hover:border-amber-500/60 transition-all">
                                <i data-lucide="film" class="w-10 h-10 text-amber-400"></i>
                            </div>
                            <div class="text-center">
                                <h3 class="text-2xl font-semibold text-white mb-1"
                                    style="font-family: 'Orbitron', sans-serif;">Video Studio</h3>
                                <p class="text-base text-gray-200">影片生成工具</p>
                            </div>
                        </button>

                        <!-- Avatar Studio -->
                        <button onclick="navigateTo('avatar')"
                            class="tool-icon glass-card rounded-2xl p-8 flex flex-col items-center justify-center gap-4 group">
                            <div
                                class="w-20 h-20 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-teal-600/20 border border-emerald-500/30 flex items-center justify-center group-hover:border-emerald-500/60 transition-all">
                                <i data-lucide="user-circle-2" class="w-10 h-10 text-emerald-400"></i>
                            </div>
                            <div class="text-center">
                                <h3 class="text-2xl font-semibold text-white mb-1"
                                    style="font-family: 'Orbitron', sans-serif;">Avatar Studio</h3>
                                <p class="text-base text-gray-200">虛擬人像生成</p>
                            </div>
                        </button>

                    </div>

                    <!-- To Be Continue Button -->
                    <div class="mt-10 w-full">
                        <button disabled
                            class="w-1/2 py-5 rounded-2xl bg-white/5 border border-dashed border-white/20 text-gray-500 text-lg font-medium cursor-not-allowed hover:border-purple-500/30 transition-all">
                            <span class="opacity-60" style="font-family: 'Orbitron', sans-serif;">To Be Continue
                                ...</span>
                        </button>
                    </div>
                </div>

                <!-- Image Composition Workspace (Full Implementation) -->
                <div id="view-canvas" class="hidden h-full relative w-full">

                    <!-- Tool Selector Overlay -->
                    <div id="tool-selector-overlay"
                        class="absolute inset-0 z-50 flex items-center justify-center overlay-backdrop"
                        style="background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);">
                        <div
                            class="floating-toolbar glass-panel rounded-3xl p-12 max-w-6xl w-full mx-6 border border-white/10">
                            <!-- Header -->
                            <div class="flex items-center justify-between mb-10">
                                <div class="flex items-center gap-4">
                                    <div
                                        class="p-4 rounded-2xl bg-gradient-to-r from-purple-500 to-indigo-600 shadow-lg shadow-purple-500/30">
                                        <i data-lucide="layers" class="w-8 h-8"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-3xl font-bold text-white">Image Composition</h2>
                                        <p class="text-base text-gray-400 mt-1">選擇一個工具開始創作</p>
                                    </div>
                                </div>
                                <button onclick="hideCompositionMenu()"
                                    class="p-3 rounded-xl hover:bg-white/10 transition-colors text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-8 h-8"></i>
                                </button>
                            </div>

                            <!-- Tool Grid -->
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
                                <!-- Face Swap -->
                                <button onclick="selectTool('face_swap')"
                                    class="tool-card glass-card rounded-3xl p-6 text-center cursor-pointer hover:border-purple-500/50 group">
                                    <div
                                        class="p-4 rounded-2xl bg-purple-500/10 text-purple-300 mx-auto w-fit mb-4 group-hover:bg-purple-500/20 group-hover:scale-110 transition-all border border-purple-500/20">
                                        <i data-lucide="users" class="w-10 h-10"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">Face Swap</h3>
                                    <p class="text-xs text-gray-500">換臉</p>
                                </button>

                                <!-- Multi-Blend -->
                                <button onclick="selectTool('multi_image_blend')"
                                    class="tool-card glass-card rounded-3xl p-6 text-center cursor-pointer hover:border-amber-500/50 group">
                                    <div
                                        class="p-4 rounded-2xl bg-amber-500/10 text-amber-300 mx-auto w-fit mb-4 group-hover:bg-amber-500/20 group-hover:scale-110 transition-all border border-amber-500/20">
                                        <i data-lucide="layers" class="w-10 h-10"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">Multi-Blend</h3>
                                    <p class="text-xs text-gray-500">多圖融合</p>
                                </button>

                                <!-- Sketch to Image -->
                                <button onclick="selectTool('sketch_to_image')"
                                    class="tool-card glass-card rounded-3xl p-6 text-center cursor-pointer hover:border-emerald-500/50 group">
                                    <div
                                        class="p-4 rounded-2xl bg-emerald-500/10 text-emerald-300 mx-auto w-fit mb-4 group-hover:bg-emerald-500/20 group-hover:scale-110 transition-all border border-emerald-500/20">
                                        <i data-lucide="pencil" class="w-10 h-10"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">Sketch</h3>
                                    <p class="text-xs text-gray-500">草稿轉精稿</p>
                                </button>

                                <!-- Text to Image -->
                                <button onclick="selectTool('text_to_image')"
                                    class="tool-card glass-card rounded-3xl p-6 text-center cursor-pointer hover:border-blue-500/50 group">
                                    <div
                                        class="p-4 rounded-2xl bg-blue-500/10 text-blue-300 mx-auto w-fit mb-4 group-hover:bg-blue-500/20 group-hover:scale-110 transition-all border border-blue-500/20">
                                        <i data-lucide="type" class="w-10 h-10"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">Text2Img</h3>
                                    <p class="text-xs text-gray-500">文生圖</p>
                                </button>

                                <!-- Single Image Edit -->
                                <button onclick="selectTool('single_image_edit')"
                                    class="tool-card glass-card rounded-3xl p-6 text-center cursor-pointer hover:border-pink-500/50 group">
                                    <div
                                        class="p-4 rounded-2xl bg-pink-500/10 text-pink-300 mx-auto w-fit mb-4 group-hover:bg-pink-500/20 group-hover:scale-110 transition-all border border-pink-500/20">
                                        <i data-lucide="image" class="w-10 h-10"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">Edit</h3>
                                    <p class="text-xs text-gray-500">單圖編輯</p>
                                </button>
                            </div>

                            <p class="text-center text-base text-gray-500 mt-10">按 ESC 或點擊外部區域關閉</p>
                        </div>
                    </div>

                    <!-- Studio Workspace -->
                    <div id="studio-workspace" class="hidden flex h-full">
                        <!-- Center Stage -->
                        <div class="flex-1 flex flex-col relative grid-bg">
                            <!-- Current Tool Header -->
                            <div id="current-tool-header"
                                class="flex items-center gap-4 px-6 py-4 border-b border-white/5 bg-black/20">
                                <button onclick="showCompositionMenu()"
                                    class="p-2 rounded-lg hover:bg-white/10 transition-colors text-gray-400 hover:text-white"
                                    title="切換工具">
                                    <i data-lucide="grid-3x3" class="w-5 h-5"></i>
                                </button>
                                <div class="h-6 w-[1px] bg-white/10"></div>
                                <div id="current-tool-info" class="flex items-center gap-3">
                                    <div id="current-tool-icon" class="p-2 rounded-lg bg-purple-500/20 text-purple-300">
                                        <i data-lucide="type" class="w-4 h-4"></i>
                                    </div>
                                    <div>
                                        <span id="current-tool-name" class="text-sm font-bold text-white">Text to
                                            Image</span>
                                        <span id="current-tool-desc" class="text-xs text-gray-500 ml-2">文生圖</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Canvas Area -->
                            <div id="workspace-canvas"
                                class="flex-1 flex items-center justify-center p-8 overflow-auto">
                                <!-- Placeholder State -->
                                <div id="canvas-placeholder" class="text-center opacity-50">
                                    <div
                                        class="w-32 h-32 border-4 border-dashed border-gray-600 rounded-full mx-auto mb-6 flex items-center justify-center">
                                        <i data-lucide="image" class="w-12 h-12 text-gray-600"></i>
                                    </div>
                                    <h2 class="text-2xl font-bold text-gray-400 mb-2">Ready to Generate</h2>
                                    <p class="text-sm text-gray-500">Select a tool and enter your prompt below</p>
                                </div>
                                <!-- Result Images Grid -->
                                <div id="canvas-results" class="hidden w-full h-full">
                                    <div id="results-grid" class="grid gap-4 w-full h-full place-items-center"></div>
                                </div>
                            </div>

                            <!-- Bottom Control Panel -->
                            <div id="workspace-controls" class="glass-panel p-6 relative">
                                <div class="max-w-4xl mx-auto flex flex-col gap-4">
                                    <!-- Upload Zones -->
                                    <div id="upload-zones" class="flex gap-4 h-28"></div>

                                    <!-- Prompt Bar -->
                                    <div id="single-prompt-row" class="flex gap-4">
                                        <textarea id="prompt-input"
                                            class="flex-1 custom-input rounded-xl p-4 text-sm resize-none h-16"
                                            placeholder="Describe your image..."></textarea>
                                        <button id="btn-enhance" type="button"
                                            class="px-4 rounded-xl font-medium bg-white/5 border border-white/10 hover:bg-white/10 hover:border-purple-500/50 transition-all flex items-center gap-2 text-gray-400 hover:text-white"
                                            title="AI 優化 Prompt">
                                            <i data-lucide="wand-2" class="w-5 h-5"></i>
                                        </button>
                                        <button id="btn-generate" type="button"
                                            class="bg-gradient-to-r from-purple-600 to-indigo-600 px-8 rounded-xl font-bold hover:shadow-[0_0_25px_rgba(124,58,237,0.5)] transition-all flex items-center gap-2 border border-white/10 hover:brightness-110">
                                            <i data-lucide="sparkles" class="w-5 h-5"></i>
                                            <span>Generate</span>
                                        </button>
                                    </div>

                                    <!-- Status Message -->
                                    <div id="status-message" class="text-sm text-gray-400 text-center hidden"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Settings Panel -->
                        <aside id="workspace-settings"
                            class="w-80 border-l border-white/10 bg-black/30 p-6 flex flex-col gap-6 overflow-y-auto flex-shrink-0">
                            <!-- Model Selector -->
                            <div>
                                <label
                                    class="text-xs font-bold text-gray-500 uppercase mb-2 block tracking-wider">Model</label>
                                <select id="model-select"
                                    class="w-full custom-input rounded-xl p-3 text-sm cursor-pointer">
                                    <option value="loading" disabled>Loading models...</option>
                                </select>
                            </div>

                            <!-- Aspect Ratio -->
                            <div>
                                <label
                                    class="text-xs font-bold text-gray-500 uppercase mb-3 block tracking-wider">Aspect
                                    Ratio</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="updateAspectRatio('1:1')" data-ratio="1:1"
                                        class="ratio-btn active p-3 rounded-xl flex flex-col items-center gap-2 bg-black/30">
                                        <div class="w-8 h-8 border-2 border-current rounded-md"></div>
                                        <span class="text-xs font-medium">1:1 Square</span>
                                    </button>
                                    <button onclick="updateAspectRatio('16:9')" data-ratio="16:9"
                                        class="ratio-btn p-3 rounded-xl flex flex-col items-center gap-2 bg-black/30 text-gray-400">
                                        <div class="w-10 h-6 border-2 border-current rounded-md"></div>
                                        <span class="text-xs font-medium">16:9 Cinema</span>
                                    </button>
                                    <button onclick="updateAspectRatio('9:16')" data-ratio="9:16"
                                        class="ratio-btn p-3 rounded-xl flex flex-col items-center gap-2 bg-black/30 text-gray-400">
                                        <div class="w-6 h-10 border-2 border-current rounded-md"></div>
                                        <span class="text-xs font-medium">9:16 Mobile</span>
                                    </button>
                                    <button onclick="updateAspectRatio('2:3')" data-ratio="2:3"
                                        class="ratio-btn p-3 rounded-xl flex flex-col items-center gap-2 bg-black/30 text-gray-400">
                                        <div class="w-6 h-9 border-2 border-current rounded-md"></div>
                                        <span class="text-xs font-medium">2:3 Portrait</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Seed Input -->
                            <div>
                                <label
                                    class="text-xs font-bold text-gray-500 uppercase mb-2 block tracking-wider">Seed</label>
                                <div class="flex gap-2">
                                    <input type="number" id="seed-input"
                                        class="flex-1 custom-input rounded-xl p-3 text-sm" placeholder="-1 (Random)"
                                        value="-1">
                                    <button
                                        onclick="document.getElementById('seed-input').value = Math.floor(Math.random() * 999999999)"
                                        class="px-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition-all"
                                        title="Random">
                                        <i data-lucide="shuffle" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Batch Size -->
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase mb-3 block tracking-wider">Batch
                                    Size</label>
                                <div class="flex gap-2">
                                    <button onclick="setBatchSize(1)" data-batch="1"
                                        class="batch-btn flex-1 py-2 rounded-lg text-sm font-medium bg-purple-500/20 border border-purple-500/50 text-white">1</button>
                                    <button onclick="setBatchSize(2)" data-batch="2"
                                        class="batch-btn flex-1 py-2 rounded-lg text-sm font-medium bg-black/30 border border-white/10 text-gray-400">2</button>
                                    <button onclick="setBatchSize(4)" data-batch="4"
                                        class="batch-btn flex-1 py-2 rounded-lg text-sm font-medium bg-black/30 border border-white/10 text-gray-400">4</button>
                                </div>
                            </div>
                        </aside>
                    </div>
                </div>

                <!-- Motion Workspace (Full Implementation) -->
                <div id="view-motion" class="hidden h-full relative w-full">
                    <!-- Video Tool Selector Overlay -->
                    <div id="video-tool-selector-overlay"
                        class="absolute inset-0 z-50 flex items-center justify-center overlay-backdrop"
                        style="background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);">
                        <div
                            class="floating-toolbar glass-panel rounded-3xl p-12 max-w-4xl w-full mx-6 border border-white/10">
                            <div class="flex items-center justify-between mb-10">
                                <div class="flex items-center gap-4">
                                    <div
                                        class="p-4 rounded-2xl bg-gradient-to-r from-amber-500 to-orange-600 shadow-lg shadow-amber-500/30">
                                        <i data-lucide="film" class="w-8 h-8"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-3xl font-bold text-white">Video Studio</h2>
                                        <p class="text-base text-gray-400 mt-1">選擇一種影片生成方式</p>
                                    </div>
                                </div>
                                <button onclick="hideVideoToolMenu()"
                                    class="p-3 rounded-xl hover:bg-white/10 transition-colors text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-8 h-8"></i>
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <button onclick="selectVideoTool('veo3_long_video')"
                                    class="tool-card glass-card rounded-3xl p-8 text-center cursor-pointer hover:border-amber-500/50 group">
                                    <div
                                        class="p-5 rounded-2xl bg-amber-500/10 text-amber-300 mx-auto w-fit mb-5 group-hover:bg-amber-500/20 group-hover:scale-110 transition-all border border-amber-500/20">
                                        <i data-lucide="film" class="w-12 h-12"></i>
                                    </div>
                                    <h3 class="text-lg font-bold text-white mb-2">長片生成</h3>
                                    <p class="text-sm text-gray-500">Multi-Shot (1-5)</p>
                                </button>
                                <button onclick="selectVideoTool('t2v_veo3')"
                                    class="tool-card glass-card rounded-3xl p-8 text-center cursor-pointer hover:border-blue-500/50 group">
                                    <div
                                        class="p-5 rounded-2xl bg-blue-500/10 text-blue-300 mx-auto w-fit mb-5 group-hover:bg-blue-500/20 group-hover:scale-110 transition-all border border-blue-500/20">
                                        <i data-lucide="type" class="w-12 h-12"></i>
                                    </div>
                                    <h3 class="text-lg font-bold text-white mb-2">文字轉影片</h3>
                                    <p class="text-sm text-gray-500">Text to Video</p>
                                </button>
                                <button onclick="selectVideoTool('flf_veo3')"
                                    class="tool-card glass-card rounded-3xl p-8 text-center cursor-pointer hover:border-purple-500/50 group">
                                    <div
                                        class="p-5 rounded-2xl bg-purple-500/10 text-purple-300 mx-auto w-fit mb-5 group-hover:bg-purple-500/20 group-hover:scale-110 transition-all border border-purple-500/20">
                                        <i data-lucide="image" class="w-12 h-12"></i>
                                    </div>
                                    <h3 class="text-lg font-bold text-white mb-2">首尾禎動畫</h3>
                                    <p class="text-sm text-gray-500">First-Last Frame</p>
                                </button>
                            </div>
                            <p class="text-center text-base text-gray-500 mt-10">按 ESC 或點擊外部區域關閉</p>
                        </div>
                    </div>

                    <!-- Video Workspace -->
                    <div id="video-workspace" class="hidden flex h-full">
                        <!-- Left Panel -->
                        <div
                            class="w-80 glass-panel border-r border-white/10 p-6 flex flex-col gap-4 overflow-y-auto h-full z-20">
                            <div id="video-tool-header" class="flex items-center gap-3 mb-2">
                                <button onclick="showVideoToolMenu()"
                                    class="p-2 rounded-lg hover:bg-white/10 transition-colors text-gray-400 hover:text-white"
                                    title="切換工具">
                                    <i data-lucide="grid-3x3" class="w-5 h-5"></i>
                                </button>
                                <div class="h-6 w-[1px] bg-white/10"></div>
                                <div id="video-tool-icon" class="p-2 rounded-lg bg-amber-500/20 text-amber-300">
                                    <i data-lucide="film" class="w-4 h-4"></i>
                                </div>
                                <div>
                                    <span id="video-tool-name" class="text-sm font-bold text-white">長片生成</span>
                                    <span id="video-tool-desc" class="text-xs text-gray-500 ml-2">Multi-Shot</span>
                                </div>
                            </div>
                            <div class="h-[1px] bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
                            <!-- Panel: Multi-Shot -->
                            <div id="panel-veo3_long_video">
                                <h3 class="text-sm font-bold text-white mb-2">Multi-Shot Composition</h3>
                                <p class="text-xs text-gray-500 mb-4">Add up to 5 images to create a sequence.</p>
                                <div class="space-y-3" id="motion-shots-upload"></div>
                            </div>
                            <!-- Panel: T2V -->
                            <div id="panel-t2v_veo3" class="hidden">
                                <h3 class="text-sm font-bold text-white mb-2">文字轉影片</h3>
                                <p class="text-xs text-gray-500 mb-4">直接輸入描述，無需圖片即可生成影片。</p>
                                <div class="glass-card rounded-xl p-4 border border-blue-500/20 bg-blue-500/10">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 rounded-lg bg-blue-500/20"><i data-lucide="type"
                                                class="w-5 h-5 text-blue-300"></i></div>
                                        <div>
                                            <div class="text-sm font-bold text-white">純文字模式</div>
                                            <div class="text-xs text-gray-400">在右側輸入 Prompt 即可生成</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Panel: FLF -->
                            <div id="panel-flf_veo3" class="hidden">
                                <h3 class="text-sm font-bold text-white mb-2">首尾禎動畫</h3>
                                <p class="text-xs text-gray-500 mb-4">上傳首禎與尾禎圖片。</p>
                                <div class="space-y-4" id="flf-dropzones">
                                    <div id="zone-first_frame"
                                        class="upload-zone relative flex flex-col items-center justify-center rounded-xl cursor-pointer bg-black/20 p-4 min-h-[100px]"
                                        onclick="triggerFLFUpload('first_frame')">
                                        <input type="file" id="file-first_frame" class="hidden" accept="image/*"
                                            onchange="handleFLFSelect(event, 'first_frame')" />
                                        <div id="preview-first_frame" class="hidden absolute inset-0">
                                            <img src="" alt="Preview" class="w-full h-full object-cover rounded-xl" />
                                            <button onclick="event.stopPropagation(); clearFLFImage('first_frame')"
                                                class="absolute top-2 right-2 p-1 bg-black/70 rounded-full hover:bg-red-500/80 z-10"><i
                                                    data-lucide="x" class="w-4 h-4 text-white"></i></button>
                                        </div>
                                        <div id="placeholder-first_frame"
                                            class="flex flex-col items-center pointer-events-none">
                                            <i data-lucide="image" class="w-8 h-8 text-purple-400 mb-2"></i>
                                            <span class="text-sm font-bold text-white">首禎</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-center"><i data-lucide="arrow-down"
                                            class="w-5 h-5 text-gray-500"></i></div>
                                    <div id="zone-last_frame"
                                        class="upload-zone relative flex flex-col items-center justify-center rounded-xl cursor-pointer bg-black/20 p-4 min-h-[100px]"
                                        onclick="triggerFLFUpload('last_frame')">
                                        <input type="file" id="file-last_frame" class="hidden" accept="image/*"
                                            onchange="handleFLFSelect(event, 'last_frame')" />
                                        <div id="preview-last_frame" class="hidden absolute inset-0">
                                            <img src="" alt="Preview" class="w-full h-full object-cover rounded-xl" />
                                            <button onclick="event.stopPropagation(); clearFLFImage('last_frame')"
                                                class="absolute top-2 right-2 p-1 bg-black/70 rounded-full hover:bg-red-500/80 z-10"><i
                                                    data-lucide="x" class="w-4 h-4 text-white"></i></button>
                                        </div>
                                        <div id="placeholder-last_frame"
                                            class="flex flex-col items-center pointer-events-none">
                                            <i data-lucide="image" class="w-8 h-8 text-purple-400 mb-2"></i>
                                            <span class="text-sm font-bold text-white">尾禎</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Right: Prompt & Preview -->
                        <div class="flex-1 flex flex-col relative grid-bg">
                            <div id="motion-preview" class="flex-1 flex items-center justify-center p-8">
                                <div class="text-center opacity-50">
                                    <div
                                        class="w-32 h-32 border-4 border-dashed border-gray-600 rounded-full mx-auto mb-6 flex items-center justify-center">
                                        <i data-lucide="film" class="w-12 h-12 text-gray-600"></i>
                                    </div>
                                    <h2 class="text-2xl font-bold text-gray-400 mb-2">Ready to Generate</h2>
                                    <p class="text-sm text-gray-500">Upload images and enter prompt</p>
                                </div>
                            </div>
                            <div class="glass-panel p-6">
                                <div class="max-w-4xl mx-auto flex flex-col gap-4">
                                    <div class="flex gap-4">
                                        <textarea id="motion-prompt"
                                            class="flex-1 custom-input rounded-xl p-4 text-sm resize-none h-16"
                                            placeholder="Describe your video..."></textarea>
                                        <button id="btn-motion-generate" type="button" onclick="handleMotionGenerate()"
                                            class="bg-gradient-to-r from-amber-600 to-orange-600 px-8 rounded-xl font-bold hover:shadow-[0_0_25px_rgba(245,158,11,0.5)] transition-all flex items-center gap-2 border border-white/10">
                                            <i data-lucide="clapperboard" class="w-5 h-5"></i>
                                            <span>Generate Video</span>
                                        </button>
                                    </div>
                                    <div id="motion-status" class="text-sm text-center hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Avatar Workspace -->
                <div id="view-avatar" class="hidden h-full overflow-y-auto p-6 md:p-8">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center gap-4 mb-8">
                            <div
                                class="p-3 rounded-xl bg-gradient-to-r from-emerald-500/20 to-teal-600/20 border border-emerald-500/30">
                                <i data-lucide="user-circle-2" class="w-8 h-8 text-emerald-400"></i>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold text-white">Avatar Studio</h1>
                                <p class="text-gray-400">上傳人像圖片和音訊，生成說話的虛擬人像影片</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <!-- Image Upload -->
                            <div id="avatar-image-zone"
                                class="upload-zone rounded-xl p-6 min-h-[200px] flex flex-col items-center justify-center"
                                onclick="triggerAvatarImageUpload()">
                                <input type="file" id="avatar-image-input" class="hidden" accept="image/*"
                                    onchange="handleAvatarImageSelect(event)" />
                                <div id="avatar-image-preview" class="hidden absolute inset-0">
                                    <img src="" alt="Avatar Preview" class="w-full h-full object-cover rounded-xl" />
                                    <button onclick="event.stopPropagation(); clearAvatarImage()"
                                        class="absolute top-2 right-2 p-1 bg-black/70 rounded-full hover:bg-red-500/80 z-10"><i
                                            data-lucide="x" class="w-4 h-4 text-white"></i></button>
                                </div>
                                <div id="avatar-image-placeholder" class="flex flex-col items-center">
                                    <i data-lucide="user" class="w-10 h-10 text-emerald-400 mb-3"></i>
                                    <span class="text-lg font-bold text-white mb-1">Avatar Image</span>
                                    <span class="text-sm text-gray-500">Click or Drop</span>
                                </div>
                            </div>
                            <!-- Audio Upload -->
                            <div id="avatar-audio-zone"
                                class="upload-zone rounded-xl p-6 min-h-[200px] flex flex-col items-center justify-center"
                                onclick="triggerAvatarAudioUpload()">
                                <input type="file" id="avatar-audio-input" class="hidden" accept="audio/*,.wav,.mp3"
                                    onchange="handleAvatarAudioSelect(event)" />
                                <div id="avatar-audio-preview" class="hidden flex items-center gap-3">
                                    <div class="p-3 rounded-lg bg-emerald-500/20"><i data-lucide="music"
                                            class="w-6 h-6 text-emerald-300"></i></div>
                                    <span id="avatar-audio-filename" class="text-white font-medium">audio.wav</span>
                                    <button onclick="event.stopPropagation(); clearAvatarAudio()"
                                        class="p-1 rounded hover:bg-red-500/50"><i data-lucide="x"
                                            class="w-4 h-4"></i></button>
                                </div>
                                <div id="avatar-audio-placeholder" class="flex flex-col items-center">
                                    <i data-lucide="mic" class="w-10 h-10 text-emerald-400 mb-3"></i>
                                    <span class="text-lg font-bold text-white mb-1">Audio File</span>
                                    <span class="text-sm text-gray-500">WAV or MP3</span>
                                </div>
                            </div>
                        </div>
                        <!-- Script Input -->
                        <div class="glass-card rounded-xl p-4 mb-6">
                            <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Script
                                (Optional)</label>
                            <textarea id="avatar-script-input"
                                class="w-full custom-input rounded-xl p-4 text-sm resize-none h-20"
                                placeholder="Enter script for TTS if no audio uploaded..."></textarea>
                        </div>
                        <!-- Generate Button -->
                        <button id="avatar-generate-btn" onclick="generateAvatarVideo()"
                            class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 py-4 rounded-xl font-bold text-lg hover:shadow-[0_0_25px_rgba(16,185,129,0.5)] transition-all flex items-center justify-center gap-3">
                            <i data-lucide="video" class="w-6 h-6"></i>
                            <span>Generate Avatar Video</span>
                        </button>
                        <div id="avatar-status" class="hidden mt-4 p-4 rounded-xl text-center"></div>
                        <div id="avatar-result" class="hidden mt-6 glass-card rounded-xl p-4">
                            <video id="avatar-video-player" controls class="w-full rounded-lg"></video>
                        </div>
                    </div>
                </div>

                <!-- Gallery Workspace -->
                <div id="view-gallery" class="hidden h-full overflow-y-auto p-6 md:p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h1 class="text-3xl font-bold mb-2 text-white">Personal Gallery</h1>
                                <p class="text-gray-400">回顧您的創作歷史，重新混音您的作品</p>
                            </div>
                            <button onclick="loadHistory()"
                                class="glass-card px-4 py-2 rounded-lg text-sm font-medium hover:bg-white/10 flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                重新整理
                            </button>
                        </div>
                        <div class="glass-card rounded-xl p-4 mb-6 flex items-center gap-4">
                            <span class="text-sm text-gray-400">篩選:</span>
                            <button
                                class="px-3 py-1 rounded-lg bg-purple-500/20 border border-purple-500/50 text-purple-300 text-sm">全部</button>
                            <button
                                class="px-3 py-1 rounded-lg hover:bg-white/5 border border-transparent text-gray-400 text-sm">已完成</button>
                            <button
                                class="px-3 py-1 rounded-lg hover:bg-white/5 border border-transparent text-gray-400 text-sm">生成中</button>
                        </div>
                        <div id="gallery-grid"
                            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            <div class="col-span-full text-center py-12 text-gray-500">
                                <i data-lucide="loader" class="w-8 h-8 mx-auto mb-4 animate-spin"></i>
                                <p>載入歷史記錄中...</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // ==========================================
        // Enhanced Lucide Icons Initialization
        // ==========================================

        // Initialize immediately when script loads
        if (typeof lucide !== 'undefined') {
            console.log('[Lucide] Library loaded, initializing icons...');
            lucide.createIcons();
        }

        // Backup initialization on window load
        window.addEventListener('load', () => {
            console.log('[Lucide] Window loaded, re-initializing icons...');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });

        // API Configuration
        const API_BASE = (typeof window.API_URL !== 'undefined') ? window.API_URL : '';
        console.log('[Dashboard] API_BASE:', API_BASE || '(relative path)');

        // Current View State
        let currentView = 'dashboard';

        /**
         * Navigation Function
         */
        function navigateTo(viewName) {
            console.log('[Nav] Navigating to:', viewName);

            // Hide all views
            const allViews = document.querySelectorAll('[id^="view-"]');
            allViews.forEach(view => view.classList.add('hidden'));

            // Show target view
            const targetView = document.getElementById(`view-${viewName}`);
            if (targetView) {
                targetView.classList.remove('hidden');
                targetView.classList.add('animate-fade-in');
            }

            // Update nav active state
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));

            const activeNav = document.querySelector(`[onclick="navigateTo('${viewName}')"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }

            currentView = viewName;
            localStorage.setItem('currentView', viewName);

            // Re-initialize icons after navigation
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
        }

        /**
         * Check Login Status
         */
        async function checkLoginStatus() {
            console.log('[Auth] Checking login status...');

            const authGuest = document.getElementById('auth-guest');
            const authUser = document.getElementById('auth-user');
            const topbarGuest = document.getElementById('topbar-guest');
            const topbarUser = document.getElementById('topbar-user');

            try {
                const response = await fetch(`${API_BASE}/api/me`, {
                    credentials: 'include'
                });
                const data = await response.json();
                console.log('[Auth] Response:', data);

                if (data.logged_in && data.user) {
                    // Logged in
                    authGuest.classList.add('hidden');
                    authUser.classList.remove('hidden');
                    authUser.classList.add('flex');

                    topbarGuest.classList.add('hidden');
                    topbarUser.classList.remove('hidden');
                    topbarUser.classList.add('flex');

                    document.getElementById('topbar-user-name').textContent = data.user.name || '會員中心';
                    console.log('[Auth] Logged in as:', data.user.email);
                } else {
                    // Not logged in
                    authGuest.classList.remove('hidden');
                    authGuest.classList.add('flex');
                    authUser.classList.add('hidden');

                    topbarGuest.classList.remove('hidden');
                    topbarGuest.classList.add('flex');
                    topbarUser.classList.add('hidden');

                    console.log('[Auth] Not logged in');
                }

                lucide.createIcons();
            } catch (error) {
                console.error('[Auth] Check failed:', error);
                // Show guest state on error
                authGuest.classList.remove('hidden');
                authGuest.classList.add('flex');
                authUser.classList.add('hidden');
                topbarGuest.classList.remove('hidden');
                topbarGuest.classList.add('flex');
                topbarUser.classList.add('hidden');
            }
        }

        /**
         * Initialize on Page Load
         */
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Dashboard] Initializing...');

            // Restore last view
            const savedView = localStorage.getItem('currentView');
            if (savedView && savedView !== 'dashboard') {
                navigateTo(savedView);
            }

            // Check login status
            checkLoginStatus();

            // Initialize Multi-Shot UI if motion workspace exists
            if (document.getElementById('motion-shots-upload')) {
                initMotionShotsUI();
            }

            // Final icon initialization
            console.log('[Lucide] DOMContentLoaded - Final initialization');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
                console.log('[Lucide] Icons created successfully');
            }
        });

        // ==========================================
        // Global State
        // ==========================================
        let currentTool = 'text_to_image';
        let currentVideoTool = 'veo3_long_video';
        let currentRatio = '1:1';
        let currentBatchSize = 1;
        let uploadedImages = { source: null, target: null, input: null, extra: null };

        // Tool States
        window.toolStates = {
            text_to_image: { prompt: '', images: {}, isGenerating: false },
            face_swap: { prompt: '', images: {}, isGenerating: false },
            multi_image_blend: { prompt: '', images: {}, isGenerating: false },
            sketch_to_image: { prompt: '', images: {}, isGenerating: false },
            single_image_edit: { prompt: '', images: {}, isGenerating: false }
        };

        // Tool Configuration
        const toolConfig = {
            'face_swap': { uploads: [{ id: 'source', label: 'Source Face', icon: 'user' }, { id: 'target', label: 'Target Image', icon: 'image' }], color: 'purple' },
            'multi_image_blend': { uploads: [{ id: 'source', label: 'Image A', icon: 'image' }, { id: 'target', label: 'Image B', icon: 'image' }, { id: 'extra', label: 'Image C', icon: 'image' }], color: 'amber' },
            'sketch_to_image': { uploads: [{ id: 'input', label: 'Sketch Input', icon: 'pencil' }], color: 'emerald' },
            'text_to_image': { uploads: [], color: 'blue' },
            'single_image_edit': { uploads: [{ id: 'input', label: 'Input Image', icon: 'image' }], color: 'pink' }
        };

        const toolInfo = {
            'face_swap': { name: 'Face Swap', desc: '換臉', icon: 'users', color: 'purple' },
            'multi_image_blend': { name: 'Multi-Blend', desc: '多圖融合', icon: 'layers', color: 'amber' },
            'sketch_to_image': { name: 'Sketch to Image', desc: '草稿轉精稿', icon: 'pencil', color: 'emerald' },
            'text_to_image': { name: 'Text to Image', desc: '文生圖', icon: 'type', color: 'blue' },
            'single_image_edit': { name: 'Single Image Edit', desc: '單圖編輯', icon: 'image', color: 'pink' }
        };

        // ==========================================
        // Image Composition Menu Control
        // ==========================================
        function showCompositionMenu() {
            console.log('[showCompositionMenu] Called');
            const allViews = document.querySelectorAll('[id^="view-"]');
            allViews.forEach(view => view.classList.add('hidden'));
            document.getElementById('view-canvas').classList.remove('hidden');
            document.getElementById('tool-selector-overlay').classList.remove('hidden');
            document.getElementById('studio-workspace').classList.add('hidden');
            document.getElementById('studio-workspace').classList.remove('flex');
            localStorage.setItem('currentView', 'canvas');
            lucide.createIcons();
        }

        function hideCompositionMenu() {
            console.log('[hideCompositionMenu] Called');
            if (!currentTool) {
                navigateTo('dashboard');
                return;
            }
            document.getElementById('tool-selector-overlay').classList.add('hidden');
            document.getElementById('studio-workspace').classList.remove('hidden');
            document.getElementById('studio-workspace').classList.add('flex');
            localStorage.setItem('currentView', 'canvas');
        }

        // ==========================================
        // Tool Selection
        // ==========================================
        function selectTool(toolId) {
            console.log('[selectTool] Selecting:', toolId);
            currentTool = toolId;
            hideCompositionMenu();
            updateToolHeader();
            renderWorkspace();
            lucide.createIcons();
        }

        function updateToolHeader() {
            const info = toolInfo[currentTool];
            if (!info) return;
            const iconEl = document.getElementById('current-tool-icon');
            iconEl.className = `p-2 rounded-lg bg-${info.color}-500/20 text-${info.color}-300`;
            iconEl.innerHTML = `<i data-lucide="${info.icon}" class="w-4 h-4"></i>`;
            document.getElementById('current-tool-name').textContent = info.name;
            document.getElementById('current-tool-desc').textContent = info.desc;
            lucide.createIcons();
        }

        function renderWorkspace() {
            const config = toolConfig[currentTool];
            const uploadZones = document.getElementById('upload-zones');
            if (!config || !uploadZones) return;

            if (config.uploads.length === 0) {
                uploadZones.innerHTML = '';
                uploadZones.classList.add('hidden');
            } else {
                uploadZones.classList.remove('hidden');
                uploadZones.innerHTML = config.uploads.map(upload => `
                    <div id="zone-${upload.id}" class="upload-zone flex-1 rounded-xl flex flex-col items-center justify-center p-4 relative"
                        onclick="triggerUpload('${upload.id}')" ondragover="event.preventDefault();" ondrop="handleDrop(event, '${upload.id}')">
                        <input type="file" id="file-${upload.id}" class="hidden" accept="image/*" onchange="handleFileSelect(event, '${upload.id}')" />
                        <div id="preview-${upload.id}" class="hidden absolute inset-0">
                            <img src="" alt="Preview" class="w-full h-full object-cover rounded-xl" />
                            <button onclick="event.stopPropagation(); clearUpload('${upload.id}')" class="absolute top-2 right-2 p-1 bg-black/70 rounded-full hover:bg-red-500/80">
                                <i data-lucide="x" class="w-4 h-4 text-white"></i>
                            </button>
                        </div>
                        <div id="placeholder-${upload.id}" class="flex flex-col items-center pointer-events-none">
                            <i data-lucide="${upload.icon}" class="w-6 h-6 text-gray-400 mb-2"></i>
                            <span class="text-xs font-medium text-gray-400">${upload.label}</span>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        // ==========================================
        // Upload Handling
        // ==========================================
        function triggerUpload(id) {
            document.getElementById(`file-${id}`).click();
        }

        function handleFileSelect(event, id) {
            const file = event.target.files[0];
            if (file) processFile(file, id);
        }

        function handleDrop(event, id) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file) processFile(file, id);
        }

        function processFile(file, id) {
            const reader = new FileReader();
            reader.onload = function (e) {
                uploadedImages[id] = e.target.result;
                const preview = document.getElementById(`preview-${id}`);
                const placeholder = document.getElementById(`placeholder-${id}`);
                const zone = document.getElementById(`zone-${id}`);
                if (preview && placeholder && zone) {
                    preview.querySelector('img').src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    zone.classList.add('has-image');
                }
            };
            reader.readAsDataURL(file);
        }

        function clearUpload(id) {
            uploadedImages[id] = null;
            const preview = document.getElementById(`preview-${id}`);
            const placeholder = document.getElementById(`placeholder-${id}`);
            const zone = document.getElementById(`zone-${id}`);
            const fileInput = document.getElementById(`file-${id}`);
            if (preview) preview.classList.add('hidden');
            if (placeholder) placeholder.classList.remove('hidden');
            if (zone) zone.classList.remove('has-image');
            if (fileInput) fileInput.value = '';
        }

        // ==========================================
        // Aspect Ratio & Batch Size
        // ==========================================
        function updateAspectRatio(ratio) {
            currentRatio = ratio;
            document.querySelectorAll('.ratio-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.ratio === ratio);
                btn.classList.toggle('text-gray-400', btn.dataset.ratio !== ratio);
            });
        }

        function setBatchSize(size) {
            currentBatchSize = size;
            document.querySelectorAll('.batch-btn').forEach(btn => {
                const isActive = btn.dataset.batch === String(size);
                btn.className = `batch-btn flex-1 py-2 rounded-lg text-sm font-medium ${isActive ? 'bg-purple-500/20 border border-purple-500/50 text-white' : 'bg-black/30 border border-white/10 text-gray-400'}`;
            });
        }

        // ==========================================
        // Video Studio Menu Control
        // ==========================================
        function showVideoToolMenu() {
            document.getElementById('video-tool-selector-overlay').classList.remove('hidden');
            document.getElementById('video-workspace').classList.add('hidden');
            document.getElementById('video-workspace').classList.remove('flex');
        }

        function hideVideoToolMenu() {
            document.getElementById('video-tool-selector-overlay').classList.add('hidden');
            document.getElementById('video-workspace').classList.remove('hidden');
            document.getElementById('video-workspace').classList.add('flex');
        }

        function selectVideoTool(toolId) {
            console.log('[selectVideoTool] Selecting:', toolId);
            currentVideoTool = toolId;
            hideVideoToolMenu();
            // Update panels
            ['veo3_long_video', 't2v_veo3', 'flf_veo3'].forEach(id => {
                const panel = document.getElementById(`panel-${id}`);
                if (panel) panel.classList.toggle('hidden', id !== toolId);
            });
            // Update header
            const names = { veo3_long_video: '長片生成', t2v_veo3: '文字轉影片', flf_veo3: '首尾禎動畫' };
            const descs = { veo3_long_video: 'Multi-Shot', t2v_veo3: 'Text to Video', flf_veo3: 'First-Last Frame' };
            document.getElementById('video-tool-name').textContent = names[toolId] || '';
            document.getElementById('video-tool-desc').textContent = descs[toolId] || '';
            lucide.createIcons();
        }

        // Motion Shots UI
        function initMotionShotsUI() {
            const container = document.getElementById('motion-shots-upload');
            if (!container) return;
            container.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                container.innerHTML += `
                    <div id="motion-shot-${i}" class="upload-zone rounded-lg p-3 flex items-center gap-3 cursor-pointer" onclick="triggerMotionShot(${i})">
                        <input type="file" id="motion-file-${i}" class="hidden" accept="image/*" onchange="handleMotionShotSelect(event, ${i})" />
                        <div id="motion-preview-${i}" class="hidden w-12 h-12 rounded-lg overflow-hidden">
                            <img src="" class="w-full h-full object-cover" />
                        </div>
                        <div id="motion-placeholder-${i}" class="flex items-center gap-2">
                            <i data-lucide="image" class="w-5 h-5 text-gray-400"></i>
                            <span class="text-sm text-gray-400">Shot ${i}</span>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function triggerMotionShot(num) {
            document.getElementById(`motion-file-${num}`).click();
        }

        function handleMotionShotSelect(event, num) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById(`motion-preview-${num}`);
                const placeholder = document.getElementById(`motion-placeholder-${num}`);
                const zone = document.getElementById(`motion-shot-${num}`);
                preview.querySelector('img').src = e.target.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                zone.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        // FLF Upload
        function triggerFLFUpload(frameType) {
            document.getElementById(`file-${frameType}`).click();
        }

        function handleFLFSelect(event, frameType) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById(`preview-${frameType}`);
                const placeholder = document.getElementById(`placeholder-${frameType}`);
                const zone = document.getElementById(`zone-${frameType}`);
                preview.querySelector('img').src = e.target.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                zone.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        function clearFLFImage(frameType) {
            const preview = document.getElementById(`preview-${frameType}`);
            const placeholder = document.getElementById(`placeholder-${frameType}`);
            const zone = document.getElementById(`zone-${frameType}`);
            const fileInput = document.getElementById(`file-${frameType}`);
            if (preview) preview.classList.add('hidden');
            if (placeholder) placeholder.classList.remove('hidden');
            if (zone) zone.classList.remove('has-image');
            if (fileInput) fileInput.value = '';
        }

        // Motion Generate
        async function handleMotionGenerate() {
            console.log('[Motion] Generate triggered');
            const statusEl = document.getElementById('motion-status');
            statusEl.classList.remove('hidden');
            statusEl.textContent = '準備中...';
            statusEl.className = 'text-sm text-center text-amber-400';
            // TODO: Implement actual API call
            setTimeout(() => {
                statusEl.textContent = '功能開發中，敬請期待！';
                statusEl.className = 'text-sm text-center text-gray-400';
            }, 1000);
        }

        // ==========================================
        // Avatar Studio
        // ==========================================
        let avatarImage = null;
        let avatarAudio = null;

        function triggerAvatarImageUpload() {
            document.getElementById('avatar-image-input').click();
        }

        function handleAvatarImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            avatarImage = file;
            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById('avatar-image-preview');
                const placeholder = document.getElementById('avatar-image-placeholder');
                const zone = document.getElementById('avatar-image-zone');
                preview.querySelector('img').src = e.target.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                zone.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        function clearAvatarImage() {
            avatarImage = null;
            document.getElementById('avatar-image-preview').classList.add('hidden');
            document.getElementById('avatar-image-placeholder').classList.remove('hidden');
            document.getElementById('avatar-image-zone').classList.remove('has-image');
            document.getElementById('avatar-image-input').value = '';
        }

        function triggerAvatarAudioUpload() {
            document.getElementById('avatar-audio-input').click();
        }

        function handleAvatarAudioSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            avatarAudio = file;
            document.getElementById('avatar-audio-filename').textContent = file.name;
            document.getElementById('avatar-audio-preview').classList.remove('hidden');
            document.getElementById('avatar-audio-placeholder').classList.add('hidden');
            document.getElementById('avatar-audio-zone').classList.add('has-image');
        }

        function clearAvatarAudio() {
            avatarAudio = null;
            document.getElementById('avatar-audio-preview').classList.add('hidden');
            document.getElementById('avatar-audio-placeholder').classList.remove('hidden');
            document.getElementById('avatar-audio-zone').classList.remove('has-image');
            document.getElementById('avatar-audio-input').value = '';
        }

        async function generateAvatarVideo() {
            console.log('[Avatar] Generate triggered');
            const statusEl = document.getElementById('avatar-status');
            statusEl.classList.remove('hidden');
            statusEl.textContent = '準備中...';
            statusEl.className = 'mt-4 p-4 rounded-xl text-center bg-blue-500/10 text-blue-400';
            // TODO: Implement actual API call
            setTimeout(() => {
                statusEl.textContent = '功能開發中，敬請期待！';
                statusEl.className = 'mt-4 p-4 rounded-xl text-center bg-gray-500/10 text-gray-400';
            }, 1000);
        }

        // ==========================================
        // Gallery
        // ==========================================
        async function loadHistory() {
            console.log('[Gallery] Loading history...');
            const grid = document.getElementById('gallery-grid');
            if (!grid) return;
            grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500"><i data-lucide="loader" class="w-8 h-8 mx-auto mb-4 animate-spin"></i><p>載入歷史記錄中...</p></div>';
            lucide.createIcons();
            try {
                const response = await fetch(`${API_BASE}/api/history`, { credentials: 'include' });
                const data = await response.json();
                if (data.history && data.history.length > 0) {
                    grid.innerHTML = data.history.map(item => `
                        <div class="glass-card rounded-xl overflow-hidden group">
                            <div class="aspect-square relative">
                                <img src="${item.output_url || '/static/placeholder.png'}" alt="${item.tool}" class="w-full h-full object-cover" />
                                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                                    <a href="${item.output_url}" target="_blank" class="p-2 rounded-lg bg-white/20 hover:bg-white/30"><i data-lucide="external-link" class="w-5 h-5"></i></a>
                                </div>
                            </div>
                            <div class="p-4">
                                <div class="text-sm font-bold text-white mb-1">${item.tool}</div>
                                <div class="text-xs text-gray-500">${new Date(item.created_at).toLocaleString()}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4"></i><p>目前沒有歷史記錄</p></div>';
                }
                lucide.createIcons();
            } catch (error) {
                console.error('[Gallery] Error:', error);
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-red-400"><i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-4"></i><p>載入失敗</p></div>';
                lucide.createIcons();
            }
        }

        // ESC key handler
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const imageOverlay = document.getElementById('tool-selector-overlay');
                const videoOverlay = document.getElementById('video-tool-selector-overlay');
                if (imageOverlay && !imageOverlay.classList.contains('hidden')) {
                    hideCompositionMenu();
                } else if (videoOverlay && !videoOverlay.classList.contains('hidden')) {
                    hideVideoToolMenu();
                }
            }
        });
    </script>

</body>

</html>