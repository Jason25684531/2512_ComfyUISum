# ğŸ¨ ComfyUI Studio - AI åœ–åƒç”Ÿæˆå·¥ä½œç«™

> ä¸€å€‹æ•´åˆ ComfyUI çš„ç¾ä»£åŒ– AI åœ–åƒç”Ÿæˆå¹³å°ï¼Œæä¾›ç›´è¦ºçš„ Web ä»‹é¢è®“è¨­è¨ˆå¸«è¼•é¬†ä½¿ç”¨ AI å·¥å…·ã€‚

---

## ğŸ“‹ ç›®éŒ„

- [å¿«é€Ÿé–‹å§‹](#-å¿«é€Ÿé–‹å§‹)
- [å°ˆæ¡ˆæ¶æ§‹](#-å°ˆæ¡ˆæ¶æ§‹)
- [ç³»çµ±éœ€æ±‚](#-ç³»çµ±éœ€æ±‚)
- [è©³ç´°å®‰è£](#-è©³ç´°å®‰è£)
- [å•Ÿå‹•æœå‹™](#-å•Ÿå‹•æœå‹™)
- [åŠŸèƒ½èªªæ˜](#-åŠŸèƒ½èªªæ˜)
- [API æ–‡æª”](#-api-æ–‡æª”)
- [ç¶­è­·æŒ‡å—](#-ç¶­è­·æŒ‡å—)
- [æ•…éšœæ’é™¤](#-æ•…éšœæ’é™¤)

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

```powershell
# 1. ç¢ºä¿ ComfyUI æ­£åœ¨é‹è¡Œ (API æ¨¡å¼)
D:\02_software\ComfyUI_windows_portable\run_nvidia_gpu.bat

# 2. å•Ÿå‹• Docker æœå‹™ (Redis + MySQL)
docker-compose up -d

# 3. ä¸€éµå•Ÿå‹• Backend + Worker
.\start_all.bat

# 4. é–‹å•Ÿå‰ç«¯ (ä½¿ç”¨ VS Code Live Server)
# ç€è¦½å™¨é–‹å•Ÿ: http://127.0.0.1:5500/frontend/index.html
```

**é‡è¦æé†’**ï¼š
- é¦–æ¬¡å•Ÿå‹•æ™‚ MySQL æœƒè‡ªå‹•åˆå§‹åŒ–è³‡æ–™åº«å’Œ `jobs` è¡¨
- ç¢ºä¿ 3306 (MySQL), 6379 (Redis), 5000 (Backend) ç«¯å£æœªè¢«å ç”¨
- å¯ä½¿ç”¨ DBeaver é€£æ¥ `localhost:3306` æŸ¥çœ‹è³‡æ–™åº«å…§å®¹

---

## ğŸ—ï¸ å°ˆæ¡ˆæ¶æ§‹

```
ComfyUISum/
â”œâ”€â”€ .env                     # ç’°å¢ƒè®Šæ•¸ (Redis, MySQL, ComfyUI è·¯å¾‘)
â”œâ”€â”€ docker-compose.yml       # Docker æœå‹™ç·¨æ’ (Redis, MySQL, Backend, Worker)
â”œâ”€â”€ start_all.bat            # ä¸€éµå•Ÿå‹•è…³æœ¬ (Windows)
â”œâ”€â”€ start_all_with_docker.bat # Docker å®¹å™¨å•Ÿå‹•è…³æœ¬
â”‚
â”œâ”€â”€ frontend/                # å‰ç«¯ Web ä»‹é¢
â”‚   â”œâ”€â”€ index.html           # ä¸»é é¢ (SPA - æ•´åˆæ‰€æœ‰ JS é‚è¼¯)
â”‚   â””â”€â”€ style.css            # æ¨£å¼è¡¨ (Tailwind CSS)
â”‚
â”œâ”€â”€ backend/                 # Flask API æœå‹™ (Port 5000)
â”‚   â”œâ”€â”€ Dockerfile           # Backend å®¹å™¨æ˜ åƒ
â”‚   â”œâ”€â”€ requirements.txt     # Python ä¾è³´
â”‚   â”œâ”€â”€ Readmd/              # API æ¸¬è©¦èˆ‡æ–‡æª”
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ app.py           # API å…¥å£ + è·¯ç”±å®šç¾© + æ—¥èªŒé…ç½®
â”‚       â”œâ”€â”€ config.py        # é…ç½®ç®¡ç†
â”‚       â””â”€â”€ database.py      # MySQL è³‡æ–™åº«æ“ä½œé¡
â”‚
â”œâ”€â”€ worker/                  # ä»»å‹™è™•ç†å™¨ (é€£æ¥ ComfyUI)
â”‚   â”œâ”€â”€ Dockerfile           # Worker å®¹å™¨æ˜ åƒ
â”‚   â”œâ”€â”€ requirements.txt     # Python ä¾è³´
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ main.py          # Worker ä¸»è¿´åœˆ + å®Œæ•´æ—¥èªŒç³»çµ±
â”‚       â”œâ”€â”€ json_parser.py   # Workflow è§£æèˆ‡åƒæ•¸æ³¨å…¥
â”‚       â”œâ”€â”€ comfy_client.py  # ComfyUI HTTP/WebSocket é€šè¨Š
â”‚       â”œâ”€â”€ config.py        # Worker é…ç½®
â”‚       â””â”€â”€ check_comfy_connection.py  # é€£ç·šè¨ºæ–·å·¥å…·
â”‚
â”œâ”€â”€ ComfyUIworkflow/         # ComfyUI Workflow æ¨¡æ¿ (JSON)
â”‚   â”œâ”€â”€ config.json          # å·¥ä½œæµé…ç½®
â”‚   â”œâ”€â”€ text_to_image_*.json
â”‚   â”œâ”€â”€ face_swap_*.json
â”‚   â”œâ”€â”€ multi_image_blend_*.json
â”‚   â”œâ”€â”€ sketch_to_image_*.json
â”‚   â””â”€â”€ single_image_edit_*.json
â”‚
â”œâ”€â”€ storage/                 # æª”æ¡ˆå­˜å„²
â”‚   â”œâ”€â”€ inputs/              # ä¸Šå‚³çš„åƒè€ƒåœ– (24h è‡ªå‹•æ¸…ç†)
â”‚   â”œâ”€â”€ outputs/             # ç”Ÿæˆçš„çµæœåœ– (30å¤© è‡ªå‹•æ¸…ç†)
â”‚   â””â”€â”€ models/              # æ¨¡å‹ç›®éŒ„ (å¯é¸)
â”‚
â”œâ”€â”€ logs/                    # æ—¥èªŒç›®éŒ„ (Phase 4 æ–°å¢)
â”‚   â”œâ”€â”€ backend.log          # Backend API æ—¥èªŒ (5MB è¼ªè½‰)
â”‚   â”œâ”€â”€ worker.log           # Worker ä»»å‹™è™•ç†æ—¥èªŒ (5MB è¼ªè½‰)
â”‚   â””â”€â”€ .keep                # ä¿ç•™ç›®éŒ„çµæ§‹
â”‚
â”œâ”€â”€ mysql_data/              # MySQL æŒä¹…åŒ–è³‡æ–™
â”œâ”€â”€ redis_data/              # Redis æŒä¹…åŒ–è³‡æ–™
â”‚
â””â”€â”€ openspec/                # å°ˆæ¡ˆè¦æ ¼æ–‡æª” (çµ¦ AI Agent ä½¿ç”¨)
    â”œâ”€â”€ AGENTS.md            # AI ä»£ç†æŒ‡ä»¤
    â”œâ”€â”€ project.md           # å°ˆæ¡ˆå®šç¾©
    â”œâ”€â”€ specs/               # æ¨¡çµ„è¦æ ¼
    â””â”€â”€ changes/             # è®Šæ›´è¨˜éŒ„èˆ‡ä»»å‹™è¿½è¹¤
```

### ç³»çµ±æ¶æ§‹åœ– (Phase 4 å®Œæ•´ç‰ˆ)

### ç³»çµ±æ¶æ§‹åœ– (Phase 4 å®Œæ•´ç‰ˆ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä½¿ç”¨è€…ä»‹é¢ (Frontend)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚Dashboard â”‚  â”‚ Canvas   â”‚  â”‚ Gallery  â”‚  â”‚ Settings â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚             â”‚             â”‚             â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                   HTTP REST API (Port 5500)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Backend API (Flask - Port 5000)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  POST /api/generate  â†’ æäº¤ä»»å‹™åˆ° Redis Queue         â”‚  â”‚
â”‚  â”‚  GET  /api/status    â†’ æŸ¥è©¢ Redis ä»»å‹™ç‹€æ…‹           â”‚  â”‚
â”‚  â”‚  GET  /api/history   â†’ æŸ¥è©¢ MySQL æ­·å²è¨˜éŒ„ (åˆ†é )    â”‚  â”‚
â”‚  â”‚  GET  /api/models    â†’ æƒæ ComfyUI æ¨¡å‹ç›®éŒ„         â”‚  â”‚
â”‚  â”‚  GET  /outputs/*     â†’ éœæ…‹æª”æ¡ˆæœå‹™ (ç”Ÿæˆåœ–ç‰‡)       â”‚  â”‚
â”‚  â”‚  POST /api/cancel    â†’ å–æ¶ˆåŸ·è¡Œä¸­çš„ä»»å‹™              â”‚  â”‚
â”‚  â”‚  GET  /health        â†’ å¥åº·æª¢æŸ¥ (Redis + MySQL)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  ğŸ“ æ—¥èªŒç³»çµ±: logs/backend.log                              â”‚
â”‚     - RotatingFileHandler (5MB Ã— 3 backups)                â”‚
â”‚     - è¨˜éŒ„æ‰€æœ‰ HTTP è«‹æ±‚ (Method, Path, Status)            â”‚
â”‚     - è¨˜éŒ„ Exception Stack Trace                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                      â”‚
                    â–¼                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Redis (Port 6379)  â”‚  â”‚  MySQL (Port 3306)  â”‚
        â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
        â”‚  Queue:             â”‚  â”‚  Table: jobs        â”‚
        â”‚  - studio_jobs      â”‚  â”‚  - id, prompt       â”‚
        â”‚                     â”‚  â”‚  - workflow, model  â”‚
        â”‚  Hash:              â”‚  â”‚  - status, output   â”‚
        â”‚  - job:status:{id}  â”‚  â”‚  - created_at       â”‚
        â”‚  - TTL: 24h         â”‚  â”‚  - is_deleted       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                        â”‚
                   â”‚ BLPOP (é˜»å¡å¼è®€å–)      â”‚ è®€å¯«åŒæ­¥
                   â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Worker (Python å¾Œå°æœå‹™)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. å¾ Redis Queue å–å¾—ä»»å‹™ (BLPOP studio_jobs)       â”‚  â”‚
â”‚  â”‚  2. è§£æ Workflow JSON ä¸¦æ³¨å…¥åƒæ•¸                     â”‚  â”‚
â”‚  â”‚  3. è™•ç† Base64 åœ–ç‰‡å­˜åˆ° ComfyUI/input/              â”‚  â”‚
â”‚  â”‚  4. é€é HTTP POST /prompt æäº¤åˆ° ComfyUI            â”‚  â”‚
â”‚  â”‚  5. é€é WebSocket /ws ç›£è½åŸ·è¡Œé€²åº¦ (0-100%)         â”‚  â”‚
â”‚  â”‚  6. è¤‡è£½è¼¸å‡ºåœ–ç‰‡åˆ° storage/outputs/                   â”‚  â”‚
â”‚  â”‚  7. æ›´æ–° Redis ç‹€æ…‹ + MySQL è¨˜éŒ„ (output_path)       â”‚  â”‚
â”‚  â”‚  8. å®šæœŸæ¸…ç†éæœŸæª”æ¡ˆ (inputs: 24h, outputs: 30å¤©)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  ğŸ“ æ—¥èªŒç³»çµ±: logs/worker.log                               â”‚
â”‚     - RotatingFileHandler (5MB Ã— 3 backups)                â”‚
â”‚     - è¨˜éŒ„ä»»å‹™ç”Ÿå‘½é€±æœŸ (é–‹å§‹ã€é€²åº¦ã€å®Œæˆã€å¤±æ•—)             â”‚
â”‚     - è¨˜éŒ„ ComfyUI é€£ç·šç‹€æ…‹å’Œé‡è©¦äº‹ä»¶                       â”‚
â”‚     - æ‰€æœ‰ print() å·²æ›¿æ›ç‚º logger.info/warning/error()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ HTTP API + WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ComfyUI (Port 8188) - AI åœ–åƒç”Ÿæˆå¼•æ“             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  HTTP API:                                            â”‚  â”‚
â”‚  â”‚  - POST /prompt       â†’ æäº¤ç”Ÿæˆä»»å‹™                  â”‚  â”‚
â”‚  â”‚  - POST /interrupt    â†’ ä¸­æ–·åŸ·è¡Œä¸­çš„ä»»å‹™              â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  WebSocket:                                           â”‚  â”‚
â”‚  â”‚  - /ws                â†’ å³æ™‚é€²åº¦æ¨é€                  â”‚  â”‚
â”‚  â”‚    â”œâ”€ progress event  â†’ {value, max}                â”‚  â”‚
â”‚  â”‚    â”œâ”€ executing event â†’ {node, prompt_id}           â”‚  â”‚
â”‚  â”‚    â””â”€ executed event  â†’ {output: {images}}          â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  File System:                                         â”‚  â”‚
â”‚  â”‚  - input/  â†’ æ¥æ”¶ä¸Šå‚³åœ–ç‰‡                            â”‚  â”‚
â”‚  â”‚  - output/ â†’ ç”Ÿæˆçµæœè¼¸å‡º                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å®Œæ•´ä»»å‹™ç”Ÿå‘½é€±æœŸæµç¨‹

### 1ï¸âƒ£ ä»»å‹™æäº¤éšæ®µ
```
ç”¨æˆ¶æ“ä½œ (Frontend)
  â†“
å¡«å¯« Prompt + ä¸Šå‚³åœ–ç‰‡ + è¨­å®šåƒæ•¸ (Model, Seed, Aspect Ratio)
  â†“
é»æ“Š "Generate" æŒ‰éˆ•
  â†“
POST /api/generate {workflow, prompt, images, ...}
  â†“
Backend API æ¥æ”¶è«‹æ±‚
  â†“
1. é©—è­‰åƒæ•¸æ ¼å¼
2. ç”Ÿæˆå”¯ä¸€ Job ID (UUID)
3. å¯«å…¥ MySQL jobs è¡¨ (status: "queued")
4. æ¨é€åˆ° Redis Queue (RPUSH studio_jobs)
5. åˆå§‹åŒ– Redis Hash (job:status:{job_id})
  â†“
è¿”å› 202 {"job_id": "xxx", "status": "queued"}
  â†“
å‰ç«¯é–‹å§‹è¼ªè©¢ GET /api/status/{job_id} (æ¯ 2 ç§’)
```

### 2ï¸âƒ£ ä»»å‹™è™•ç†éšæ®µ
```
Worker ä¸»è¿´åœˆç›£è½ (BLPOP studio_jobs)
  â†“
å–å¾—ä»»å‹™ JSON (é˜»å¡å¼ç­‰å¾…)
  â†“
logger.info("ğŸš€ é–‹å§‹è™•ç†ä»»å‹™: {job_id}")
  â†“
æ›´æ–°ç‹€æ…‹: processing (10% - é–‹å§‹è™•ç†)
  â†“
è™•ç†ä¸Šå‚³åœ–ç‰‡ (15%)
  â”œâ”€ è§£ç¢¼ Base64 â†’ å­˜åˆ° ComfyUI/input/upload_{uuid}.png
  â””â”€ logger.info("ğŸ“· è™•ç†äº† {count} å¼µè¼¸å…¥åœ–ç‰‡")
  â†“
è§£æ Workflow JSON (20%)
  â”œâ”€ è¼‰å…¥å°æ‡‰æ¨¡æ¿ (text_to_image, face_swap, etc.)
  â”œâ”€ æ³¨å…¥åƒæ•¸: prompt, seed, model, aspect_ratio
  â””â”€ æ³¨å…¥åœ–ç‰‡è·¯å¾‘: IMAGE_NODE_MAP æ˜ å°„
  â†“
æäº¤åˆ° ComfyUI (30%)
  â”œâ”€ POST http://localhost:8188/prompt
  â”œâ”€ ç²å¾— prompt_id
  â””â”€ logger.info("âœ… ä»»å‹™å·²æäº¤åˆ° ComfyUI: {prompt_id}")
  â†“
WebSocket ç›£è½é€²åº¦ (30-95%)
  â”œâ”€ é€£æ¥ ws://localhost:8188/ws?clientId={client_id}
  â”œâ”€ æ¥æ”¶ progress äº‹ä»¶: {"value": X, "max": Y}
  â”œâ”€ è¨ˆç®—ç™¾åˆ†æ¯”: int((X / Y) * 100)
  â”œâ”€ æ›´æ–° Redis: HSET job:status:{job_id} progress {30-95}
  â””â”€ å‰ç«¯å³æ™‚é¡¯ç¤º: "ğŸ”„ Processing... 65%"
  â†“
ä»»å‹™å®Œæˆ (ComfyUI)
  â”œâ”€ æ¥æ”¶ executed äº‹ä»¶: {"output": {"images": [...]}}
  â”œâ”€ logger.info("ğŸ‰ ComfyUI ä»»å‹™å®Œæˆ")
  â””â”€ ç²å–è¼¸å‡ºåœ–ç‰‡è³‡è¨Š
  â†“
è¤‡è£½è¼¸å‡ºåœ–ç‰‡ (95%)
  â”œâ”€ ä¾†æº: ComfyUI/output/{filename}.png
  â”œâ”€ ç›®æ¨™: storage/outputs/{job_id}_{filename}.png
  â”œâ”€ æ™ºèƒ½é¸æ“‡: å„ªå…ˆå¸¶ subfolder çš„æ­£å¼è¼¸å‡º
  â””â”€ logger.info(f"ğŸ“· æ”¶åˆ° {len(images)} å¼µè¼¸å‡ºåœ–ç‰‡")
  â†“
æ›´æ–°æœ€çµ‚ç‹€æ…‹ (100%)
  â”œâ”€ Redis: HSET job:status:{job_id} status "finished"
  â”œâ”€ Redis: HSET job:status:{job_id} image_url "/outputs/{filename}"
  â”œâ”€ MySQL: UPDATE jobs SET status="finished", output_path="..."
  â””â”€ logger.info("âœ… ä»»å‹™å®Œæˆ: {job_id}")
```

### 3ï¸âƒ£ çµæœå±•ç¤ºéšæ®µ
```
å‰ç«¯è¼ªè©¢æª¢æ¸¬åˆ° status: "finished"
  â†“
åœæ­¢è¼ªè©¢
  â†“
è§£æ image_url: "/outputs/{filename}.png"
  â†“
æ§‹å»ºå®Œæ•´ URL: API_BASE + image_url
  â†“
é¡¯ç¤ºçµæœåœ–ç‰‡
  â”œâ”€ å–®å¼µ: grid-cols-1 (ç½®ä¸­é¡¯ç¤º)
  â”œâ”€ 2å¼µ: grid-cols-2 (é›™æ¬„)
  â””â”€ 3-4å¼µ: grid-cols-2 grid-rows-2 (2Ã—2 ç¶²æ ¼)
  â†“
æä¾›æ“ä½œæŒ‰éˆ•
  â”œâ”€ Download (ä¸‹è¼‰åˆ°æœ¬åœ°)
  â””â”€ Generate Again (é‡æ–°ç”Ÿæˆ)
  â†“
åŒæ­¥åˆ° Personal Gallery
  â”œâ”€ é¡¯ç¤ºç¸®åœ– + æç¤ºè©
  â”œâ”€ ç‹€æ…‹æ¨™è¨˜ (âœ… Finished, âŒ Failed)
  â””â”€ Remix æŒ‰éˆ• (é‡æ–°ä½¿ç”¨åƒæ•¸)
```

### 4ï¸âƒ£ éŒ¯èª¤è™•ç†æµç¨‹
```
ä»»ä½•éšæ®µç™¼ç”ŸéŒ¯èª¤
  â†“
Worker æ•ç² Exception
  â†“
logger.error(f"âŒ ä»»å‹™å¤±æ•—: {error}", exc_info=True)
  â†“
æ›´æ–°ç‹€æ…‹
  â”œâ”€ Redis: HSET job:status:{job_id} status "failed"
  â”œâ”€ Redis: HSET job:status:{job_id} error "{error_message}"
  â””â”€ MySQL: UPDATE jobs SET status="failed"
  â†“
å‰ç«¯é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
  â””â”€ "âŒ Generation Failed: {error}"
  â†“
ComfyUI é€£ç·šå¤±æ•— â†’ è‡ªå‹•é‡è©¦ 1 æ¬¡ (5ç§’å»¶é²)
```

### 5ï¸âƒ£ è‡ªå‹•ç¶­è­·æµç¨‹
```
Worker å•Ÿå‹•æ™‚
  â†“
cleanup_old_files()
  â”œâ”€ æƒæ storage/inputs (åˆªé™¤ > 24h)
  â”œâ”€ æƒæ storage/outputs (åˆªé™¤ > 30å¤©)
  â”œâ”€ æƒæ ComfyUI/input/upload_* (åˆªé™¤ > 1h)
  â”œâ”€ æ¨™è¨˜è³‡æ–™åº« is_deleted = TRUE (è»Ÿåˆªé™¤)
  â””â”€ logger.info("ğŸ§¹ æ¸…ç†äº† {count} å€‹æª”æ¡ˆ")
  â†“
æ¯å°æ™‚å®šæœŸåŸ·è¡Œ cleanup_old_files()
```

---

## ğŸ“ æ—¥èªŒç³»çµ± (Phase 4 æ–°å¢)

### Backend æ—¥èªŒé…ç½®

**æª”æ¡ˆä½ç½®**: `logs/backend.log`

**è¼ªè½‰ç­–ç•¥**:
- å–®æª”æœ€å¤§: 5MB
- ä¿ç•™å‚™ä»½: 3 ä»½ (backend.log.1, backend.log.2, backend.log.3)
- ç·¨ç¢¼: UTF-8

**è¨˜éŒ„å…§å®¹**:
```
2026-01-05 10:30:15,123 - backend.app - INFO - POST /api/generate - 202
2026-01-05 10:30:17,456 - backend.app - INFO - GET /api/status/abc-123 - 200
2026-01-05 10:30:20,789 - backend.app - ERROR - Database connection failed
Traceback (most recent call last):
  ...
```

### Worker æ—¥èªŒé…ç½®

**æª”æ¡ˆä½ç½®**: `logs/worker.log`

**è¼ªè½‰ç­–ç•¥**:
- å–®æª”æœ€å¤§: 5MB
- ä¿ç•™å‚™ä»½: 3 ä»½
- ç·¨ç¢¼: UTF-8

**è¨˜éŒ„å…§å®¹**:
```
2026-01-05 10:30:15,123 - worker.main - INFO - ============================================================
2026-01-05 10:30:15,124 - worker.main - INFO - Worker æ—¥èªŒç³»çµ±å·²å•Ÿå‹•
2026-01-05 10:30:15,125 - worker.main - INFO - æ—¥èªŒæª”æ¡ˆä½ç½®: D:\...\logs\worker.log
2026-01-05 10:30:16,200 - worker.main - INFO - ğŸš€ é–‹å§‹è™•ç†ä»»å‹™: abc-123
2026-01-05 10:30:16,250 - worker.main - INFO - ğŸ“· è™•ç†äº† 2 å¼µè¼¸å…¥åœ–ç‰‡
2026-01-05 10:30:17,100 - worker.main - INFO - âœ… ä»»å‹™å·²æäº¤åˆ° ComfyUI: prompt-456
2026-01-05 10:30:25,500 - worker.main - INFO - ğŸ“· æ”¶åˆ° 4 å¼µè¼¸å‡ºåœ–ç‰‡
2026-01-05 10:30:26,000 - worker.main - INFO - âœ… ä»»å‹™å®Œæˆ: abc-123
```

### æ—¥èªŒç´šåˆ¥èªªæ˜

| ç´šåˆ¥ | ç”¨é€” | ç¯„ä¾‹ |
|------|------|------|
| **INFO** | æ­£å¸¸æ“ä½œè¨˜éŒ„ | ä»»å‹™é–‹å§‹ã€API è«‹æ±‚ã€ä»»å‹™å®Œæˆ |
| **WARNING** | éè‡´å‘½è­¦å‘Š | é‡è©¦æ“ä½œã€é™ç´šåŠŸèƒ½ |
| **ERROR** | åš´é‡éŒ¯èª¤ | ä»»å‹™å¤±æ•—ã€é€£ç·šä¸­æ–·ã€Exception |

### æŸ¥çœ‹æ—¥èªŒæŒ‡ä»¤

```powershell
# å³æ™‚ç›£æ§ Backend æ—¥èªŒ
Get-Content logs\backend.log -Tail 50 -Wait

# å³æ™‚ç›£æ§ Worker æ—¥èªŒ
Get-Content logs\worker.log -Tail 50 -Wait

# æœå°‹éŒ¯èª¤è¨˜éŒ„
Select-String -Path logs\*.log -Pattern "ERROR"

# æŸ¥çœ‹ç‰¹å®šä»»å‹™çš„æ—¥èªŒ
Select-String -Path logs\worker.log -Pattern "abc-123"
```

---

## ğŸ’» ç³»çµ±éœ€æ±‚

| é …ç›® | æœ€ä½éœ€æ±‚ | å»ºè­°é…ç½® |
|------|---------|---------|
| ä½œæ¥­ç³»çµ± | Windows 10/11 | Windows 11 |
| Python | 3.10+ | 3.11 |
| é¡¯å¡ | GTX 1060 6GB | RTX 3060 12GB+ |
| RAM | 16GB | 32GB |
| Docker | Docker Desktop | Docker Desktop |

### å¿…è¦è»Ÿé«”

- [Python 3.10+](https://www.python.org/downloads/)
- [Docker Desktop](https://www.docker.com/products/docker-desktop/)
- [ComfyUI](https://github.com/comfyanonymous/ComfyUI)
- [VS Code](https://code.visualstudio.com/) + Live Server æ“´å±•

---

## ğŸ“¦ è©³ç´°å®‰è£

### 1. Clone å°ˆæ¡ˆ

```powershell
git clone <repository-url>
cd 2512_ComfyUISum
```

### 2. å»ºç«‹è™›æ“¬ç’°å¢ƒ

```powershell
python -m venv venv
.\venv\Scripts\activate
pip install -r requirements.txt
```

### 3. è¨­å®šç’°å¢ƒè®Šæ•¸

```powershell
# è¤‡è£½ç¯„æœ¬ä¸¦ç·¨è¼¯
copy .env.example .env
```

`.env` å…§å®¹ï¼š
```ini
# Redis Configuration
REDIS_PASSWORD=mysecret
REDIS_HOST=localhost
REDIS_PORT=6379

# MySQL Configuration
DB_HOST=localhost
DB_PORT=3306
DB_USER=studio_user
DB_PASSWORD=studio_password
DB_NAME=studio_db

# ComfyUI Configuration
COMFYUI_HOST=http://127.0.0.1:8188
COMFYUI_ROOT=D:\02_software\ComfyUI_windows_portable\ComfyUI
COMFYUI_INPUT_DIR=D:\02_software\ComfyUI_windows_portable\ComfyUI\input
COMFYUI_OUTPUT_DIR=D:\02_software\ComfyUI_windows_portable\ComfyUI\output

# Application Settings
STORAGE_BASE_PATH=./storage
LOG_LEVEL=INFO
```

### 4. å•Ÿå‹• Docker æœå‹™

```powershell
# å•Ÿå‹•æ‰€æœ‰ Docker æœå‹™ (Redis + MySQL)
docker-compose up -d

# é©—è­‰ Redis é€£æ¥
docker exec studio-redis redis-cli -a mysecret ping
# æ‡‰è©²å›æ‡‰: PONG

# é©—è­‰ MySQL é€£æ¥
docker exec studio-mysql mysql -uroot -proot_password -e "SHOW DATABASES;"
# æ‡‰è©²çœ‹åˆ° studio_db è³‡æ–™åº«
```

**é¦–æ¬¡å•Ÿå‹•æé†’**:
- MySQL æœƒè‡ªå‹•åˆå§‹åŒ–è³‡æ–™åº«å’Œ `jobs` è¡¨
- ç¢ºä¿ 3306 (MySQL), 6379 (Redis), 5000 (Backend) ç«¯å£æœªè¢«å ç”¨
- å¯ä½¿ç”¨ DBeaver é€£æ¥ `localhost:3306` æŸ¥çœ‹è³‡æ–™åº«å…§å®¹

### 5. è¨­å®š ComfyUI

ç¢ºä¿ ComfyUI å•Ÿå‹•åƒæ•¸åŒ…å«ï¼š
```
--listen --enable-cors-header *
```

---

## ğŸ”§ å•Ÿå‹•æœå‹™

### å®Œæ•´å•Ÿå‹•æµç¨‹ï¼ˆæ¨è–¦ï¼‰

#### Step 1: å•Ÿå‹• ComfyUI
```powershell
# é€²å…¥ ComfyUI ç›®éŒ„ä¸¦å•Ÿå‹• (API æ¨¡å¼)
D:\02_software\ComfyUI_windows_portable\run_nvidia_gpu.bat

# ç¢ºèªå•Ÿå‹•æˆåŠŸï¼šç€è¦½å™¨é–‹å•Ÿ http://127.0.0.1:8188
```

**é‡è¦**: ç¢ºä¿ ComfyUI å•Ÿå‹•åƒæ•¸åŒ…å«ï¼š
```
--listen --enable-cors-header *
```

#### Step 2: å•Ÿå‹• Docker æœå‹™
```powershell
# å•Ÿå‹• Redis + MySQL
docker-compose up -d

# æŸ¥çœ‹æœå‹™ç‹€æ…‹
docker-compose ps

# æ‡‰è©²çœ‹åˆ°:
# studio-redis   running   0.0.0.0:6379->6379/tcp
# studio-mysql   running   0.0.0.0:3306->3306/tcp
```

#### Step 3: å•Ÿå‹• Backend + Worker

**æ–¹æ³• 1ï¼šä¸€éµå•Ÿå‹•ï¼ˆæ¨è–¦ï¼‰**
```powershell
.\start_all.bat
```
é€™æœƒåœ¨ç¨ç«‹è¦–çª—å•Ÿå‹• Backend API å’Œ Workerï¼Œä¸¦è‡ªå‹•é…ç½®æ—¥èªŒç³»çµ±ã€‚

**æ–¹æ³• 2ï¼šæ‰‹å‹•å•Ÿå‹•ï¼ˆé–‹ç™¼é™¤éŒ¯ç”¨ï¼‰**

**çµ‚ç«¯ 1 - Backend APIï¼š**
```powershell
.\venv\Scripts\activate
python backend/src/app.py

# æˆåŠŸè¨Šæ¯:
#  * Running on http://0.0.0.0:5000
#  * Restarting with stat
# Backend æ—¥èªŒ: logs/backend.log
```

**çµ‚ç«¯ 2 - Workerï¼š**
```powershell
.\venv\Scripts\activate
python worker/src/main.py

# æˆåŠŸè¨Šæ¯:
# Worker æ—¥èªŒç³»çµ±å·²å•Ÿå‹•
# æ—¥èªŒæª”æ¡ˆä½ç½®: D:\...\logs\worker.log
# Worker å·²å•Ÿå‹•ï¼Œç­‰å¾…ä»»å‹™...
```

#### Step 4: é–‹å•Ÿå‰ç«¯

**æ–¹æ³• 1: VS Code Live Server**
1. åœ¨ VS Code ä¸­é–‹å•Ÿ `frontend/index.html`
2. å³éµé¸æ“‡ "Open with Live Server"
3. ç€è¦½å™¨è‡ªå‹•é–‹å•Ÿ: `http://127.0.0.1:5500/frontend/index.html`

**æ–¹æ³• 2: ç›´æ¥é–‹å•Ÿ**
```powershell
# ä½¿ç”¨é è¨­ç€è¦½å™¨é–‹å•Ÿ
start frontend/index.html
```

### æœå‹™ç‹€æ…‹æª¢æŸ¥

```powershell
# æª¢æŸ¥æ‰€æœ‰æœå‹™å¥åº·ç‹€æ…‹
curl http://localhost:5000/health

# æ­£å¸¸å›æ‡‰:
# {"status":"ok","redis":"healthy","mysql":"healthy"}

# æŸ¥çœ‹å³æ™‚æ—¥èªŒ
Get-Content logs\backend.log -Tail 50 -Wait  # Backend æ—¥èªŒ
Get-Content logs\worker.log -Tail 50 -Wait   # Worker æ—¥èªŒ
```

---

## ğŸ¯ ä½¿ç”¨ç¯„ä¾‹

### ç¯„ä¾‹ 1: Text to Image (æ–‡å­—ç”Ÿæˆåœ–ç‰‡)

1. **é¸æ“‡å·¥ä½œæµ**: Dashboard â†’ "Text to Image"
2. **å¡«å¯«æç¤ºè©**:
   ```
   a futuristic cyberpunk city at night, neon lights, rain, 8k, highly detailed
   ```
3. **è¨­å®šåƒæ•¸**:
   - Model: `z-image-turbo-fp8`
   - Aspect Ratio: `16:9`
   - Seed: `-1` (éš¨æ©Ÿ)
   - Batch Size: `2` (ç”Ÿæˆ 2 å¼µ)
4. **é»æ“Š Generate** â†’ ç­‰å¾…é€²åº¦æ¢å®Œæˆ
5. **æŸ¥çœ‹çµæœ**: é¡¯ç¤º 2 å¼µåœ–ç‰‡ï¼Œå¯ä¸‹è¼‰æˆ–é‡æ–°ç”Ÿæˆ

### ç¯„ä¾‹ 2: Face Swap (æ›è‡‰)

1. **é¸æ“‡å·¥ä½œæµ**: Dashboard â†’ "Face Swap"
2. **ä¸Šå‚³åœ–ç‰‡**:
   - Source Image: ä¸Šå‚³è‡‰éƒ¨ç‰¹å¯«ç…§ç‰‡
   - Target Image: ä¸Šå‚³è¦æ›¿æ›çš„å…¨èº«ç…§
3. **å¡«å¯«æç¤ºè©**: (å¯é¸ï¼Œå¢å¼·æ•ˆæœ)
   ```
   high quality portrait, professional photo
   ```
4. **é»æ“Š Generate** â†’ ç­‰å¾…è™•ç†
5. **æŸ¥çœ‹çµæœ**: é¡¯ç¤ºæ›è‡‰å¾Œçš„åœ–ç‰‡

### ç¯„ä¾‹ 3: æŸ¥çœ‹æ­·å²è¨˜éŒ„

1. é»æ“Š **Gallery** æ¨™ç±¤
2. ç€è¦½æ‰€æœ‰æ­·å²ç”Ÿæˆè¨˜éŒ„
3. é»æ“Š **Remix** æŒ‰éˆ•é‡æ–°ä½¿ç”¨åƒæ•¸
4. è‡ªå‹•è·³è½‰åˆ°å°æ‡‰å·¥å…·ä¸¦å¡«å……åŸå§‹è¨­å®š

---

## ğŸ› ï¸ é–‹ç™¼é™¤éŒ¯æŠ€å·§

### 1. æª¢æŸ¥ ComfyUI é€£ç·š

```powershell
# æ¸¬è©¦ ComfyUI API
curl http://127.0.0.1:8188/system_stats

# æ‡‰è©²è¿”å›ç³»çµ±çµ±è¨ˆè³‡è¨Š (JSON)
```

### 2. æª¢æŸ¥ Redis ç‹€æ…‹

```powershell
# é€²å…¥ Redis CLI
docker exec -it studio-redis redis-cli -a mysecret

# æŸ¥çœ‹ä½‡åˆ—é•·åº¦
LLEN studio_jobs

# æŸ¥çœ‹ä»»å‹™ç‹€æ…‹
HGETALL job:status:{job_id}

# æŸ¥çœ‹æ‰€æœ‰ key
KEYS *
```

### 3. æª¢æŸ¥ MySQL è³‡æ–™

```powershell
# é€²å…¥ MySQL CLI
docker exec -it studio-mysql mysql -uroot -proot_password studio_db

# æŸ¥çœ‹æ‰€æœ‰ä»»å‹™
SELECT id, prompt, workflow, status, created_at FROM jobs ORDER BY created_at DESC LIMIT 10;

# æŸ¥çœ‹å¤±æ•—ä»»å‹™
SELECT * FROM jobs WHERE status='failed';

# çµ±è¨ˆä»»å‹™ç‹€æ…‹
SELECT status, COUNT(*) FROM jobs GROUP BY status;
```

### 4. ç›£æ§æ—¥èªŒè¼¸å‡º

```powershell
# åŒæ™‚ç›£æ§å…©å€‹æ—¥èªŒæª”æ¡ˆ
Get-Content logs\backend.log, logs\worker.log -Tail 20 -Wait

# åªçœ‹éŒ¯èª¤è¨Šæ¯
Select-String -Path logs\*.log -Pattern "ERROR" | Select-Object -Last 10

# æœå°‹ç‰¹å®šä»»å‹™çš„æ—¥èªŒ
Select-String -Path logs\worker.log -Pattern "abc-123-def-456"
```

### 5. å¸¸è¦‹å•é¡Œè¨ºæ–·

**å•é¡Œ**: Worker ç„¡æ³•é€£æ¥ ComfyUI
```powershell
# è¨ºæ–·è…³æœ¬
python worker/src/check_comfy_connection.py

# æª¢æŸ¥ ComfyUI æ˜¯å¦ç›£è½
netstat -ano | findstr :8188
```

**å•é¡Œ**: Redis é€£æ¥å¤±æ•—
```powershell
# æª¢æŸ¥ Redis å®¹å™¨ç‹€æ…‹
docker logs studio-redis

# é‡å•Ÿ Redis
docker-compose restart redis
```

**å•é¡Œ**: MySQL åˆå§‹åŒ–å¤±æ•—
```powershell
# æŸ¥çœ‹ MySQL æ—¥èªŒ
docker logs studio-mysql

# å®Œå…¨é‡ç½®è³‡æ–™åº«
docker-compose down
Remove-Item -Recurse mysql_data
docker-compose up -d
```

---

## ğŸ¯ åŠŸèƒ½èªªæ˜

### æ”¯æ´çš„å·¥ä½œæµ

| å·¥å…· | èªªæ˜ | éœ€è¦åœ–ç‰‡ |
|------|------|---------|
| Text to Image | æ–‡å­—ç”Ÿæˆåœ–ç‰‡ | ç„¡ |
| Face Swap | æ›è‡‰ | Source (é ­) + Target (èº«é«”) |
| Multi-Blend | å¤šåœ–èåˆ | Image A + B + C |
| Sketch to Image | è‰ç¨¿è½‰ç²¾ç¨¿ | è‰ç¨¿åœ– |
| Single Image Edit | å–®åœ–ç·¨è¼¯ | åŸåœ– |

### åƒæ•¸è¨­å®š

| åƒæ•¸ | é¸é … | èªªæ˜ |
|------|------|------|
| Model | turbo_fp8 | ä½¿ç”¨çš„æ¨¡å‹ |
| Aspect Ratio | 1:1, 16:9, 9:16, 2:3 | è¼¸å‡ºæ¯”ä¾‹ |
| Seed | -1 (éš¨æ©Ÿ) æˆ–æŒ‡å®šæ•¸å­— | ç”Ÿæˆç¨®å­ |
| Batch Size | 1-4 | æ‰¹æ¬¡æ•¸é‡ |

---

## ğŸ“¡ API æ–‡æª”

### POST /api/generate

æäº¤ç”Ÿæˆä»»å‹™ã€‚

**Request:**
```json
{
    "workflow": "text_to_image",
    "prompt": "a beautiful sunset",
    "seed": -1,
    "model": "turbo_fp8",
    "aspect_ratio": "16:9",
    "batch_size": 1,
    "images": {
        "source": "data:image/png;base64,..."
    }
}
```

**Response (202):**
```json
{
    "job_id": "uuid...",
    "status": "queued"
}
```

### GET /api/status/{job_id}

æŸ¥è©¢ä»»å‹™ç‹€æ…‹ã€‚

**Response:**
```json
{
    "status": "finished",
    "progress": 100,
    "image_url": "/outputs/uuid.png"
}
```

### GET /api/history

ç²å–æ­·å²è¨˜éŒ„ï¼ˆæ–°åŠŸèƒ½ï¼ï¼‰

**Query Parameters:**
- `limit`: è¿”å›æ•¸é‡ï¼ˆé è¨­ 50ï¼Œæœ€å¤§ 100ï¼‰
- `offset`: åç§»é‡ï¼ˆé è¨­ 0ï¼Œç”¨æ–¼åˆ†é ï¼‰

**Response:**
```json
{
    "total": 120,
    "limit": 50,
    "offset": 0,
    "jobs": [
        {
            "id": "uuid",
            "prompt": "a cyberpunk cat",
            "workflow": "text_to_image",
            "model": "turbo_fp8",
            "aspect_ratio": "16:9",
            "batch_size": 1,
            "seed": 12345,
            "status": "finished",
            "output_path": "/outputs/abc.png,/outputs/def.png",
            "created_at": "2026-01-02T10:30:00",
            "updated_at": "2026-01-02T10:35:00"
        }
    ]
}
```

### GET /health

å¥åº·æª¢æŸ¥ï¼ˆå¼·åŒ–ç‰ˆï¼‰

**Response:**
```json
{
    "status": "ok",
    "redis": "healthy",
    "mysql": "healthy"
}
```

### GET /outputs/{filename}

ç²å–ç”Ÿæˆçš„åœ–ç‰‡æª”æ¡ˆã€‚

---

## ğŸ”§ ç¶­è­·æŒ‡å—

### æ—¥å¸¸ç¶­è­·æŒ‡ä»¤

```powershell
# æŸ¥çœ‹ Docker æœå‹™ç‹€æ…‹
docker-compose ps

# æŸ¥çœ‹ Redis ç‹€æ…‹èˆ‡è¨˜æ†¶é«”ä½¿ç”¨
docker exec studio-redis redis-cli -a mysecret info memory

# æ¸…é™¤æ‰€æœ‰ä»»å‹™ç‹€æ…‹ (æ…ç”¨ï¼)
docker exec studio-redis redis-cli -a mysecret FLUSHDB

# æŸ¥çœ‹ä½‡åˆ—é•·åº¦
docker exec studio-redis redis-cli -a mysecret LLEN studio_jobs

# å‚™ä»½ MySQL è³‡æ–™åº«
docker exec studio-mysql mysqldump -uroot -proot_password studio_db > backup_$(Get-Date -Format 'yyyyMMdd').sql

# æŸ¥çœ‹ç£ç¢Ÿç©ºé–“ä½¿ç”¨
Get-ChildItem storage\outputs -Recurse | Measure-Object -Property Length -Sum
Get-ChildItem logs -Recurse | Measure-Object -Property Length -Sum
```

### æ—¥èªŒç®¡ç†

**æ—¥èªŒè¼ªè½‰é…ç½®**:
- è‡ªå‹•è¼ªè½‰: å–®æª”é” 5MB æ™‚è‡ªå‹•å»ºç«‹æ–°æª”
- ä¿ç•™ç­–ç•¥: ä¿ç•™æœ€è¿‘ 3 ä»½å‚™ä»½ (ç¸½å…± 4 å€‹æª”æ¡ˆ)
- å‘½åæ ¼å¼: `backend.log`, `backend.log.1`, `backend.log.2`, `backend.log.3`

**æ‰‹å‹•æ¸…ç†èˆŠæ—¥èªŒ**:
```powershell
# åˆªé™¤è¶…é 7 å¤©çš„æ—¥èªŒå‚™ä»½
Get-ChildItem logs\*.log.* | Where-Object {$_.LastWriteTime -lt (Get-Date).AddDays(-7)} | Remove-Item

# å£“ç¸®èˆŠæ—¥èªŒ
Compress-Archive -Path logs\*.log.* -DestinationPath logs_archive_$(Get-Date -Format 'yyyyMMdd').zip
```

**æ—¥èªŒåˆ†æç¯„ä¾‹**:
```powershell
# çµ±è¨ˆæ¯å°æ™‚è«‹æ±‚é‡
Select-String -Path logs\backend.log -Pattern "GET|POST" | 
  ForEach-Object {$_.Line.Substring(0,13)} | 
  Group-Object | 
  Sort-Object Count -Descending

# æ‰¾å‡ºæœ€æ…¢çš„ API è«‹æ±‚
Select-String -Path logs\backend.log -Pattern "slow|timeout"

# çµ±è¨ˆä»»å‹™æˆåŠŸç‡
$total = (Select-String -Path logs\worker.log -Pattern "é–‹å§‹è™•ç†ä»»å‹™").Count
$success = (Select-String -Path logs\worker.log -Pattern "ä»»å‹™å®Œæˆ").Count
Write-Output "æˆåŠŸç‡: $($success/$total*100)%"
```

### æ¸…ç†æš«å­˜æª”æ¡ˆ

Worker æœƒè‡ªå‹•æ¸…ç†éæœŸæª”æ¡ˆï¼š
- **æš«å­˜åœ–ç‰‡** (`storage/inputs`): ä¿ç•™ 24 å°æ™‚
- **è¼¸å‡ºåœ–ç‰‡** (`storage/outputs`): ä¿ç•™ 30 å¤©
- **ComfyUI æš«å­˜** (`ComfyUI/input/upload_*`): ä¿ç•™ 1 å°æ™‚

**æ¸…ç†æ™‚æ©Ÿ**:
- Worker å•Ÿå‹•æ™‚åŸ·è¡Œä¸€æ¬¡
- ä¹‹å¾Œæ¯å°æ™‚è‡ªå‹•åŸ·è¡Œ

**æ‰‹å‹•æ¸…ç†**:
```powershell
# æ¸…ç† ComfyUI input æš«å­˜
Remove-Item "D:\02_software\ComfyUI_windows_portable\ComfyUI\input\upload_*.png" -Force

# æ¸…ç†è¼¸å‡ºç›®éŒ„ (æ…ç”¨ï¼æœƒåˆªé™¤æ‰€æœ‰åœ–ç‰‡)
Remove-Item "storage\outputs\*.png" -Force

# æ¸…ç†ç‰¹å®šæ—¥æœŸå‰çš„æª”æ¡ˆ
$cutoffDate = (Get-Date).AddDays(-30)
Get-ChildItem storage\outputs -File | 
  Where-Object {$_.LastWriteTime -lt $cutoffDate} | 
  Remove-Item -Force

# æŸ¥çœ‹æ¸…ç†çµ±è¨ˆ
$files = Get-ChildItem storage\outputs -File
Write-Output "ç¸½æª”æ¡ˆæ•¸: $($files.Count)"
Write-Output "ç¸½å¤§å°: $([math]::Round(($files | Measure-Object -Property Length -Sum).Sum / 1MB, 2)) MB"
```

### æœå‹™é‡å•Ÿ

```powershell
# é‡å•Ÿæ‰€æœ‰ Docker æœå‹™
docker-compose restart

# é‡å•Ÿç‰¹å®šæœå‹™
docker-compose restart redis
docker-compose restart mysql

# é‡å•Ÿ Backend (é–‹ç™¼æ¨¡å¼æœƒè‡ªå‹•ç†±é‡è¼‰)
# ä¿®æ”¹ app.py å¾Œæœƒè‡ªå‹•é‡å•Ÿï¼Œç„¡éœ€æ‰‹å‹•æ“ä½œ

# é‡å•Ÿ Worker (éœ€æ‰‹å‹•é‡å•Ÿ)
# Ctrl+C é—œé–‰ Worker çµ‚ç«¯
python worker/src/main.py

# é‡å•Ÿ ComfyUI
# é—œé–‰ ComfyUI è¦–çª—å¾Œé‡æ–°åŸ·è¡Œ
D:\02_software\ComfyUI_windows_portable\run_nvidia_gpu.bat

# æŸ¥çœ‹æœå‹™å•Ÿå‹•é †åº
# 1. ComfyUI (Port 8188)
# 2. Redis + MySQL (docker-compose up -d)
# 3. Backend (Port 5000)
# 4. Worker
# 5. Frontend (Live Server Port 5500)
```

### è³‡æ–™åº«ç¶­è­·

```powershell
# å„ªåŒ– MySQL è¡¨æ ¼
docker exec studio-mysql mysql -uroot -proot_password -e "OPTIMIZE TABLE studio_db.jobs;"

# é‡å»ºç´¢å¼•
docker exec studio-mysql mysql -uroot -proot_password -e "ANALYZE TABLE studio_db.jobs;"

# æŸ¥çœ‹è¡¨æ ¼å¤§å°
docker exec studio-mysql mysql -uroot -proot_password -e "
  SELECT 
    table_name AS 'Table',
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
  FROM information_schema.TABLES
  WHERE table_schema = 'studio_db';
"

# æ¸…ç†è»Ÿåˆªé™¤çš„è¨˜éŒ„ (æ°¸ä¹…åˆªé™¤è¶…é 90 å¤©çš„ä»»å‹™)
docker exec studio-mysql mysql -uroot -proot_password studio_db -e "
  DELETE FROM jobs 
  WHERE is_deleted = TRUE 
  AND updated_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
"
```

---

## â“ æ•…éšœæ’é™¤

### ERR_CONNECTION_REFUSED (å‰ç«¯ç„¡æ³•é€£æ¥ Backend)

**éŒ¯èª¤è¨Šæ¯**: `ERR_CONNECTION_REFUSED` æˆ– `Network Error`

**åŸå› **: Backend æœªå•Ÿå‹•æˆ–ç«¯å£è¢«å ç”¨

**è§£æ±ºæ–¹æ¡ˆ**:
```powershell
# 1. æª¢æŸ¥ Backend æ˜¯å¦é‹è¡Œ
netstat -ano | findstr :5000

# 2. å¦‚æœæ²’æœ‰è¼¸å‡ºï¼Œå•Ÿå‹• Backend
python backend/src/app.py

# 3. å¦‚æœç«¯å£è¢«å ç”¨ï¼Œæ‰¾å‡ºä¸¦é—œé–‰å ç”¨ç¨‹åº
$processId = (Get-NetTCPConnection -LocalPort 5000).OwningProcess
Stop-Process -Id $processId -Force

# 4. ç¢ºèª Backend å¥åº·ç‹€æ…‹
curl http://localhost:5000/health
```

---

### Redis é€£æ¥å¤±æ•—

**éŒ¯èª¤è¨Šæ¯**: `ConnectionError: Error connecting to Redis` æˆ– `Connection refused`

**åŸå› **: Redis å®¹å™¨æœªé‹è¡Œæˆ–å¯†ç¢¼éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**:
```powershell
# 1. æª¢æŸ¥ Redis å®¹å™¨ç‹€æ…‹
docker ps | findstr redis

# 2. å¦‚æœæœªé‹è¡Œï¼Œå•Ÿå‹• Redis
docker-compose up -d redis

# 3. æ¸¬è©¦ Redis é€£æ¥
docker exec studio-redis redis-cli -a mysecret ping
# æ‡‰è©²å›æ‡‰: PONG

# 4. æŸ¥çœ‹ Redis æ—¥èªŒ
docker logs studio-redis --tail 50

# 5. å¦‚æœä»ç„¶å¤±æ•—ï¼Œé‡å•Ÿ Redis
docker-compose restart redis
```

---

### MySQL é€£æ¥å¤±æ•—

**éŒ¯èª¤è¨Šæ¯**: `Can't connect to MySQL server` æˆ– `Access denied`

**åŸå› **: MySQL å®¹å™¨æœªå°±ç·’æˆ–æ†‘è­‰éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**:
```powershell
# 1. æª¢æŸ¥ MySQL å®¹å™¨ç‹€æ…‹
docker ps | findstr mysql

# 2. ç­‰å¾… MySQL åˆå§‹åŒ–å®Œæˆ (é¦–æ¬¡å•Ÿå‹•éœ€è¦ 30-60 ç§’)
docker logs studio-mysql --tail 50

# 3. æ¸¬è©¦ MySQL é€£æ¥
docker exec studio-mysql mysql -uroot -proot_password -e "SHOW DATABASES;"

# 4. æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦å­˜åœ¨
docker exec studio-mysql mysql -uroot -proot_password -e "USE studio_db; SHOW TABLES;"

# 5. å¦‚æœè¡¨æ ¼ä¸å­˜åœ¨ï¼ŒBackend æœƒåœ¨é¦–æ¬¡å•Ÿå‹•æ™‚è‡ªå‹•å»ºç«‹

# 6. å®Œå…¨é‡ç½®è³‡æ–™åº« (æ…ç”¨ï¼æœƒåˆªé™¤æ‰€æœ‰è³‡æ–™)
docker-compose down
Remove-Item -Recurse -Force mysql_data
docker-compose up -d
```

---

### ComfyUI é€£æ¥å¤±æ•—

**éŒ¯èª¤è¨Šæ¯**: Worker æ—¥èªŒé¡¯ç¤º `âŒ é€£æ¥ ComfyUI å¤±æ•—` æˆ– `Connection refused`

**åŸå› **: ComfyUI æœªå•Ÿå‹•ã€æœªé–‹å•Ÿ API æ¨¡å¼ã€æˆ–ç«¯å£éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**:
```powershell
# 1. ç¢ºèª ComfyUI æ­£åœ¨é‹è¡Œ
netstat -ano | findstr :8188

# 2. æ¸¬è©¦ ComfyUI API
curl http://127.0.0.1:8188/system_stats

# 3. ç¢ºèª ComfyUI å•Ÿå‹•åƒæ•¸åŒ…å« API æ¨¡å¼
# æª¢æŸ¥å•Ÿå‹•è…³æœ¬: run_nvidia_gpu.bat
# æ‡‰è©²åŒ…å«: --listen --enable-cors-header *

# 4. å¦‚æœä½¿ç”¨ Dockerï¼Œç¢ºèªç¶²è·¯è¨­å®š
# Worker æ‡‰è©²ä½¿ç”¨ host.docker.internal:8188 é€£æ¥å®¿ä¸»æ©Ÿçš„ ComfyUI

# 5. ä½¿ç”¨è¨ºæ–·å·¥å…·æ¸¬è©¦é€£æ¥
python worker/src/check_comfy_connection.py
```

---

### Gallery åœ–ç‰‡ç„¡æ³•é¡¯ç¤º

**éŒ¯èª¤è¨Šæ¯**: Gallery é¡¯ç¤ºç©ºç™½æˆ– 404 éŒ¯èª¤

**åŸå› **: åœ–ç‰‡è·¯å¾‘æ ¼å¼éŒ¯èª¤æˆ–æª”æ¡ˆä¸å­˜åœ¨

**è§£æ±ºæ–¹æ¡ˆ**:
```powershell
# 1. æª¢æŸ¥ Backend API å›å‚³çš„è·¯å¾‘æ ¼å¼
curl http://localhost:5000/api/history?limit=5

# output_path æ‡‰è©²æ˜¯: "/outputs/filename.png"

# 2. ç¢ºèªåœ–ç‰‡æª”æ¡ˆå­˜åœ¨
Get-ChildItem storage\outputs

# 3. æ¸¬è©¦ç›´æ¥å­˜å–åœ–ç‰‡
curl http://localhost:5000/outputs/filename.png

# 4. æª¢æŸ¥å‰ç«¯ API_BASE é…ç½®
# é–‹å•Ÿ frontend/index.html
# ç¢ºèª: const API_BASE = 'http://localhost:5000';

# 5. æŸ¥çœ‹ç€è¦½å™¨ Console çš„éŒ¯èª¤è¨Šæ¯ (F12)
```

---

### é é¢åˆ·æ–°è·³å› Dashboard

**åŸå› **: VS Code Live Server ç›£è½åˆ°æª”æ¡ˆè®Šå‹•è‡ªå‹•é‡è¼‰

**è§£æ±ºæ–¹æ¡ˆ**:
```json
// .vscode/settings.json å·²é…ç½®å¿½ç•¥è¦å‰‡
{
  "liveServer.settings.ignoreFiles": [
    "**/.git/**",
    "**/.vscode/**",
    "**/node_modules/**",
    "**/storage/**",
    "**/logs/**",
    "**/mysql_data/**",
    "**/redis_data/**"
  ]
}
```

å¦‚æœä»ç„¶ç™¼ç”Ÿï¼š
```powershell
# é‡å•Ÿ Live Server
# VS Code: Ctrl+Shift+P â†’ "Live Server: Stop" â†’ "Live Server: Open with Live Server"
```

---

### ä»»å‹™å¡åœ¨ Processing ç‹€æ…‹

**åŸå› **: Worker å´©æ½°ã€ComfyUI éŒ¯èª¤ã€æˆ– WebSocket é€£æ¥ä¸­æ–·

**è§£æ±ºæ–¹æ¡ˆ**:
```powershell
# 1. æŸ¥çœ‹ Worker æ—¥èªŒ
Get-Content logs\worker.log -Tail 100

# 2. æŸ¥çœ‹ Redis ä»»å‹™ç‹€æ…‹
docker exec studio-redis redis-cli -a mysecret HGETALL job:status:{job_id}

# 3. æª¢æŸ¥ ComfyUI æ˜¯å¦æœ‰éŒ¯èª¤
# æŸ¥çœ‹ ComfyUI è¦–çª—çš„ Terminal è¼¸å‡º

# 4. æ‰‹å‹•å–æ¶ˆä»»å‹™
curl -X POST http://localhost:5000/api/cancel/{job_id}

# 5. æ¸…ç©ºä½‡åˆ—é‡æ–°é–‹å§‹
docker exec studio-redis redis-cli -a mysecret DEL studio_jobs
docker exec studio-redis redis-cli -a mysecret KEYS "job:status:*" | 
  ForEach-Object {docker exec studio-redis redis-cli -a mysecret DEL $_}

# 6. é‡å•Ÿ Worker
# Ctrl+C åœæ­¢ Worker
python worker/src/main.py
```

---

### åœ–ç‰‡æœªæ­£ç¢ºæ³¨å…¥åˆ° Workflow

**éŒ¯èª¤è¨Šæ¯**: ComfyUI éŒ¯èª¤ `Node XXX: required input is missing`

**åŸå› **: Workflow JSON çš„ IMAGE ç¯€é» ID èˆ‡ `json_parser.py` çš„æ˜ å°„ä¸åŒ¹é…

**è§£æ±ºæ–¹æ¡ˆ**:
```powershell
# 1. ç¢ºèªå‰ç«¯ toolConfig ä¸­çš„ uploads.id
# é–‹å•Ÿ frontend/index.htmlï¼Œæœå°‹å°æ‡‰çš„å·¥ä½œæµé…ç½®

# 2. ç¢ºèª Worker çš„ IMAGE_NODE_MAP
# é–‹å•Ÿ worker/src/json_parser.pyï¼ŒæŸ¥çœ‹æ˜ å°„è¡¨:
# IMAGE_NODE_MAP = {
#     "face_swap": {"source": "11", "target": "10"},
#     ...
# }

# 3. æª¢æŸ¥ Workflow JSON æª”æ¡ˆ
# é–‹å•Ÿ ComfyUIworkflow/face_swap_*.json
# æ‰¾åˆ° LoadImage ç¯€é»çš„ IDï¼Œç¢ºèªæ˜¯å¦åŒ¹é…

# 4. æŸ¥çœ‹ Worker æ—¥èªŒçš„åœ–ç‰‡è™•ç†è¨˜éŒ„
Select-String -Path logs\worker.log -Pattern "è™•ç†äº†.*å¼µè¼¸å…¥åœ–ç‰‡"

# 5. æ¸¬è©¦æ™‚æ·»åŠ  Debug è¼¸å‡º
# åœ¨ json_parser.py çš„ parse_workflow() å‡½æ•¸ä¸­æ·»åŠ :
# logger.info(f"æ³¨å…¥åœ–ç‰‡: {node_id} -> {filename}")
```

---

### æ•ˆèƒ½å•é¡Œï¼šç”Ÿæˆé€Ÿåº¦ç·©æ…¢

**åŸå› **: GPU è³‡æºä¸è¶³ã€æ¨¡å‹è¼‰å…¥æ…¢ã€æˆ–å¤šä»»å‹™ä¸¦è¡Œ

**è§£æ±ºæ–¹æ¡ˆ**:
```powershell
# 1. æª¢æŸ¥ GPU ä½¿ç”¨ç‡
nvidia-smi

# 2. ç¢ºèª ComfyUI ä½¿ç”¨æ­£ç¢ºçš„ GPU
# å•Ÿå‹•è…³æœ¬æ‡‰è©²ä½¿ç”¨ run_nvidia_gpu.bat è€Œé CPU ç‰ˆæœ¬

# 3. é™åˆ¶ä½µç™¼ä»»å‹™æ•¸é‡
# åªé‹è¡Œä¸€å€‹ Worker å¯¦ä¾‹ï¼Œé¿å…å¤šä»»å‹™ç«¶çˆ­ GPU

# 4. å„ªåŒ–æ¨¡å‹é¸æ“‡
# ä½¿ç”¨ FP8 é‡åŒ–æ¨¡å‹ (z-image-turbo-fp8) è€Œéå®Œæ•´ç²¾åº¦æ¨¡å‹

# 5. æ¸…ç† ComfyUI æ¨¡å‹å¿«å–
# é‡å•Ÿ ComfyUI ä»¥é‡‹æ”¾ VRAM
```

---

### Docker ç£ç¢Ÿç©ºé–“ä¸è¶³

**éŒ¯èª¤è¨Šæ¯**: `no space left on device`

**è§£æ±ºæ–¹æ¡ˆ**:
```powershell
# 1. æŸ¥çœ‹ Docker ç£ç¢Ÿä½¿ç”¨
docker system df

# 2. æ¸…ç†æœªä½¿ç”¨çš„æ˜ åƒ
docker image prune -a

# 3. æ¸…ç†æœªä½¿ç”¨çš„å®¹å™¨
docker container prune

# 4. æ¸…ç†æœªä½¿ç”¨çš„å·
docker volume prune

# 5. å®Œæ•´æ¸…ç† (æ…ç”¨ï¼)
docker system prune -a --volumes

# 6. æ¸…ç†å°ˆæ¡ˆè¼¸å‡ºåœ–ç‰‡
Remove-Item storage\outputs\* -Force

# 7. æ¸…ç†èˆŠæ—¥èªŒ
Remove-Item logs\*.log.* -Force
```

---

## ğŸ“ ç‰ˆæœ¬è¨˜éŒ„

### Phase 4 - Stability & Connectivity (2026-01-05) âœ… å·²å®Œæˆ

- âœ… **å®Œæ•´æ—¥èªŒç³»çµ±**: Backend + Worker RotatingFileHandler (5MB Ã— 3 backups)
- âœ… **Gallery åœ–ç‰‡ä¿®å¾©**: è¼¸å‡ºè·¯å¾‘æ ¼å¼åŒ–èˆ‡å‰ç«¯ URL æ§‹å»ºå„ªåŒ–
- âœ… **çµæ§‹åŒ–æ—¥èªŒ**: æ‰€æœ‰ print() æ›¿æ›ç‚º logger.info/warning/error()
- âœ… **æ—¥èªŒåŸºç¤è¨­æ–½**: logs/ ç›®éŒ„å»ºç«‹èˆ‡ Docker volume æ›è¼‰
- âœ… **HTTP è«‹æ±‚æ—¥èªŒ**: è¨˜éŒ„æ‰€æœ‰ API è«‹æ±‚çš„ Method, Path, Status
- âœ… **ä»»å‹™ç”Ÿå‘½é€±æœŸæ—¥èªŒ**: é–‹å§‹ã€é€²åº¦ã€å®Œæˆã€å¤±æ•—çš„å®Œæ•´è¨˜éŒ„
- âœ… **ä»£ç¢¼å“è³ªæå‡**: çµ±ä¸€æ—¥èªŒæ ¼å¼èˆ‡éŒ¯èª¤è™•ç†æµç¨‹

**æ—¥èªŒç³»çµ±åŠŸèƒ½**:
- è‡ªå‹•è¼ªè½‰ç®¡ç† (å–®æª” 5MB ä¸Šé™)
- ä¿ç•™æœ€è¿‘ 3 ä»½å‚™ä»½
- UTF-8 ç·¨ç¢¼æ”¯æ´ä¸­æ–‡
- æ™‚é–“æˆ³ + æ¨¡çµ„åç¨± + ç´šåˆ¥ + è¨Šæ¯æ ¼å¼
- æ”¯æ´ Stack Trace è¨˜éŒ„

**Gallery å„ªåŒ–**:
- Backend API è‡ªå‹•æå–æª”åä¸¦æ ¼å¼åŒ–ç‚º `/outputs/filename.png`
- Frontend æ­£ç¢ºæ§‹å»ºå®Œæ•´ URL (`API_BASE + output_path`)
- æ·»åŠ  `loading="lazy"` åœ–ç‰‡å»¶é²è¼‰å…¥
- æ”¹å–„éŒ¯èª¤è™•ç†èˆ‡ fallback æ©Ÿåˆ¶

---

### Phase 3 - Data & Intelligence (2026-01-02) âœ… å·²å®Œæˆ

- âœ… **MySQL æŒä¹…åŒ–**: Jobs è¡¨è¨­è¨ˆèˆ‡é€£æ¥æ± æ•´åˆ
- âœ… **æ­·å²è¨˜éŒ„ API**: `GET /api/history` æ”¯æ´åˆ†é  (limit/offset)
- âœ… **Personal Gallery**: éŸ¿æ‡‰å¼ç¶²æ ¼ä½ˆå±€èˆ‡ç‹€æ…‹é¡è‰²ç·¨ç¢¼
- âœ… **Remix åŠŸèƒ½**: é»æ“Šæ­·å²è¨˜éŒ„é‡æ–°ä½¿ç”¨åƒæ•¸
- âœ… **è³‡æ–™åº«åŒæ­¥æ¸…ç†**: è»Ÿåˆªé™¤æ©Ÿåˆ¶ (is_deleted) ä¿ç•™æ­·å²
- âœ… **éŒ¯èª¤é‡è©¦**: ComfyUI é€£æ¥å¤±æ•—è‡ªå‹•é‡è©¦ 1 æ¬¡ (5ç§’å»¶é²)
- âœ… **Docker å„ªåŒ–**: MySQL æ•´åˆèˆ‡ Backend Healthcheck
- âœ… **å¥åº·æª¢æŸ¥**: ç›£æ§ Redis + MySQL é€£æ¥ç‹€æ…‹

**è³‡æ–™åº«æ¶æ§‹**:
```sql
CREATE TABLE jobs (
    id VARCHAR(36) PRIMARY KEY,
    prompt TEXT,
    workflow VARCHAR(50),
    model VARCHAR(100),
    aspect_ratio VARCHAR(10),
    batch_size INT DEFAULT 1,
    seed INT DEFAULT -1,
    status VARCHAR(20),
    output_path TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP ON UPDATE NOW(),
    is_deleted BOOLEAN DEFAULT FALSE
);
```

---

### Phase 2 - Maturity (2024-12-31) âœ… å·²å®Œæˆ

- âœ… **å³æ™‚é€²åº¦æ¢**: WebSocket ç›£è½ ComfyUI åŸ·è¡Œé€²åº¦ (0-100%)
- âœ… **å‹•æ…‹æ¨¡å‹åˆ—è¡¨**: æƒæ ComfyUI æ¨¡å‹ç›®éŒ„ (checkpoints + unet)
- âœ… **ä»»å‹™å–æ¶ˆ**: `POST /api/cancel/{job_id}` + ComfyUI interrupt
- âœ… **æ‰¹æ¬¡ç”Ÿæˆ**: æ”¯æ´ 1-4 å¼µåœ–ç‰‡æ‰¹æ¬¡è¼¸å‡º
- âœ… **Docker å®¹å™¨åŒ–**: Backend + Worker + Redis å®Œæ•´ç·¨æ’
- âœ… **è‡ªå‹•æ¸…ç†**: æš«å­˜æª”æ¡ˆ 24hï¼Œè¼¸å‡ºåœ–ç‰‡ 30å¤©
- âœ… **æ™ºèƒ½è¼¸å‡ºé¸æ“‡**: å„ªå…ˆé¸æ“‡å¸¶ subfolder çš„æ­£å¼è¼¸å‡º

---

### Phase 1 - MVP (2024-12-31) âœ… å·²å®Œæˆ

- âœ… **åŸºç¤æ¶æ§‹**: Docker Redis, Flask API, Worker ä¸»è¿´åœˆ
- âœ… **é€šè¨Šæ¨¡çµ„**: ComfyUI HTTP + WebSocket å®¢æˆ¶ç«¯
- âœ… **å‰ç«¯ä»‹é¢**: Pro Workstation Layout (Dashboard, Canvas, Gallery, Settings)
- âœ… **å·¥ä½œæµæ”¯æ´**: Text-to-Image, Face Swap, Multi-Blend, Sketch, Single Edit
- âœ… **ä¸€éµå•Ÿå‹•**: start_all.bat è…³æœ¬

---

## ğŸ”® æœªä¾†å±•æœ› (Roadmap)

### Phase 5 - External Access & Production (é€²è¡Œä¸­)

#### å„ªå…ˆç´š 1: å¤–éƒ¨å­˜å– â­ å·²å®Œæˆ
- [x] **Ngrok æ•´åˆ**: é…ç½®å…¬ç¶²å­˜å– (`ngrok http 5000`)
  - âœ… è‡ªå‹•å•Ÿå‹•è…³æœ¬ `start_ngrok.bat`
  - âœ… è‡ªå‹•é…ç½®æ›´æ–° `update_ngrok_config.ps1`
  - âœ… å‹•æ…‹ API é…ç½® `frontend/config.js`
  - âœ… æ•´åˆåˆ° `startweb.bat`
  - âœ… æ¸¬è©¦å·¥å…· `test_ngrok_config.bat`
  - âœ… å®Œæ•´æ–‡æª” [NGROK_SETUP.md](NGROK_SETUP.md)
- [ ] **è¡Œå‹•ç«¯æ¸¬è©¦**: é©—è­‰æ‰‹æ©Ÿç€è¦½å™¨ç›¸å®¹æ€§
- [ ] **HTTPS æ”¯æ´**: Nginx åå‘ä»£ç† + Let's Encrypt æ†‘è­‰
- [ ] **åŸŸåç¶å®š**: è‡ªè¨‚åŸŸåè¨­å®š

**Ngrok å¿«é€Ÿå•Ÿå‹•**:
```powershell
# 1. å•Ÿå‹•æ‰€æœ‰å¾Œç«¯æœå‹™ (Docker + Backend + Worker)
.\start_all_with_docker.bat

# 2. å•Ÿå‹• Ngrok ä¸¦è‡ªå‹•é…ç½®
.\start_ngrok.bat

# 3. å•Ÿå‹• Web ä¼ºæœå™¨ï¼ˆæˆ–ç›´æ¥åŸ·è¡Œ startweb.bat é¸æ“‡æ¨¡å¼ 2ï¼‰
.\startweb.bat
```

#### å„ªå…ˆç´š 2: æ•ˆèƒ½å„ªåŒ–
- [ ] **Redis é€£æ¥æ± **: å„ªåŒ– Backend èˆ‡ Worker çš„ Redis é€£ç·š
- [ ] **MySQL ç´¢å¼•å„ªåŒ–**: æ·»åŠ è¤‡åˆç´¢å¼•æå‡æŸ¥è©¢æ•ˆèƒ½
- [ ] **åœ–ç‰‡å£“ç¸®**: è‡ªå‹•å£“ç¸®è¼¸å‡ºåœ–ç‰‡ä¸¦ç”Ÿæˆç¸®åœ–
- [ ] **CDN æ•´åˆ**: åœ–ç‰‡åŠ é€Ÿèˆ‡åˆ†æ•£å¼å­˜å„²
- [ ] **çµæœå¿«å–**: ç›¸åŒåƒæ•¸ç›´æ¥è¿”å›å¿«å–çµæœ

#### å„ªå…ˆç´š 3: ç”¨æˆ¶é«”é©—å¢å¼·
- [ ] **æ”¶è—åŠŸèƒ½**: æ¨™è¨˜å–œæ„›çš„ä½œå“ä¸¦åˆ†é¡ç®¡ç†
- [ ] **Prompt æ¨¡æ¿åº«**: é è¨­é¢¨æ ¼æ¨¡æ¿å¿«é€Ÿæ‡‰ç”¨
- [ ] **æ‰¹æ¬¡ä¸‹è¼‰**: æ‰“åŒ…ä¸‹è¼‰å¤šå¼µåœ–ç‰‡ç‚º ZIP
- [ ] **åˆ†äº«é€£çµ**: ç”Ÿæˆå…¬é–‹åˆ†äº«é€£çµï¼ˆå¸¶éæœŸæ™‚é–“ï¼‰
- [ ] **Gallery åˆ†é **: Infinite Scroll æˆ–é ç¢¼å°èˆª

---

### Phase 6 - Advanced Features (è¦åŠƒä¸­)

#### å„ªå…ˆç´š 1: å·¥ä½œæµæ“´å±•
- [ ] **Image to Video**: æ•´åˆ Kling / Veo3 API
- [ ] **Super Resolution**: åœ–ç‰‡æ”¾å¤§ï¼ˆ4x, 8xï¼‰
- [ ] **Style Transfer**: é¢¨æ ¼é·ç§»å·¥å…·
- [ ] **Background Removal**: èƒŒæ™¯å»é™¤èˆ‡æ›¿æ›
- [ ] **Inpainting**: åœ–ç‰‡å±€éƒ¨ä¿®å¾©èˆ‡ç·¨è¼¯

#### å„ªå…ˆç´š 2: ä¼æ¥­ç´šåŠŸèƒ½
- [ ] **å¤šç”¨æˆ¶ç³»çµ±**: ç”¨æˆ¶è¨»å†Šã€ç™»å…¥ã€æ¬Šé™ç®¡ç†
- [ ] **API Key èªè­‰**: Token-based èªè­‰æ©Ÿåˆ¶
- [ ] **ä½¿ç”¨é‡çµ±è¨ˆ**: Dashboard ç›£æ§èˆ‡å ±è¡¨
- [ ] **Webhook é€šçŸ¥**: ä»»å‹™å®Œæˆå›èª¿ (Slack, Discord, Email)
- [ ] **ä»»å‹™å„ªå…ˆç´š**: VIP ç”¨æˆ¶å„ªå…ˆè™•ç†ä½‡åˆ—

#### å„ªå…ˆç´š 3: éƒ¨ç½²æ“´å±•
- [ ] **Kubernetes éƒ¨ç½²**: é«˜å¯ç”¨æ€§é›†ç¾¤èˆ‡è‡ªå‹•æ“´å±•
- [ ] **S3 å­˜å„²**: AWS S3 / MinIO é›²ç«¯åœ–ç‰‡å­˜å„²
- [ ] **ç›£æ§å‘Šè­¦**: Prometheus + Grafana æ•´åˆ
- [ ] **æ—¥èªŒèšåˆ**: ELK Stack (Elasticsearch, Logstash, Kibana)
- [ ] **ä½µç™¼æ§åˆ¶**: æ™ºèƒ½ä»»å‹™èª¿åº¦èˆ‡è³‡æºé™åˆ¶

---

## ï¿½ ç›¸é—œæ–‡æª”

| æ–‡æª” | èªªæ˜ |
|------|------|
| [UpdateList.md](UpdateList.md) | è©³ç´°è®Šæ›´è¨˜éŒ„èˆ‡æ›´æ–°æ—¥èªŒ |
| [STARTUP_GUIDE.md](STARTUP_GUIDE.md) | å¿«é€Ÿå•Ÿå‹•æŒ‡å—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰|
| [backend/Readmd/API_TESTING.md](backend/Readmd/API_TESTING.md) | API æ¸¬è©¦æ–‡æª” |
| [openspec/project.md](openspec/project.md) | å°ˆæ¡ˆè¦æ ¼èªªæ˜ |
| [openspec/AGENTS.md](openspec/AGENTS.md) | AI Agent é–‹ç™¼æŒ‡ä»¤ |

---

## ğŸ¤ è²¢ç»æŒ‡å—

### é–‹ç™¼å·¥ä½œæµ

1. **Fork å°ˆæ¡ˆ** ä¸¦å»ºç«‹åŠŸèƒ½åˆ†æ”¯
   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **é–‹ç™¼èˆ‡æ¸¬è©¦**
   - éµå¾ªç¾æœ‰ä»£ç¢¼é¢¨æ ¼
   - æ·»åŠ å¿…è¦çš„æ—¥èªŒè¨˜éŒ„
   - ç¢ºä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸é‹ä½œ

3. **æäº¤è®Šæ›´**
   ```bash
   git commit -m "feat: add new feature description"
   ```

4. **æ¨é€ä¸¦å»ºç«‹ Pull Request**
   ```bash
   git push origin feature/your-feature-name
   ```

### Commit è¨Šæ¯è¦ç¯„

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type é¡å‹**:
- `feat`: æ–°åŠŸèƒ½
- `fix`: Bug ä¿®å¾©
- `docs`: æ–‡æª”æ›´æ–°
- `style`: ä»£ç¢¼æ ¼å¼èª¿æ•´
- `refactor`: ä»£ç¢¼é‡æ§‹
- `test`: æ¸¬è©¦ç›¸é—œ
- `chore`: å»ºç½®å·¥å…·æˆ–è¼”åŠ©å·¥å…·è®Šæ›´

**ç¯„ä¾‹**:
```
feat(worker): add automatic retry mechanism for ComfyUI connection

- Retry up to 3 times with 5 second delay
- Log each retry attempt
- Update task status to failed after all retries exhausted

Closes #123
```

---

## ğŸ” å®‰å…¨å»ºè­°

### ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²

1. **ä¿®æ”¹é è¨­å¯†ç¢¼**
   ```ini
   # .env
   REDIS_PASSWORD=your_secure_password_here
   DB_PASSWORD=your_database_password_here
   ```

2. **å•Ÿç”¨é˜²ç«ç‰†è¦å‰‡**
   ```powershell
   # åªå…è¨±æœ¬åœ°å­˜å– Redis
   New-NetFirewallRule -DisplayName "Redis Local Only" -Direction Inbound -LocalPort 6379 -Protocol TCP -Action Block
   
   # åªå…è¨±æœ¬åœ°å­˜å– MySQL
   New-NetFirewallRule -DisplayName "MySQL Local Only" -Direction Inbound -LocalPort 3306 -Protocol TCP -Action Block
   ```

3. **ä½¿ç”¨ HTTPS**
   - é…ç½® Nginx åå‘ä»£ç†
   - ä½¿ç”¨ Let's Encrypt å…è²»æ†‘è­‰
   - å¼·åˆ¶ HTTPS é‡å®šå‘

4. **é™åˆ¶ API å­˜å–**
   - å¯¦ä½œ Rate Limiting (Flask-Limiter)
   - æ·»åŠ  API Key èªè­‰
   - è¨˜éŒ„æ‰€æœ‰ API è«‹æ±‚æ—¥èªŒ

5. **å®šæœŸå‚™ä»½**
   ```powershell
   # è‡ªå‹•å‚™ä»½è…³æœ¬
   $date = Get-Date -Format "yyyyMMdd_HHmmss"
   docker exec studio-mysql mysqldump -uroot -proot_password studio_db > "backups/db_$date.sql"
   Compress-Archive -Path storage\outputs -DestinationPath "backups/outputs_$date.zip"
   ```

---

## ğŸ“ è¯çµ¡èˆ‡æ”¯æ´

### å¸¸è¦‹å•é¡Œ

- **Q: å¦‚ä½•æ›´æ› ComfyUI æ¨¡å‹ï¼Ÿ**
  - A: å°‡æ¨¡å‹æ”¾å…¥ `ComfyUI/models/checkpoints/` æˆ– `ComfyUI/models/unet/`ï¼Œé‡å•Ÿ Backend å¾Œæœƒè‡ªå‹•æƒæ

- **Q: å¯ä»¥åŒæ™‚é‹è¡Œå¤šå€‹ Worker å—ï¼Ÿ**
  - A: å¯ä»¥ï¼Œä½†éœ€è¦ç¢ºä¿ GPU è³‡æºè¶³å¤ ï¼Œå¦å‰‡æœƒé™ä½è™•ç†é€Ÿåº¦

- **Q: å¦‚ä½•é·ç§»åˆ°å…¶ä»–ä¼ºæœå™¨ï¼Ÿ**
  - A: å‚™ä»½ `mysql_data/`, `storage/outputs/`, `.env` æª”æ¡ˆï¼Œåœ¨æ–°ä¼ºæœå™¨ä¸ŠåŸ·è¡Œ `docker-compose up -d`

- **Q: æ”¯æ´ AMD GPU å—ï¼Ÿ**
  - A: éœ€è¦ä¿®æ”¹ ComfyUI å•Ÿå‹•è…³æœ¬ä½¿ç”¨ ROCm ç‰ˆæœ¬ï¼Œå…¶ä»–éƒ¨åˆ†ç„¡éœ€ä¿®æ”¹

### æŠ€è¡“æ”¯æ´

- **GitHub Issues**: å›å ± Bug æˆ–åŠŸèƒ½è«‹æ±‚
- **æ–‡æª”æ›´æ–°**: æäº¤ Pull Request æ”¹é€²æ–‡æª”
- **ç¤¾ç¾¤è¨è«–**: (å¦‚æœ‰ Discord/Slack é »é“è«‹è£œå……é€£çµ)

---

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™ (åƒè€ƒ)

### æ¸¬è©¦ç’°å¢ƒ
- **GPU**: RTX 3060 12GB
- **CPU**: Intel i7-12700
- **RAM**: 32GB DDR4
- **Storage**: NVMe SSD

### ç”Ÿæˆé€Ÿåº¦
| å·¥ä½œæµ | è§£æåº¦ | å¹³å‡æ™‚é–“ | Batch Size |
|--------|--------|---------|-----------|
| Text to Image | 1024Ã—1024 | 8-12ç§’ | 1 |
| Text to Image | 1024Ã—1024 | 15-20ç§’ | 4 |
| Face Swap | 1024Ã—1024 | 10-15ç§’ | 1 |
| Multi-Blend | 1024Ã—1024 | 12-18ç§’ | 1 |

### ç³»çµ±è³‡æºä½¿ç”¨
| æœå‹™ | CPU | è¨˜æ†¶é«” | å‚™è¨» |
|------|-----|--------|------|
| Backend | ~5% | ~100MB | Flask + Gunicorn |
| Worker | ~10% | ~200MB | å¾…æ©Ÿç‹€æ…‹ |
| Worker | ~15% | ~500MB | è™•ç†ä»»å‹™æ™‚ |
| Redis | ~2% | ~50MB | è¼•é‡ç´šå¿«å– |
| MySQL | ~3% | ~150MB | æŒä¹…åŒ–å„²å­˜ |
| ComfyUI | ~80% | ~8GB | GPU è™•ç†ä¸­ |

---

## ğŸ“„ æˆæ¬Š

MIT License

Copyright (c) 2026 ComfyUI Studio

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

---

<div align="center">

**â­ å¦‚æœé€™å€‹å°ˆæ¡ˆå°ä½ æœ‰å¹«åŠ©ï¼Œè«‹çµ¦æˆ‘å€‘ä¸€é¡†æ˜Ÿæ˜Ÿï¼**

Made with â¤ï¸ by ComfyUI Studio Team

</div>
